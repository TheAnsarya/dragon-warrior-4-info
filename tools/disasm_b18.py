#!/usr/bin/env python3
"""Disassemble Bank 18 party initialization code."""

rom_path = '../roms/Dragon Warrior IV (1992-10)(Enix)(US).nes'
with open(rom_path, 'rb') as f:
    rom = f.read()

# Disassemble from after the JMP to the end of routine
start = 0x48F12
end = 0x490F0

print('Bank 18 Chapter/Party Init Code:')
print('================================')
print()

idx = 0
data = rom[start+16:end+16]

oplen = {
    0x00:1,0x01:2,0x05:2,0x06:2,0x08:1,0x09:2,0x0A:1,0x0D:3,0x0E:3,0x10:2,
    0x11:2,0x15:2,0x16:2,0x18:1,0x19:3,0x1D:3,0x20:3,0x21:2,0x24:2,0x25:2,
    0x26:2,0x28:1,0x29:2,0x2A:1,0x2C:3,0x2D:3,0x2E:3,0x30:2,0x31:2,0x35:2,
    0x36:2,0x38:1,0x39:3,0x3D:3,0x40:1,0x41:2,0x45:2,0x46:2,0x48:1,0x49:2,
    0x4A:1,0x4C:3,0x4D:3,0x4E:3,0x50:2,0x51:2,0x55:2,0x56:2,0x58:1,0x59:3,
    0x5D:3,0x60:1,0x61:2,0x65:2,0x66:2,0x68:1,0x69:2,0x6A:1,0x6C:3,0x6D:3,
    0x6E:3,0x70:2,0x71:2,0x75:2,0x76:2,0x78:1,0x79:3,0x7D:3,0x81:2,0x84:2,
    0x85:2,0x86:2,0x88:1,0x8A:1,0x8C:3,0x8D:3,0x8E:3,0x90:2,0x91:2,0x94:2,
    0x95:2,0x96:2,0x98:1,0x99:3,0x9A:1,0x9D:3,0xA0:2,0xA1:2,0xA2:2,0xA4:2,
    0xA5:2,0xA6:2,0xA8:1,0xA9:2,0xAA:1,0xAC:3,0xAD:3,0xAE:3,0xB0:2,0xB1:2,
    0xB4:2,0xB5:2,0xB6:2,0xB8:1,0xB9:3,0xBD:3,0xBE:3,0xC0:2,0xC1:2,0xC4:2,
    0xC5:2,0xC6:2,0xC8:1,0xC9:2,0xCA:1,0xCC:3,0xCD:3,0xCE:3,0xD0:2,0xD1:2,
    0xD5:2,0xD6:2,0xD8:1,0xD9:3,0xDD:3,0xDE:3,0xE0:2,0xE1:2,0xE4:2,0xE5:2,
    0xE6:2,0xE8:1,0xE9:2,0xEA:1,0xEC:3,0xED:3,0xEE:3,0xF0:2,0xF1:2,0xF5:2,
    0xF6:2,0xF8:1,0xF9:3,0xFD:3,0xFE:3
}

opcodes = {
    0x00:'BRK',0x01:'ORA (zp,X)',0x05:'ORA zp',0x06:'ASL zp',0x08:'PHP',
    0x09:'ORA #',0x0A:'ASL A',0x0D:'ORA abs',0x0E:'ASL abs',0x10:'BPL',
    0x11:'ORA (zp),Y',0x15:'ORA zp,X',0x16:'ASL zp,X',0x18:'CLC',
    0x19:'ORA abs,Y',0x1D:'ORA abs,X',0x20:'JSR',0x21:'AND (zp,X)',
    0x24:'BIT zp',0x25:'AND zp',0x26:'ROL zp',0x28:'PLP',0x29:'AND #',
    0x2A:'ROL A',0x2C:'BIT abs',0x2D:'AND abs',0x2E:'ROL abs',0x30:'BMI',
    0x31:'AND (zp),Y',0x35:'AND zp,X',0x36:'ROL zp,X',0x38:'SEC',
    0x39:'AND abs,Y',0x3D:'AND abs,X',0x40:'RTI',0x41:'EOR (zp,X)',
    0x45:'EOR zp',0x46:'LSR zp',0x48:'PHA',0x49:'EOR #',0x4A:'LSR A',
    0x4C:'JMP abs',0x4D:'EOR abs',0x4E:'LSR abs',0x50:'BVC',
    0x51:'EOR (zp),Y',0x55:'EOR zp,X',0x56:'LSR zp,X',0x58:'CLI',
    0x59:'EOR abs,Y',0x5D:'EOR abs,X',0x60:'RTS',0x61:'ADC (zp,X)',
    0x65:'ADC zp',0x66:'ROR zp',0x68:'PLA',0x69:'ADC #',0x6A:'ROR A',
    0x6C:'JMP (abs)',0x6D:'ADC abs',0x6E:'ROR abs',0x70:'BVS',
    0x71:'ADC (zp),Y',0x75:'ADC zp,X',0x76:'ROR zp,X',0x78:'SEI',
    0x79:'ADC abs,Y',0x7D:'ADC abs,X',0x81:'STA (zp,X)',0x84:'STY zp',
    0x85:'STA zp',0x86:'STX zp',0x88:'DEY',0x8A:'TXA',0x8C:'STY abs',
    0x8D:'STA abs',0x8E:'STX abs',0x90:'BCC',0x91:'STA (zp),Y',
    0x94:'STY zp,X',0x95:'STA zp,X',0x96:'STX zp,Y',0x98:'TYA',
    0x99:'STA abs,Y',0x9A:'TXS',0x9D:'STA abs,X',0xA0:'LDY #',
    0xA1:'LDA (zp,X)',0xA2:'LDX #',0xA4:'LDY zp',0xA5:'LDA zp',
    0xA6:'LDX zp',0xA8:'TAY',0xA9:'LDA #',0xAA:'TAX',0xAC:'LDY abs',
    0xAD:'LDA abs',0xAE:'LDX abs',0xB0:'BCS',0xB1:'LDA (zp),Y',
    0xB4:'LDY zp,X',0xB5:'LDA zp,X',0xB6:'LDX zp,Y',0xB8:'CLV',
    0xB9:'LDA abs,Y',0xBD:'LDA abs,X',0xBE:'LDX abs,Y',0xC0:'CPY #',
    0xC1:'CMP (zp,X)',0xC4:'CPY zp',0xC5:'CMP zp',0xC6:'DEC zp',
    0xC8:'INY',0xC9:'CMP #',0xCA:'DEX',0xCC:'CPY abs',0xCD:'CMP abs',
    0xCE:'DEC abs',0xD0:'BNE',0xD1:'CMP (zp),Y',0xD5:'CMP zp,X',
    0xD6:'DEC zp,X',0xD8:'CLD',0xD9:'CMP abs,Y',0xDD:'CMP abs,X',
    0xDE:'DEC abs,X',0xE0:'CPX #',0xE1:'SBC (zp,X)',0xE4:'CPX zp',
    0xE5:'SBC zp',0xE6:'INC zp',0xE8:'INX',0xE9:'SBC #',0xEA:'NOP',
    0xEC:'CPX abs',0xED:'SBC abs',0xEE:'INC abs',0xF0:'BEQ',
    0xF1:'SBC (zp),Y',0xF5:'SBC zp,X',0xF6:'INC zp,X',0xF8:'SED',
    0xF9:'SBC abs,Y',0xFD:'SBC abs,X',0xFE:'INC abs,X'
}

while idx < len(data):
    phys = start + idx
    cpu = 0x8000 + (phys - 0x48000)
    op = data[idx]
    length = oplen.get(op, 1)
    mnem = opcodes.get(op, f'???({op:02X})')
    
    # Emit label-style output for interesting addresses
    if op == 0x60:  # RTS
        print(f'P:{phys:05X} R:{cpu:04X}  {op:02X}         {mnem}')
        print('---')
    elif length == 1:
        print(f'P:{phys:05X} R:{cpu:04X}  {op:02X}         {mnem}')
    elif length == 2:
        b1 = data[idx+1] if idx+1 < len(data) else 0
        print(f'P:{phys:05X} R:{cpu:04X}  {op:02X} {b1:02X}      {mnem} ${b1:02X}')
    elif length == 3:
        b1 = data[idx+1] if idx+1 < len(data) else 0
        b2 = data[idx+2] if idx+2 < len(data) else 0
        addr = b1 | (b2 << 8)
        # Note common addresses
        comment = ''
        if addr == 0x615A:
            comment = '  ; ChapterNumber'
        elif addr >= 0x6001 and addr <= 0x6100:
            comment = '  ; party data'
        print(f'P:{phys:05X} R:{cpu:04X}  {op:02X} {b1:02X} {b2:02X}   {mnem} ${addr:04X}{comment}')
    
    idx += length

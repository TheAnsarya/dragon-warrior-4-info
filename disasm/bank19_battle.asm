; Dragon Warrior 4 (NES) - Bank 19 Disassembly
; Battle System Code
; Auto-generated by extract_bank19_code.py

; Bank 19 is loaded at $8000-$BFFF
; ROM offset: $4C010 - $50010

; ============================================
; battle_entry - Battle Entry Point
; CPU Address: $8038
; ROM Offset:  $4C038
; ============================================


; battle_entry
battle_entry:
$8038:  20 88 80      JSR read_tactics
$803B:  20 A1 80      JSR $80A1
$803E:  90 09         BCC $8049
$8040:  20 4A 80      JSR $804A
$8043:  20 12 92      JSR sum_party_stats
$8046:  20 5B 80      JSR dispatch_action
$8049:  60            RTS 


; ============================================
; read_tactics - Read Tactics Setting
; CPU Address: $8088
; ROM Offset:  $4C088
; ============================================


; read_tactics
read_tactics:
$8088:  AD 5B 61      LDA tactics
$808B:  8D 80 6E      STA action_type
$808E:  F0 04         BEQ $8094
$8090:  C9 02         CMP #$02
$8092:  D0 0A         BNE $809E
$8094:  AD 44 6E      LDA $6E44
$8097:  10 05         BPL $809E
$8099:  A9 06         LDA #$06
$809B:  8D 80 6E      STA action_type
$809E:  60            RTS 


; ============================================
; mul16 - 16-bit Multiply by 16
; CPU Address: $8176
; ROM Offset:  $4C176
; ============================================


; mul16
mul16:
$8176:  16 00         ASL $00,X
$8178:  36 01         ROL $01,X
$817A:  16 00         ASL $00,X
$817C:  36 01         ROL $01,X
$817E:  16 00         ASL $00,X
$8180:  36 01         ROL $01,X
$8182:  16 00         ASL $00,X
$8184:  36 01         ROL $01,X
$8186:  60            RTS 


; ============================================
; div16 - 16-bit Divide by 16
; CPU Address: $8187
; ROM Offset:  $4C187
; ============================================


; div16
div16:
$8187:  56 01         LSR $01,X
$8189:  76 00         ROR $00,X
$818B:  56 01         LSR $01,X
$818D:  76 00         ROR $00,X
$818F:  56 01         LSR $01,X
$8191:  76 00         ROR $00,X
$8193:  56 01         LSR $01,X
$8195:  76 00         ROR $00,X
$8197:  60            RTS 


; ============================================
; mult_by_a - Multiply by Accumulator
; CPU Address: $8330
; ROM Offset:  $4C330
; ============================================


; mult_by_a
mult_by_a:
$8330:  85 16         STA $16
$8332:  A9 00         LDA #$00
$8334:  85 17         STA $17
$8336:  85 18         STA $18
$8338:  85 19         STA $19
$833A:  85 1A         STA $1A
$833C:  46 16         LSR $16
$833E:  90 13         BCC $8353
$8340:  B5 00         LDA $00,X
$8342:  18            CLC 
$8343:  65 17         ADC $17
$8345:  85 17         STA $17
$8347:  B5 01         LDA $01,X
$8349:  65 18         ADC $18
$834B:  85 18         STA $18
$834D:  A5 19         LDA $19
$834F:  65 1A         ADC $1A
$8351:  85 19         STA $19
$8353:  16 00         ASL $00,X
$8355:  36 01         ROL $01,X
$8357:  26 1A         ROL $1A
$8359:  A5 16         LDA $16
$835B:  D0 DF         BNE $833C
$835D:  A5 17         LDA $17
$835F:  95 00         STA $00,X
$8361:  A5 18         LDA $18
$8363:  95 01         STA $01,X
$8365:  60            RTS 


; ============================================
; div_16_loop - 16-bit Division
; CPU Address: $83C5
; ROM Offset:  $4C3C5
; ============================================


; div_16_loop
div_16_loop:
$83C5:  16 00         ASL $00,X
$83C7:  36 01         ROL $01,X
$83C9:  2E 11 6E      ROL $6E11
$83CC:  2E 12 6E      ROL $6E12
$83CF:  F6 00         INC $00,X
$83D1:  AD 11 6E      LDA $6E11
$83D4:  38            SEC 
$83D5:  ED 14 6E      SBC $6E14
$83D8:  48            PHA 
$83D9:  AD 12 6E      LDA $6E12
$83DC:  ED 15 6E      SBC $6E15
$83DF:  B0 06         BCS $83E7
$83E1:  68            PLA 
$83E2:  D6 00         DEC $00,X
$83E4:  4C EE 83      JMP $83EE
$83E7:  8D 12 6E      STA $6E12
$83EA:  68            PLA 
$83EB:  8D 11 6E      STA $6E11
$83EE:  88            DEY 
$83EF:  D0 D4         BNE div_16_loop
$83F1:  68            PLA 
$83F2:  A8            TAY 
$83F3:  60            RTS 


; ============================================
; div_24_loop - 24-bit Division
; CPU Address: $8414
; ROM Offset:  $4C414
; ============================================


; div_24_loop
div_24_loop:
$8414:  16 00         ASL $00,X
$8416:  36 01         ROL $01,X
$8418:  36 02         ROL $02,X
$841A:  2E 11 6E      ROL $6E11
$841D:  2E 12 6E      ROL $6E12
$8420:  2E 13 6E      ROL $6E13
$8423:  F6 00         INC $00,X
$8425:  AD 11 6E      LDA $6E11
$8428:  38            SEC 
$8429:  ED 14 6E      SBC $6E14
$842C:  48            PHA 
$842D:  AD 12 6E      LDA $6E12
$8430:  ED 15 6E      SBC $6E15
$8433:  48            PHA 
$8434:  AD 13 6E      LDA $6E13
$8437:  ED 16 6E      SBC $6E16
$843A:  B0 07         BCS $8443
$843C:  68            PLA 
$843D:  68            PLA 
$843E:  D6 00         DEC $00,X
$8440:  4C 4E 84      JMP $844E
$8443:  8D 13 6E      STA $6E13
$8446:  68            PLA 
$8447:  8D 12 6E      STA $6E12
$844A:  68            PLA 
$844B:  8D 11 6E      STA $6E11
$844E:  88            DEY 
$844F:  D0 C3         BNE div_24_loop
$8451:  68            PLA 
$8452:  A8            TAY 
$8453:  60            RTS 


; ============================================
; sum_party_stats - Sum Party Member Stats
; CPU Address: $9212
; ROM Offset:  $4D212
; ============================================


; sum_party_stats
sum_party_stats:
$9212:  A9 00         LDA #$00
$9214:  85 01         STA $01
$9216:  85 02         STA $02
$9218:  A9 07         LDA #$07
$921A:  85 81         STA party_loop
$921C:  20 77 8D      JSR $8D77
$921F:  A0 00         LDY #$00
$9221:  20 5F 92      JSR $925F
$9224:  A0 08         LDY #$08
$9226:  20 5F 92      JSR $925F
$9229:  A0 10         LDY #$10
$922B:  20 5F 92      JSR $925F
$922E:  C6 81         DEC party_loop
$9230:  10 EA         BPL $921C
$9232:  A9 00         LDA #$00
$9234:  85 00         STA $00
$9236:  85 04         STA $04
$9238:  A9 B7         LDA #$B7
$923A:  85 03         STA $03
$923C:  A2 00         LDX #$00
$923E:  A0 03         LDY #$03
$9240:  20 F4 83      JSR $83F4
$9243:  A5 02         LDA $02
$9245:  F0 06         BEQ $924D
$9247:  A9 FF         LDA #$FF
$9249:  85 00         STA $00
$924B:  85 01         STA $01
$924D:  A5 00         LDA $00
$924F:  8D ED 75      STA $75ED
$9252:  A5 01         LDA $01
$9254:  8D EE 75      STA $75EE
$9257:  05 00         ORA $00
$9259:  D0 03         BNE $925E
$925B:  EE ED 75      INC $75ED
$925E:  60            RTS 


; ============================================
; stat_table_lookup - Look Up Spell Effect
; CPU Address: $9276
; ROM Offset:  $4D276
; ============================================

$9276:  AE D3 75      LDX $75D3
$9279:  BD 0B B8      LDA spell_effect_tbl,X
$927C:  29 1F         AND #$1F
$927E:  AA            TAX 
$927F:  BD CC 94      LDA $94CC,X
$9282:  20 E2 92      JSR $92E2
$9285:  85 00         STA $00
$9287:  A9 00         LDA #$00
$9289:  AE D3 75      LDX $75D3
$928C:  E0 18         CPX #$18
$928E:  D0 04         BNE $9294
$9290:  A9 04         LDA #$04
$9292:  D0 06         BNE $929A
$9294:  E0 1F         CPX #$1F
$9296:  D0 02         BNE $929A
$9298:  A9 04         LDA #$04
$929A:  18            CLC 
$929B:  65 00         ADC $00
$929D:  85 00         STA $00
$929F:  A6 81         LDX party_loop
$92A1:  20 9C 89      JSR $899C
$92A4:  A0 0D         LDY #$0D
$92A6:  B1 86         LDA ($86),Y
$92A8:  29 03         AND #$03
$92AA:  AA            TAX 
$92AB:  A5 00         LDA $00
$92AD:  48            PHA 
$92AE:  BD 06 72      LDA $7206,X
$92B1:  20 B4 B0      JSR $B0B4
$92B4:  A8            TAY 
$92B5:  68            PLA 
$92B6:  0A            ASL 
$92B7:  85 00         STA $00
$92B9:  98            TYA 
$92BA:  0A            ASL 
$92BB:  0A            ASL 
$92BC:  0A            ASL 
$92BD:  0A            ASL 
$92BE:  65 00         ADC $00
$92C0:  A8            TAY 
$92C1:  B9 DC 94      LDA $94DC,Y
$92C4:  85 00         STA $00
$92C6:  A9 00         LDA #$00
$92C8:  85 01         STA $01
$92CA:  20 91 C8      JSR $C891
$92CD:  A2 00         LDX #$00
$92CF:  20 27 C8      JSR $C827
$92D2:  B9 DB 94      LDA $94DB,Y
$92D5:  18            CLC 
$92D6:  65 01         ADC $01
$92D8:  4A            LSR 
$92D9:  C9 10         CMP #$10
$92DB:  90 02         BCC $92DF
$92DD:  A9 10         LDA #$10
$92DF:  85 8C         STA $8C
$92E1:  60            RTS 


; ============================================
; damage_calc - Damage Calculation
; CPU Address: $AA67
; ROM Offset:  $4EA67
; ============================================


; damage_calc
damage_calc:
$AA67:  A9 00         LDA #$00
$AA69:  85 0A         STA $0A
$AA6B:  85 0E         STA $0E
$AA6D:  85 0F         STA $0F
$AA6F:  A5 00         LDA $00
$AA71:  85 0B         STA $0B
$AA73:  A5 01         LDA $01
$AA75:  85 0C         STA $0C
$AA77:  A5 8B         LDA actor_index
$AA79:  85 0D         STA $0D
$AA7B:  A2 0D         LDX #$0D
$AA7D:  20 76 81      JSR mul16
$AA80:  18            CLC 
$AA81:  AD ED 75      LDA $75ED
$AA84:  65 0D         ADC $0D
$AA86:  85 0D         STA $0D
$AA88:  AD EE 75      LDA $75EE
$AA8B:  65 0E         ADC $0E
$AA8D:  85 0E         STA $0E
$AA8F:  A5 0F         LDA $0F
$AA91:  69 00         ADC #$00
$AA93:  85 0F         STA $0F
$AA95:  90 08         BCC $AA9F
$AA97:  A9 FF         LDA #$FF
$AA99:  85 0D         STA $0D
$AA9B:  85 0E         STA $0E
$AA9D:  85 0F         STA $0F
$AA9F:  A2 0A         LDX #$0A
$AAA1:  A0 0D         LDY #$0D
$AAA3:  20 54 84      JSR $8454
$AAA6:  AC 80 6E      LDY action_type
$AAA9:  B9 8B BB      LDA stat_mult_tbl,Y
$AAAC:  20 66 83      JSR $8366
$AAAF:  06 0A         ASL $0A
$AAB1:  26 0B         ROL $0B
$AAB3:  26 0C         ROL $0C
$AAB5:  26 1A         ROL $1A
$AAB7:  06 0A         ASL $0A
$AAB9:  26 0B         ROL $0B
$AABB:  26 0C         ROL $0C
$AABD:  26 1A         ROL $1A
$AABF:  06 0A         ASL $0A
$AAC1:  26 0B         ROL $0B
$AAC3:  26 0C         ROL $0C
$AAC5:  26 1A         ROL $1A
$AAC7:  06 0A         ASL $0A
$AAC9:  26 0B         ROL $0B
$AACB:  26 0C         ROL $0C
$AACD:  26 1A         ROL $1A
$AACF:  A5 00         LDA $00
$AAD1:  85 0D         STA $0D
$AAD3:  A5 01         LDA $01
$AAD5:  85 0E         STA $0E
$AAD7:  AC 80 6E      LDY action_type
$AADA:  B9 84 BB      LDA atk_mult_tbl,Y
$AADD:  A2 0D         LDX #$0D
$AADF:  20 30 83      JSR mult_by_a
$AAE2:  18            CLC 
$AAE3:  A5 0A         LDA $0A
$AAE5:  65 0D         ADC $0D
$AAE7:  85 0D         STA $0D
$AAE9:  A5 0B         LDA $0B
$AAEB:  65 0E         ADC $0E
$AAED:  85 0E         STA $0E
$AAEF:  A5 0C         LDA $0C
$AAF1:  65 19         ADC $19
$AAF3:  85 0F         STA $0F
$AAF5:  A9 00         LDA #$00
$AAF7:  85 08         STA $08
$AAF9:  85 0B         STA $0B
$AAFB:  A5 8B         LDA actor_index
$AAFD:  0A            ASL 
$AAFE:  26 0B         ROL $0B
$AB00:  0A            ASL 
$AB01:  26 0B         ROL $0B
$AB03:  0A            ASL 
$AB04:  26 0B         ROL $0B
$AB06:  85 0A         STA $0A
$AB08:  38            SEC 
$AB09:  ED EF 75      SBC $75EF
$AB0C:  85 0A         STA $0A
$AB0E:  A5 0B         LDA $0B
$AB10:  E9 00         SBC #$00
$AB12:  85 0B         STA $0B
$AB14:  05 0A         ORA $0A
$AB16:  F0 34         BEQ $AB4C
$AB18:  90 32         BCC $AB4C
$AB1A:  A9 08         LDA #$08
$AB1C:  A2 0A         LDX #$0A
$AB1E:  20 13 C8      JSR $C813
$AB21:  A9 08         LDA #$08
$AB23:  85 09         STA $09
$AB25:  A2 08         LDX #$08
$AB27:  A0 0A         LDY #$0A
$AB29:  20 AA 83      JSR $83AA
$AB2C:  A5 09         LDA $09
$AB2E:  .byte $F0


; ============================================
; get_spell_power - Get Spell Power
; CPU Address: $AEA6
; ROM Offset:  $4EEA6
; ============================================

$AEA6:  20 C0 AE      JSR $AEC0
$AEA9:  BD 3F BB      LDA spell_power_tbl,X
$AEAC:  4C BA AE      JMP $AEBA
$AEAF:  46 8C         LSR $8C
$AEB1:  66 8B         ROR actor_index
$AEB3:  60            RTS 


; ============================================
; get_spell_attr - Get Spell Attribute
; CPU Address: $AEB4
; ROM Offset:  $4EEB4
; ============================================

$AEB4:  20 C0 AE      JSR $AEC0
$AEB7:  BD 49 BB      LDA spell_attr_tbl,X
$AEBA:  A2 8B         LDX #$8B
$AEBC:  20 FB C7      JSR $C7FB
$AEBF:  60            RTS 


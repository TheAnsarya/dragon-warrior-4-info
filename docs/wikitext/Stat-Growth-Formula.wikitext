= Dragon Warrior IV (NES) Stat Growth Formula =

This page documents the '''stat growth formula''' reverse-engineered from Dragon Warrior IV (NES, US version). When characters level up, the game computes their new stat values using per-character growth tables and formulas rather than simple lookup tables.

== Overview ==

Unlike Dragon Warrior I-III which use lookup tables for stats, DW4 computes stat values at runtime using:
* '''Base parameters''' - Character and gender-specific starting point
* '''Growth data''' - Signed bytes indicating stat changes per level (3 bytes per level)
* '''Level multiplier''' - Level value shifted left 4 (×16)

The computation occurs in '''Bank 8''' at addresses $80d5-$81e8.

== Formula ==

<pre>
stat_base = (level × 16) + base_param[character][gender]

For each growth byte at growth_data[character][level×3 + n]:
    stat[n] = stat_base + (sign_extend(growth_byte) × 16)
</pre>

Where:
* Level is multiplied by 16 (shift left 4)
* Growth bytes are signed (-128 to +127)
* Sign extension converts 8-bit signed to 16-bit signed
* Results stored in $0100-$0107 (4 × 16-bit values)

== Data Locations ==

{| class="wikitable"
|-
! Data !! Bank !! CPU Address !! Size !! Description
|-
| Computation Code || $08 || $80d5-$81e8 || ~275 bytes || Stat calculation routine
|-
| Math Subroutines || $1f || $c813-$c850 || ~62 bytes || 16-bit add/multiply (fixed bank)
|-
| Base Param Table || $08 || $8229 || 12 bytes || 6 entries × 2 bytes
|-
| Growth Pointers || $08 || $8237 || 9 bytes || Low+high pointers per character
|-
| Hero Growth Data || $08 || $a1bb || ~150 bytes || 3 bytes per level
|-
| Special Ptr || $08 || $8225 || 2 bytes || Max level handling
|-
| Global Base || $08 || $8235 || 2 bytes || Hero-specific offset ($a80d)
|}

== Character ID Values ==

{| class="wikitable"
|-
! ID !! Character
|-
| $00 || Hero
|-
| $01 || Ragnar
|-
| $02 || Alena
|-
| $03 || Cristo
|-
| $04 || Brey
|-
| $05 || Taloon
|-
| $06 || Nara
|-
| $07 || Mara
|-
| $08 || Orin (wagon)
|-
| $09 || Panon/Others
|}

== Zero Page Variables ==

{| class="wikitable"
|-
! Address !! Name !! Description
|-
| $00-$01 || result_lo/hi || 16-bit calculation result
|-
| $02-$03 || growth_ptr_lo/hi || Pointer to growth data table
|-
| $04 || work || General work variable
|-
| $08 || level_idx || Level index for table lookup
|-
| $09 || char_id || Character ID (0-7)
|-
| $0a-$0c || stat_bytes || 3 bytes from character record
|-
| $0e-$0f || data_ptr || General data pointer
|-
| $72-$73 || temp_16 || 16-bit temp for signed math
|-
| $76 || gender_flag || 0=male, 1=female
|}

== Base Parameter Table ($8229) ==

Indexed by <code>(char_id × 2 + gender) × 2</code>:

{| class="wikitable"
|-
! Index !! Raw !! Pointer
|-
| 0 || $00 $80 || $8000
|-
| 1 || $01 $7f || $7f01
|-
| 2 || $14 $9e || $9e14
|-
| 3 || $00 $00 || $0000
|-
| 4 || $04 $b3 || $b304
|-
| 5 || $97 $80 || $8097
|}

== Growth Data Pointer Table ($8237) ==

{| class="wikitable"
|-
! Character !! Low Byte !! High Byte !! Pointer
|-
| Hero || $bb || $a1 || $a1bb
|-
| Ragnar || $d0 || $a1* || $a1d0
|-
| Alena || $00 || || (derived)
|-
| Cristo || $76 || || (derived)
|-
| Brey || $a9 || || (derived)
|-
| Taloon || $8d || || (derived)
|-
| Nara || $85 || || (derived)
|-
| Mara || $04 || || (derived)
|}

<small>''* Table format uses sequential bytes for low/high''</small>

== Growth Data Format ==

Each character's growth data consists of signed bytes (3 per level):
* Byte 0: HP growth increment
* Byte 1: MP growth increment
* Byte 2: Other stat increment

Example: Hero growth at $a1bb:
<pre>
$a1bb: 01 01 01 00 00 00 00 01 00 01 00 FF ...
       +1 +1 +1 +0 +0 +0 +0 +1 +0 +1 +0 -1
</pre>

Values are:
* Positive ($00-$7f): Add 0-127
* Negative ($80-$ff): Add -128 to -1

== Calculation Flow ==

=== Entry Point ($80d5) ===

<pre>
$80d5: lda #$00
$80d7: sta $76        ; Clear gender flag
$80d9: lda $0a        ; Load stat byte
$80db: and #$07       ; Extract level bits
$80dd: sta $01
...
$80e3: ldx $09        ; Load char_id
$80e5: bne @not_hero  ; Branch if not Hero
</pre>

=== Hero-Specific Path ===

The Hero has special handling that multiplies by 3 and adds a global base ($a80d).

=== Non-Hero Path ($8132) ===

<pre>
$8132: lda $0a        ; Load stat byte
$8134: and #$03       ; Extract bits
$8136: sta $01
$8138: lda $0c
$813a: lsr A
$813b: lsr A
$813c: cmp #$3f       ; Check max level (63)
$813e: beq handle_max
$8140: sta $08        ; Store level index
</pre>

=== Main Calculation ($814a) ===

<pre>
; Multiply level by 16
$814a: ldx #$04
shift_loop:
$814c: asl $00
$814e: rol $01
$8150: dex
$8151: bne shift_loop

; Get base param index
$8153: lda $09        ; char_id
$8155: asl A          ; × 2
$8156: ora $76        ; + gender
$8158: asl A          ; × 2 for word offset
$8159: tax

; Add base parameter
$815a: lda $8229,X    ; base_params low
$815d: ldy $822a,X    ; base_params high
$8160: ldx #$00
$8162: jsr $c81d      ; add_extended

; Get growth pointer
$8165: ldx $09        ; char_id
$8167: lda $8237,X    ; growth_ptr low
$816a: sta $02
$816c: lda $8238,X    ; growth_ptr high
$816f: sta $03

; Calculate offset: level × 3
$8171: lda $08        ; level
$8173: asl A          ; × 2
$8174: adc $08        ; + level = × 3
$8176: ldx #$02
$8178: jsr $c813      ; add growth_ptr
</pre>

=== Growth Loop ($8187) ===

<pre>
growth_loop:
$8187: tya
$8188: pha            ; Save counter

; Load signed byte
$8189: lda ($02),Y    ; growth[n]
$818b: php            ; Save sign flag

; Sign extend to 16-bit
$818c: ldy #$00
$818e: plp
$818f: bpl positive
$8191: ldy #$ff       ; Negative: high = $ff
positive:
$8193: sta $72        ; temp_lo
$8195: STY $73        ; temp_hi

; Multiply by 16
$8197: asl $72
$8199: rol $73        ; × 2
$819b: asl $72
$819d: rol $73        ; × 4
$819f: asl $72
$81a1: rol $73        ; × 8
$81a3: asl $72
$81a5: rol $73        ; × 16

; Add to result
$81a7: lda $72
$81a9: ldy $73
$81ab: ldx #$00
$81ad: jsr $c81d      ; add_extended

; Store result
$81b0: pla
$81b1: tay            ; Restore counter
$81b2: asl A          ; × 2 for word index
$81b3: tax
$81b4: lda $00
$81b6: sta $0102,X    ; result[n] low
$81b9: lda $01
$81bb: sta $0103,X    ; result[n] high

$81be: iny
$81bf: cpy #$03       ; Loop 3 times
$81c1: bne growth_loop
</pre>

== Special Cases ==

=== Max Level ($81c6) ===

When level index = $0f (15), stats are copied from a fixed table rather than calculated. Uses pointer at $8225 and copies 8 bytes directly to $0100.

=== Variant Characters ($81e8) ===

When level index = $0e (14), uses alternate calculation with pointer at $8227. Sets gender_flag to $11 and applies different formula.

== Math Subroutines (Bank $1f) ==

=== add_16bit ($c813) ===
Adds 8-bit value in A to 16-bit value at zero page offset X.

=== add_extended ($c81d) ===
Adds 16-bit value (A=low, Y=high) to value at zero page offset X.

=== multiply_8x16 ($c827) ===
Standard shift-and-add multiplication. Multiplies A (8-bit) by 16-bit value at offset X.

== Algorithm Summary ==

<pre>
function calculate_stats(char_id, gender, level, stat_bytes):
    if char_id == HERO:
        result = stat_bytes * 3 + $a80d
        level_idx = extracted from result
        # Additional Hero-specific logic
    else:
        level_idx = (stat_byte_2 >> 2) & $3f

    if level_idx == $0f:  # Max level
        return copy_from_table($8225 + result * 8)

    if level_idx == $0e:  # Variant
        return variant_calculation()

    # Normal calculation
    stat_base = (level_idx * 16) + base_params[(char_id*2 + gender)*2]
    growth_ptr = growth_pointers[char_id] + (level_idx * 3)

    for n in 0..2:
        growth_byte = growth_data[growth_ptr + n]  # signed
        stats[n] = stat_base + (sign_extend(growth_byte) * 16)

    return stats
</pre>

== Notes ==

* Growth bytes are signed - negative values reduce stats
* The × 16 multiplier amplifies small growth differences
* Hero has unique calculation path with global base offset
* Gender flag affects base parameter selection
* Max level characters bypass formula entirely

== See Also ==

* [[Dragon Warrior IV (NES):Experience Formula|Experience Formula]] - EXP threshold calculation
* [[Dragon Warrior IV (NES):ROM Map|ROM Map]] - Complete ROM structure
* [[Dragon Warrior IV (NES):RAM Map|RAM Map]] - Memory addresses

== External Links ==

* [https://github.com/user/dragon-warrior-4-info GitHub Repository] - Disassembly project

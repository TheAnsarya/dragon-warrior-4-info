= Dragon Warrior IV (NES) Stat Growth Formula =

This page documents the '''stat growth formula''' reverse-engineered from Dragon Warrior IV (NES, US version). When characters level up, the game computes their new stat values using per-character growth tables and formulas rather than simple lookup tables.

== Overview ==

Unlike Dragon Warrior I-III which use lookup tables for stats, DW4 computes stat values at runtime using:
* '''Base parameters''' - Character and gender-specific starting point
* '''Growth data''' - Signed bytes indicating stat changes per level (3 bytes per level)
* '''Level multiplier''' - Level value shifted left 4 (×16)

The computation occurs in '''Bank 8''' at addresses $80D5-$81E8.

== Formula ==

<pre>
stat_base = (level × 16) + base_param[character][gender]

For each growth byte at growth_data[character][level×3 + n]:
    stat[n] = stat_base + (sign_extend(growth_byte) × 16)
</pre>

Where:
* Level is multiplied by 16 (shift left 4)
* Growth bytes are signed (-128 to +127)
* Sign extension converts 8-bit signed to 16-bit signed
* Results stored in $0100-$0107 (4 × 16-bit values)

== Data Locations ==

{| class="wikitable"
|-
! Data !! Bank !! CPU Address !! Size !! Description
|-
| Computation Code || $08 || $80D5-$81E8 || ~275 bytes || Stat calculation routine
|-
| Math Subroutines || $1F || $C813-$C850 || ~62 bytes || 16-bit add/multiply (fixed bank)
|-
| Base Param Table || $08 || $8229 || 12 bytes || 6 entries × 2 bytes
|-
| Growth Pointers || $08 || $8237 || 9 bytes || Low+high pointers per character
|-
| Hero Growth Data || $08 || $A1BB || ~150 bytes || 3 bytes per level
|-
| Special Ptr || $08 || $8225 || 2 bytes || Max level handling
|-
| Global Base || $08 || $8235 || 2 bytes || Hero-specific offset ($A80D)
|}

== Character ID Values ==

{| class="wikitable"
|-
! ID !! Character
|-
| $00 || Hero
|-
| $01 || Ragnar
|-
| $02 || Alena
|-
| $03 || Cristo
|-
| $04 || Brey
|-
| $05 || Taloon
|-
| $06 || Nara
|-
| $07 || Mara
|-
| $08 || Orin (wagon)
|-
| $09 || Panon/Others
|}

== Zero Page Variables ==

{| class="wikitable"
|-
! Address !! Name !! Description
|-
| $00-$01 || result_lo/hi || 16-bit calculation result
|-
| $02-$03 || growth_ptr_lo/hi || Pointer to growth data table
|-
| $04 || work || General work variable
|-
| $08 || level_idx || Level index for table lookup
|-
| $09 || char_id || Character ID (0-7)
|-
| $0A-$0C || stat_bytes || 3 bytes from character record
|-
| $0E-$0F || data_ptr || General data pointer
|-
| $72-$73 || temp_16 || 16-bit temp for signed math
|-
| $76 || gender_flag || 0=male, 1=female
|}

== Base Parameter Table ($8229) ==

Indexed by <code>(char_id × 2 + gender) × 2</code>:

{| class="wikitable"
|-
! Index !! Raw !! Pointer
|-
| 0 || $00 $80 || $8000
|-
| 1 || $01 $7F || $7F01
|-
| 2 || $14 $9E || $9E14
|-
| 3 || $00 $00 || $0000
|-
| 4 || $04 $B3 || $B304
|-
| 5 || $97 $80 || $8097
|}

== Growth Data Pointer Table ($8237) ==

{| class="wikitable"
|-
! Character !! Low Byte !! High Byte !! Pointer
|-
| Hero || $BB || $A1 || $A1BB
|-
| Ragnar || $D0 || $A1* || $A1D0
|-
| Alena || $00 || || (derived)
|-
| Cristo || $76 || || (derived)
|-
| Brey || $A9 || || (derived)
|-
| Taloon || $8D || || (derived)
|-
| Nara || $85 || || (derived)
|-
| Mara || $04 || || (derived)
|}

<small>''* Table format uses sequential bytes for low/high''</small>

== Growth Data Format ==

Each character's growth data consists of signed bytes (3 per level):
* Byte 0: HP growth increment
* Byte 1: MP growth increment
* Byte 2: Other stat increment

Example: Hero growth at $A1BB:
<pre>
$A1BB: 01 01 01 00 00 00 00 01 00 01 00 FF ...
       +1 +1 +1 +0 +0 +0 +0 +1 +0 +1 +0 -1
</pre>

Values are:
* Positive ($00-$7F): Add 0-127
* Negative ($80-$FF): Add -128 to -1

== Calculation Flow ==

=== Entry Point ($80D5) ===

<pre>
$80D5: LDA #$00
$80D7: STA $76        ; Clear gender flag
$80D9: LDA $0A        ; Load stat byte
$80DB: AND #$07       ; Extract level bits
$80DD: STA $01
...
$80E3: LDX $09        ; Load char_id
$80E5: BNE @not_hero  ; Branch if not Hero
</pre>

=== Hero-Specific Path ===

The Hero has special handling that multiplies by 3 and adds a global base ($A80D).

=== Non-Hero Path ($8132) ===

<pre>
$8132: LDA $0A        ; Load stat byte
$8134: AND #$03       ; Extract bits
$8136: STA $01
$8138: LDA $0C
$813A: LSR A
$813B: LSR A
$813C: CMP #$3F       ; Check max level (63)
$813E: BEQ handle_max
$8140: STA $08        ; Store level index
</pre>

=== Main Calculation ($814A) ===

<pre>
; Multiply level by 16
$814A: LDX #$04
shift_loop:
$814C: ASL $00
$814E: ROL $01
$8150: DEX
$8151: BNE shift_loop

; Get base param index
$8153: LDA $09        ; char_id
$8155: ASL A          ; × 2
$8156: ORA $76        ; + gender
$8158: ASL A          ; × 2 for word offset
$8159: TAX

; Add base parameter
$815A: LDA $8229,X    ; base_params low
$815D: LDY $822A,X    ; base_params high
$8160: LDX #$00
$8162: JSR $C81D      ; add_extended

; Get growth pointer
$8165: LDX $09        ; char_id
$8167: LDA $8237,X    ; growth_ptr low
$816A: STA $02
$816C: LDA $8238,X    ; growth_ptr high
$816F: STA $03

; Calculate offset: level × 3
$8171: LDA $08        ; level
$8173: ASL A          ; × 2
$8174: ADC $08        ; + level = × 3
$8176: LDX #$02
$8178: JSR $C813      ; add growth_ptr
</pre>

=== Growth Loop ($8187) ===

<pre>
growth_loop:
$8187: TYA
$8188: PHA            ; Save counter

; Load signed byte
$8189: LDA ($02),Y    ; growth[n]
$818B: PHP            ; Save sign flag

; Sign extend to 16-bit
$818C: LDY #$00
$818E: PLP
$818F: BPL positive
$8191: LDY #$FF       ; Negative: high = $FF
positive:
$8193: STA $72        ; temp_lo
$8195: STY $73        ; temp_hi

; Multiply by 16
$8197: ASL $72
$8199: ROL $73        ; × 2
$819B: ASL $72
$819D: ROL $73        ; × 4
$819F: ASL $72
$81A1: ROL $73        ; × 8
$81A3: ASL $72
$81A5: ROL $73        ; × 16

; Add to result
$81A7: LDA $72
$81A9: LDY $73
$81AB: LDX #$00
$81AD: JSR $C81D      ; add_extended

; Store result
$81B0: PLA
$81B1: TAY            ; Restore counter
$81B2: ASL A          ; × 2 for word index
$81B3: TAX
$81B4: LDA $00
$81B6: STA $0102,X    ; result[n] low
$81B9: LDA $01
$81BB: STA $0103,X    ; result[n] high

$81BE: INY
$81BF: CPY #$03       ; Loop 3 times
$81C1: BNE growth_loop
</pre>

== Special Cases ==

=== Max Level ($81C6) ===

When level index = $0F (15), stats are copied from a fixed table rather than calculated. Uses pointer at $8225 and copies 8 bytes directly to $0100.

=== Variant Characters ($81E8) ===

When level index = $0E (14), uses alternate calculation with pointer at $8227. Sets gender_flag to $11 and applies different formula.

== Math Subroutines (Bank $1F) ==

=== add_16bit ($C813) ===
Adds 8-bit value in A to 16-bit value at zero page offset X.

=== add_extended ($C81D) ===
Adds 16-bit value (A=low, Y=high) to value at zero page offset X.

=== multiply_8x16 ($C827) ===
Standard shift-and-add multiplication. Multiplies A (8-bit) by 16-bit value at offset X.

== Algorithm Summary ==

<pre>
function calculate_stats(char_id, gender, level, stat_bytes):
    if char_id == HERO:
        result = stat_bytes * 3 + $A80D
        level_idx = extracted from result
        # Additional Hero-specific logic
    else:
        level_idx = (stat_byte_2 >> 2) & $3F

    if level_idx == $0F:  # Max level
        return copy_from_table($8225 + result * 8)

    if level_idx == $0E:  # Variant
        return variant_calculation()

    # Normal calculation
    stat_base = (level_idx * 16) + base_params[(char_id*2 + gender)*2]
    growth_ptr = growth_pointers[char_id] + (level_idx * 3)

    for n in 0..2:
        growth_byte = growth_data[growth_ptr + n]  # signed
        stats[n] = stat_base + (sign_extend(growth_byte) * 16)

    return stats
</pre>

== Notes ==

* Growth bytes are signed - negative values reduce stats
* The × 16 multiplier amplifies small growth differences
* Hero has unique calculation path with global base offset
* Gender flag affects base parameter selection
* Max level characters bypass formula entirely

== See Also ==

* [[Dragon Warrior IV (NES):Experience Formula|Experience Formula]] - EXP threshold calculation
* [[Dragon Warrior IV (NES):ROM Map|ROM Map]] - Complete ROM structure
* [[Dragon Warrior IV (NES):RAM Map|RAM Map]] - Memory addresses

== External Links ==

* [https://github.com/user/dragon-warrior-4-info GitHub Repository] - Disassembly project

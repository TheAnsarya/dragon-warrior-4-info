# Session Log: 2026-01-10 - Experience Computation Discovery

## Session Focus
Deep analysis of Dragon Warrior IV experience/level-up system using CDL data.

## Major Discovery

**Experience thresholds are COMPUTED, not stored as tables!**

This is a fundamental architectural difference from Dragon Warrior I (which uses simple 2-byte lookup tables).

## Work Completed

### 1. CDL Analysis
- Used level-up specific CDL: `Dragon Warrior IV (1992-10)(Enix)(US) - level up.cdl`
- 6.20% coverage (32,521 bytes): 24,065 code, 8,626 data
- Bank 8 contains main level-up routines

### 2. Code Tracing
Found 135 arithmetic opcodes during level-up:
- ASL A: 27x, LSR A: 24x, ASL abs: 22x
- ROL zp: 18x, ASL zp: 17x
- 15+ "16-bit shift" patterns (multiplication)

### 3. Subroutine Analysis
Identified key math routines in fixed bank (Bank F):
- `$C813`: 16-bit addition
- `$C81D`: Extended 16-bit add with Y high byte
- `$C827`: Binary multiplication (shift-and-add)

### 4. Parameter Tables
Character-indexed tables found:
- `$8229-$8238`: Growth parameters (per character)
- Code does: `LDA $8229,X` / `LDY $822A,X` with X derived from character ID

### 5. Spell Learning Table
Identified region at `$8ABE` (file 0x20ACE) as **spell learning table**, NOT experience:
- Pattern: Level numbers [1,2,3...15] followed by spell IDs
- This was previously misidentified as EXP data

## Files Created

1. [docs/research/experience-computation.md](../../docs/research/experience-computation.md)
   - Comprehensive documentation of findings
   - Disassembled subroutines with annotations
   - ROM location reference table
   - Next steps for formula extraction

## Commits

- `7e8e8ac` - docs: add experience computation research

## Implications

1. **DW4Lib needs update**: `ReadExperienceTables()` at Bank 8 $A866 is incorrect
2. **Formula must be reverse-engineered** to generate EXP tables programmatically
3. **Each character has unique growth curve** via parameters, not separate tables
4. **Space savings**: Formula + 10 params vs 10 × 150-byte tables

## Next Steps

1. Fully trace computation algorithm from level → EXP threshold
2. Extract per-character growth parameters
3. Implement formula in DW4Lib
4. Verify computed values against known EXP from game guides
5. Update GitHub issues (#50, #81) with findings

## Related Issues
- #50: Extraction: Experience and level-up tables
- #81: Manual Testing: CDL verification for spell and experience tables

## Session Stats
- Duration: ~1 hour
- Major breakthrough achieved
- 1 documentation file created
- 1 commit pushed

# ==============================================================================
# Dragon Warrior IV (NES) - Mesen Debug Labels
# ==============================================================================
# Format: TYPE:ADDR:LABEL:COMMENT
#   P: = PRG-ROM physical address
#   G: = Global/WRAM address ($6000-$7FFF)
#   R: = Runtime/CPU address (for fixed bank labels)
#
# Created for Mesen NES emulator/debugger
# Repository: https://github.com/mrisney/dragon-warrior-4-info
# DataCrystal: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)
#
# Statistics: ~2,800 labels, ~750 comments across 4,000+ lines
# Banks Covered: 08, 0E, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 27-30
# ==============================================================================

# ==============================================================================
# ZERO PAGE ($00-$FF) - System Variables
# ==============================================================================
P:0010:ptr_lo:General purpose pointer low byte
P:0011:ptr_hi:General purpose pointer high byte
P:0012:rng_seed_lo:RNG seed low byte - changes every frame, XORed with save checksum
P:0013:rng_seed_hi:RNG seed high byte - acts like DW3's RNG
P:0014:scroll_temp:Scroll temporary
P:0016:rng_temp:RNG temporary storage - used during RNG calculation
P:0018:encounter_rate:Encounter rate of current tile
P:001F:state_flags:System state flags (bit 7 = busy)
P:0020:reg_save_a:Saved A during IRQ
P:0021:reg_save_x:Saved X during IRQ
P:0022:reg_save_y:Saved Y during IRQ
P:0023:irq_param_1:IRQ dispatch parameter 1
P:0024:irq_param_2:IRQ dispatch parameter 2
P:0026:brk_ptr_lo:Pointer to BRK operand low
P:0027:brk_ptr_hi:Pointer to BRK operand high
P:0039:ppu_ctrl_mirror:PPU control mirror
P:0040:temp_40:Temporary variable
P:0063:MapNumber:Current map number
P:0064:SubmapNumber:Current submap number
P:0076:irq_temp_76:IRQ temporary
P:0077:irq_temp_77:IRQ temporary
P:0078:irq_temp_78:IRQ temporary
P:007B:scroll_x:Scroll X position
P:007C:scroll_y:Scroll Y position
P:007F:scroll_counter:Scroll counter
P:00EA:position_x_lo:Player X position low byte
P:00EB:position_x_hi:Player X position high byte
P:00EC:position_y_lo:Player Y position low byte
P:00ED:position_y_hi:Player Y position high byte

# ==============================================================================
# WORK RAM ($0100-$07FF)
# ==============================================================================
R:0200:oam_buffer:OAM DMA buffer (256 bytes)
R:0300:ppu_buffer:PPU update buffer
R:0500:vblank_flag:VBlank synchronization flag
R:0501:ppuctrl_shadow:Shadow of PPUCTRL ($2000)
R:0502:NMI_JMP:JMP opcode for NMI vector
R:0503:NMI_target_lo:NMI target address low byte
R:0504:NMI_target_hi:NMI target address high byte
R:0505:ppuctrl_extra:Additional PPU control
R:0506:ppumask_shadow:Shadow of PPUMASK ($2001)
R:0507:current_bank:Currently selected PRG bank
R:0508:scroll_x_shadow:Scroll X shadow
R:0509:scroll_y_shadow:Scroll Y shadow
R:050A:ppu_temp_a:PPU temporary A
R:050B:ppu_buffer_count:PPU buffer entry count
R:050C:rng_counter_cmp:RNG counter comparison value
R:050D:rng_counter:RNG counter - increments each time random number generated
R:0513:shuffle_index:OAM shuffle index
R:0519:nmi_skip_flag:NMI skip update flag
R:0526:timer_counter:Timer counter (CBB4 adds 8 each frame)
R:0529:controller_state:Controller button state
R:052E:input_delay:Input delay counter
R:058F:movement_speed:Movement speed/delta
R:05FC:palette_color:Palette color value
R:07CA:bank_call_result:Bank call result storage
R:07CC:bank_call_save:Bank call saved bank

# ==============================================================================
# SRAM/WRAM ($6000-$7FFF) - Save Game Data (Battery-Backed)
# ==============================================================================

# Save File Layout (from cowness.net)
# Current Save: $6000-$62EE (751 bytes)
# File 1:       $62EF-$65DE (752 bytes)
# File 2:       $65DF-$68CE (752 bytes)
# File 3:       $68CF-$6BBE (752 bytes)

# General Save Data Header
G:6000:SaveDataStart:Start of SRAM save data

# ==============================================================================
# Party Member Data Structure (30 bytes each)
# Source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)/SRAM_map
# Offset +$00: Status flags (bit 5=poison, 6=paralyzed, 7=alive)
# Offset +$01-$02: Current HP (word)
# Offset +$03-$04: Current MP (word)
# Offset +$05: Level
# Offset +$06: Strength
# Offset +$07: Agility
# Offset +$08: Vitality
# Offset +$09: Intelligence
# Offset +$0A: Luck
# Offset +$0B: ??? (unknown)
# Offset +$0C-$0D: Maximum HP (word)
# Offset +$0E-$0F: Maximum MP (word)
# Offset +$10-$12: Current XP (3 bytes)
# Offset +$13-$1A: Item slots 1-8
# Offset +$1B-$1D: Spell flags (3 bytes)
# ==============================================================================

# Party Member 0 (Hero) - 30 bytes at $6001-$601E
G:6001:Hero_StatusFlags:Hero - Status (b5=poison, b6=paralyzed, b7=alive)
G:6002:Hero_CurrentHP_Lo:Hero - Current HP (low byte)
G:6003:Hero_CurrentHP_Hi:Hero - Current HP (high byte)
G:6004:Hero_CurrentMP_Lo:Hero - Current MP (low byte)
G:6005:Hero_CurrentMP_Hi:Hero - Current MP (high byte)
G:6006:Hero_Level:Hero - Level
G:6007:Hero_Strength:Hero - Strength stat
G:6008:Hero_Agility:Hero - Agility stat
G:6009:Hero_Vitality:Hero - Vitality stat
G:600A:Hero_Intelligence:Hero - Intelligence stat
G:600B:Hero_Luck:Hero - Luck stat
G:600C:Hero_Unknown_0C:Hero - Unknown byte
G:600D:Hero_MaxHP_Lo:Hero - Max HP (low byte)
G:600E:Hero_MaxHP_Hi:Hero - Max HP (high byte)
G:600F:Hero_MaxMP_Lo:Hero - Max MP (low byte)
G:6010:Hero_MaxMP_Hi:Hero - Max MP (high byte)
G:6011:Hero_EXP_Lo:Hero - Experience (low byte)
G:6012:Hero_EXP_Mid:Hero - Experience (mid byte)
G:6013:Hero_EXP_Hi:Hero - Experience (high byte)
G:6014:Hero_Item1:Hero - Item slot 1
G:6015:Hero_Item2:Hero - Item slot 2
G:6016:Hero_Item3:Hero - Item slot 3
G:6017:Hero_Item4:Hero - Item slot 4
G:6018:Hero_Item5:Hero - Item slot 5
G:6019:Hero_Item6:Hero - Item slot 6
G:601A:Hero_Item7:Hero - Item slot 7
G:601B:Hero_Item8:Hero - Item slot 8
G:601C:Hero_BattleSpells_Lo:Hero - Battle spell flags (Expel, Healmore, Blaze, Return, Sleepmore, Awake, Firebal, Healall)
G:601D:Hero_BattleSpells_Mid:Hero - Battle spell flags (Ironize, FendSpell, Zap, Transform, Boom, Healusall, Lightning, Vivify)
G:601E:Hero_SpellFlags_Hi:Hero - Spell flags (b0-1=Thordain/Chance battle, b2-7=overworld spells)

# Party Member 1 (Cristo) - 30 bytes at $601F-$603C
G:601F:Cristo_StatusFlags:Cristo - Status (b5=poison, b6=paralyzed, b7=alive)
G:6020:Cristo_CurrentHP_Lo:Cristo - Current HP (low byte)
G:6021:Cristo_CurrentHP_Hi:Cristo - Current HP (high byte)
G:6022:Cristo_CurrentMP_Lo:Cristo - Current MP (low byte)
G:6023:Cristo_CurrentMP_Hi:Cristo - Current MP (high byte)
G:6024:Cristo_Level:Cristo - Level

# Party Member 2 (Nara) - 30 bytes at $603D-$605A
G:603D:Nara_StatusFlags:Nara - Status (b5=poison, b6=paralyzed, b7=alive)

# Party Member 3 (Mara) - 30 bytes at $605B-$6078
G:605B:Mara_StatusFlags:Mara - Status (b5=poison, b6=paralyzed, b7=alive)

# Party Member 4 (Brey) - 30 bytes at $6079-$6096
G:6079:Brey_StatusFlags:Brey - Status (b5=poison, b6=paralyzed, b7=alive)

# Party Member 5 (Taloon) - 30 bytes at $6097-$60B4
G:6097:Taloon_StatusFlags:Taloon - Status (b5=poison, b6=paralyzed, b7=alive)

# Party Member 6 (Ragnar) - 30 bytes at $60B5-$60D2
G:60B5:Ragnar_StatusFlags:Ragnar - Status (b5=poison, b6=paralyzed, b7=alive)

# Party Member 7 (Alena) - 30 bytes at $60D3-$60F0
G:60D3:Alena_StatusFlags:Alena - Status (b5=poison, b6=paralyzed, b7=alive)

# Unused Character Slot - 30 bytes at $60F1-$610E
G:60F1:Unused_Slot:Unused character slot start

# Extra Companion 1 (6 bytes) - DataCrystal
# Healie, Orin, etc. during story events
G:610F:Companion1_StatusFlags:Extra Companion 1 - Status flags (poison, paralyzed, alive)
G:6110:Companion1_CurrentHP_Lo:Extra Companion 1 - Current HP low
G:6111:Companion1_CurrentHP_Hi:Extra Companion 1 - Current HP high
G:6112:Companion1_CurrentMP_Lo:Extra Companion 1 - Current MP low
G:6113:Companion1_CurrentMP_Hi:Extra Companion 1 - Current MP high
G:6114:Companion1_ID:Extra Companion 1 - Which companion type

# Extra Companion 2 (6 bytes) - DataCrystal
G:6115:Companion2_StatusFlags:Extra Companion 2 - Status flags
G:6116:Companion2_CurrentHP_Lo:Extra Companion 2 - Current HP low
G:6117:Companion2_CurrentHP_Hi:Extra Companion 2 - Current HP high
G:6118:Companion2_CurrentMP_Lo:Extra Companion 2 - Current MP low
G:6119:Companion2_CurrentMP_Hi:Extra Companion 2 - Current MP high
G:611A:Companion2_ID:Extra Companion 2 - Which companion type

# General Save Memory ($6157-$62EE)
G:6157:Gold_Lo:Gold amount (low byte)
G:6158:Gold_Mid:Gold amount (middle byte)
G:6159:Gold_Hi:Gold amount (high byte)
G:615A:ChapterNumber:Current chapter (0=Ch1, 1=Ch2, 2=Ch3, 3=Ch4, 4=Ch5)
G:615B:BattleTactics:AI tactics (0=Normal, 1=SaveMP, 2=Offensive, 3=Defensive, 4=TryOut, 5=UseNoMP)

# Return Spell Locations (3 bytes = 24 bits for 24 towns)
# Bit flags: which towns can be teleported to with Return spell
# Reset every chapter change
G:6165:ReturnLoc1:Return spell destinations byte 1
# Bit 0=Branca, 1=Endor, 2=Bonmalmo, 3=Aneaux, 4=Konenber, 5=Mintos, 6=Soretta, 7=Keeleon
G:6166:ReturnLoc2:Return spell destinations byte 2
# Bit 0=Haville, 1=Monbaraba, 2=Santeem, 3=Tempe, 4=Stancia, 5=Burland, 6=Izmit, 7=Gardenbur
G:6167:ReturnLoc3:Return spell destinations byte 3
# Bit 0=Rosaville, 1=Riverton, 2=Dire Palace, 3=Aktemto, 4=Gottside, 5=Zenithia, 6=Last Refuge

# Party Member Order (DataCrystal)
G:616A:PartyOrder_Slot0:Active party slot 0 (character index 0-7)
G:616B:PartyOrder_Slot1:Active party slot 1
G:616C:PartyOrder_Slot2:Active party slot 2
G:616D:PartyOrder_Slot3:Active party slot 3

# Treasure Chest Flags (27 bytes)
G:625D:TreasureFlags_Start:Treasure chest bit flags start
G:625E:TreasureFlags_01:Treasure flags byte 1
G:625F:TreasureFlags_02:Treasure flags byte 2
G:6260:TreasureFlags_03:Treasure flags byte 3
G:6261:TreasureFlags_04:Treasure flags byte 4
G:6262:TreasureFlags_05:Treasure flags byte 5
G:6263:TreasureFlags_06:Treasure flags byte 6
G:6264:TreasureFlags_07:Treasure flags byte 7
G:6265:TreasureFlags_08:Treasure flags byte 8
G:6266:TreasureFlags_09:Treasure flags byte 9
G:6267:TreasureFlags_0A:Treasure flags byte 10
G:6268:TreasureFlags_0B:Treasure flags byte 11
G:6269:TreasureFlags_0C:Treasure flags byte 12
G:626A:TreasureFlags_0D:Treasure flags byte 13
G:626B:TreasureFlags_0E:Treasure flags byte 14
G:626C:TreasureFlags_0F:Treasure flags byte 15
G:626D:TreasureFlags_10:Treasure flags byte 16
G:626E:TreasureFlags_11:Treasure flags byte 17
G:626F:TreasureFlags_12:Treasure flags byte 18
G:6270:TreasureFlags_13:Treasure flags byte 19
G:6271:TreasureFlags_14:Treasure flags byte 20
G:6272:TreasureFlags_15:Treasure flags byte 21
G:6273:TreasureFlags_16:Treasure flags byte 22
G:6274:TreasureFlags_17:Treasure flags byte 23
G:6275:TreasureFlags_18:Treasure flags byte 24
G:6276:TreasureFlags_19:Treasure flags byte 25
G:6277:TreasureFlags_1A:Treasure flags byte 26

# Casino Coins
G:62AD:CasinoCoins_Lo:Casino coins (low byte)
G:62AE:CasinoCoins_Mid:Casino coins (middle byte)
G:62AF:CasinoCoins_Hi:Casino coins (high byte)

# Day/Night Cycle
G:62ED:DayNightCounter:Day/night cycle counter ($00-$CB)

# Chapter 3 Taloon Shop Inventory Counters (DataCrystal)
G:62E7:C3_Shop_Boomerang_Count:Chapter 3 Lakanaba Shop - Boomerang stock count
G:62E8:C3_Shop_ChainSickle_Count:Chapter 3 Lakanaba Shop - Chain Sickle stock count
G:62E9:C3_Shop_SwordOfMalice_Count:Chapter 3 Lakanaba Shop - Sword of Malice stock count

# Bag Storage
G:62EF:BagStorage_Start:Bag item storage start

# ==============================================================================
# MAP RENDERING WRAM (DataCrystal ROM Map)
# ==============================================================================
# MAP RENDERING WRAM (DataCrystal ROM Map)
# ==============================================================================
# Source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)/RAM_map
G:6EFE:map_temp_buffer:Map temp buffer ($20 bytes, init to $FF)
G:6F20:map_smoothing_flags:Smoothing flags - wall tile facing direction ($20 bytes)
G:6F40:map_tile_behaviors:Tile behaviors for current tileset ($40 bytes)
# Tile Behavior Values (source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV/Tile_Behaviors)
# Bit $80 makes tile impassible
# $00=Walkable, $01=Poison Swamp, $02=Barrier, $04=Treasure Chest
# $05=Pitfall, $06/$07=Exit, $08=Stairs Up, $09=Stairs Down
# $0A=Travel Door, $0B=Pitfall, $0F=??? (crashes game!)
# $10=Up Arrow, $11=Right Arrow, $12=Down Arrow, $13=Left Arrow
# $24=Opened big door top, $31=Healing Tile
# $80=Wall, $83=Water, $94=Unlocked Door, $95=Thieves Key Door
# $96=Magic Key Door, $A0=Big Door part, $A7=Desk, $A8=Sign
# $A9=Bookshelf, $AB=Chest of drawers
G:7600:map_tile_numbers:Tile numbers for current tileset (32 tiles × $C0 bytes)
# 33rd tile is Roof tile
G:76C0:map_tile_attributes:Attribute values for current tileset ($40 bytes)
# 33rd tile is Roof tile
G:7800:map_data_buffer:Map data for current map (variable size)
# Format: RRRttttt - ttttt=tile 0-31, RRR=roof 0-7 (0=no roof)

# ==============================================================================
# BATTLE SYSTEM RAM ($6E00-$6E80) - Bank 19 Battle Calculations
# ==============================================================================
G:6E11:battle_div_rem_lo:Division remainder low byte
G:6E12:battle_div_rem_mid:Division remainder mid byte
G:6E13:battle_div_rem_hi:Division remainder high byte
G:6E14:battle_div_divisor_lo:Division divisor low byte
G:6E15:battle_div_divisor_mid:Division divisor mid byte
G:6E16:battle_div_divisor_hi:Division divisor high byte
G:6E44:battle_flag:Battle mode flag
G:6E80:battle_state:Current battle action/state

# ==============================================================================
# BATTLE SYSTEM RAM ($7500-$7600) - Party Stats Buffer
# ==============================================================================
G:7591:party_stat_buffer:Party stat calculation buffer (4 entries)
G:7595:party_stat_buffer_2:Party stat calculation buffer 2 (4 entries)
G:75AD:battle_stat_ad:Battle stat AD
G:75AE:battle_stat_ae:Battle stat AE
G:75AF:battle_stat_af:Battle stat AF
G:75B0:battle_stat_b0:Battle stat B0
G:75B1:battle_stat_b1:Battle stat B1
G:75B2:battle_stat_b2:Battle stat B2
G:75B3:battle_stat_b3:Battle stat B3
G:75B4:battle_stat_b4:Battle stat B4
G:75B5:battle_stat_b5:Battle stat B5
G:75B6:battle_stat_b6:Battle stat B6
G:75B7:battle_stat_b7:Battle stat B7
G:75B8:battle_stat_b8:Battle stat B8
G:75B9:battle_stat_b9:Battle stat B9
G:75BA:battle_stat_ba:Battle stat BA
G:75BB:battle_stat_bb:Battle stat BB
G:75BC:battle_stat_bc:Battle stat BC
G:75BD:battle_stat_bd:Battle stat BD
G:75BE:battle_stat_be:Battle stat BE
G:75BF:battle_stat_bf:Battle stat BF
G:75C0:battle_stat_c0:Battle stat C0
G:75D4:battle_var_d4:Battle variable D4
G:75D5:battle_var_d5:Battle variable D5
G:75D7:battle_var_d7:Battle variable D7
G:75D8:battle_var_d8:Battle variable D8
G:75D9:battle_var_d9:Battle variable D9
G:75DA:battle_var_da:Battle variable DA
G:75DB:battle_var_db:Battle variable DB (init to $FF)
G:75DC:battle_special_flag:Battle special flag ($FF if $73 set)
G:75E6:battle_var_e6:Battle variable E6
G:75E7:battle_var_e7:Battle variable E7
G:75E8:battle_action_index:Battle action index (0-7 valid)

# ==============================================================================
# CHARACTER STATE ARRAY ($72F4+)
# ==============================================================================
G:72F4:char_state_array:Character state array (indexed by X)
G:7004:char_flags_array:Character flags array (indexed by X)
G:7024:battle_result_24:Battle result byte 24
G:7025:battle_result_25:Battle result byte 25

# ==============================================================================
# PRG ROM Banks - Map Data (Banks $09, $0A, $0B)
# ==============================================================================
# Source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)/ROM_map
# Bank 09 ($24000): Town/dungeon map data for locations 00-2D
# Bank 0A ($28000): Map data for locations 2D-45
# Bank 0B ($2C000): Map data for locations 45-48 + Overworld maps

# ==============================================================================
# Bank 09 - Map Data ($24000-$27FFF) - Locations 00-2D
# ==============================================================================
P:24000:b09_map_data_start:Bank 09 map data start

# Map 00: Keeleon (Town and Castle)
P:24000:Map00_Keeleon_Outside:Keeleon - Outside area
P:24085:Map00_Keeleon_F1:Keeleon - F1 (main floor)
P:2412B:Map00_Keeleon_F2:Keeleon - F2
P:241AE:Map00_Keeleon_F3:Keeleon - F3
P:241C1:Map00_Keeleon_B1:Keeleon - B1, Jail

# Map 01: Santeem (Chapter 2 Castle)
P:24206:Map01_Santeem_F1:Santeem - F1 (main floor)
P:242DD:Map01_Santeem_F2:Santeem - F2
P:24344:Map01_Santeem_F3:Santeem - F3 (Alena's room)

# Map 02: Burland (Chapter 1 Castle)
P:24398:Map02_Burland_Town:Burland - Town area
P:2450C:Map02_Burland_Castle_F1:Burland - Castle, F1
P:245DE:Map02_Burland_Castle_F2:Burland - Castle, F2
P:2465D:Map02_Burland_Flora:Burland - Flora's House / Armor Shop, F2

# Map 03: Dire Palace
P:2469B:Map03_DirePalace_F1:Dire Palace - F1
P:247B5:Map03_DirePalace_F2:Dire Palace - F2
P:24834:Map03_DirePalace_B1_Kitchen:Dire Palace - B1, Kitchen/Jail
P:248CF:Map03_DirePalace_B1_Tomb:Dire Palace - B1, Tomb

# Map 04: Endor (Casino Town)
P:248E7:Map04_Endor_Town:Endor - Town area
P:24A45:Map04_Endor_Casino:Endor - Casino/Monster Arena
P:24AAB:Map04_Endor_Castle_F1:Endor - Castle, F1
P:24C77:Map04_Endor_Arena:Endor - Back Castle, Arena

# Maps 05-2D: Additional locations continue in Bank 09
# Full list available at DataCrystal ROM map page

# ==============================================================================
# Bank 0A - Map Data ($28000-$2BFFF) - Locations 2D-45
# ==============================================================================
# Continues from Bank 09, includes Aktemto Mine, Zenethian Tower, etc.
P:28000:b0a_map_data_start:Bank 0A map data start
# Map 2D: Aktemto Mine (continues from Bank 09)
# Map 3D: Zenethian Tower
# Map 45: Necrosaro's Palace (partial)

# ==============================================================================
# Bank 0B - Map Data ($2C000-$2FFFF) - Locations 45-48 + Overworld
# ==============================================================================
P:2C000:b0b_map_data_start:Bank 0B map data start

# Map 45-48: Final areas (continued from Bank 0A)

# Overworld Maps
P:2CCEE:b0b_overworld_main:Main overworld map data
P:2D590:b0b_overworld_row_ptrs:Overworld row pointer table
P:2D990:b0b_overworld_gottside:Gottside continent overworld
P:2DC65:b0b_overworld_underworld:Underworld overworld map

# ==============================================================================
# PRG ROM Banks - Text Data (Banks $0C-$0E typically)
# ==============================================================================

# ==============================================================================
# CHR ROM - Graphics Data
# ==============================================================================

# ==============================================================================
# Hardware Registers
# ==============================================================================
R:2000:PPUCTRL:PPU Control Register
R:2001:PPUMASK:PPU Mask Register
R:2002:PPUSTATUS:PPU Status Register
R:2003:OAMADDR:OAM Address Register
R:2004:OAMDATA:OAM Data Register
R:2005:PPUSCROLL:PPU Scroll Register
R:2006:PPUADDR:PPU Address Register
R:2007:PPUDATA:PPU Data Register
R:4014:OAMDMA:OAM DMA Register
R:4015:SND_CHN:APU Sound Channel Enable
R:4016:JOYPAD1:Joypad 1 Register
R:4017:JOYPAD2:Joypad 2 / APU Frame Counter

# ==============================================================================
# PRG ROM - Fixed Bank Code ($C000-$FFFF)
# ==============================================================================

# Main Initialization
R:C03D:main_init:Main initialization routine
R:C03E:vblank_wait_1:Wait for first VBlank
R:C043:vblank_wait_2:Wait for second VBlank
R:C067:setup_nmi_vector:Set up NMI JMP in RAM
R:C07E:clear_ram_loop:Clear zero page and RAM

# Bank Switching Routines
R:C104:init_subroutine:Additional initialization
R:C118:mmc1_write_control:Write to MMC1 Control register ($9FFF)
R:C12F:mmc1_write_chr1:Write to MMC1 CHR Bank 1 ($BFFF)
R:C146:mmc1_write_prg:Write to MMC1 PRG Bank ($DFFF)

# NMI Handler
R:C15A:NMI_main:NMI handler entry point
R:C181:NMI_check_stack:Check return address on stack
R:C1EF:NMI_update_frame:Update frame counter
R:C213:NMI_return:Normal NMI return
R:C219:NMI_to_irq:Jump to IRQ handler

# PPU Update Routines
R:C222:ppu_buffer_transfer:Transfer PPU update buffer to VRAM
R:C241:ppu_write_loop:PPU buffer write loop
R:C267:ppu_write_data:Write data to PPUDATA
R:C276:ppu_update_palette:Update palette if needed
R:C297:ppu_update_tiles:Update tile data
R:C2EA:ppu_set_scroll:Set PPU scroll registers
R:C303:oam_dma:Perform OAM DMA transfer

# IRQ Handler
R:C408:IRQ_handler:IRQ/BRK handler entry
R:C423:irq_read_operand:Read BRK operand byte
R:C460:irq_dispatch_03:Dispatch for operand ending in $03
R:C463:irq_dispatch_0B:Dispatch for operand ending in $0B
R:C4CA:irq_set_flag:Set flag in $627B table
R:C4E1:irq_clear_flag:Clear flag in $627B table
R:C4F8:irq_extended:Extended opcode handler

# System Utilities
R:C52F:clear_system_state:Clear system state variables
R:C543:clear_oam_buffer:Clear OAM buffer to $F7

# Main Game Loop
R:C890:rng_return:RNG RTS
R:C891:rng_main:Main RNG function - generates random number
R:C8A1:rng_inc_counter:Increment RNG counter at $050D
R:C8A6:rng_load_seed:Load seed from $0012 and add counter
R:C8AD:rng_shifter:RNG bit shift subroutine
R:C8CB:rng_shifter_end:RNG shifter end

# OAM Sprite System
R:C90C:wait_n_frames:Wait for X VBlank frames
R:C913:oam_wrapper:OAM shuffle wrapper (saves XY, calls shuffle)
R:C91F:oam_shuffle:Shuffle OAM sprites for flicker reduction
R:C94B:oam_shuffle_data:Sprite shuffle order table
R:C94E:oam_swap_routine:Swap sprite data between X and Y offsets

R:C968:main_loop_entry:Main game loop entry point
R:C97D:main_loop:Main game loop (infinite)
R:C983:setup_bank_trampoline:Copy bank switch code to SRAM
R:C9ED:main_frame_handler:Main frame processing handler

# Frame Handler Subroutines
R:CA17:wait_direction_key:Wait for direction key release ($14 & $04)
R:CA21:sub_CA21:Unknown processing
R:CA41:movement_processor:Process movement and tile collision
R:CA55:movement_mode_check:Check $0515 mode for movement
R:CA77:movement_main:Main movement processing
R:CB98:read_controller:Read controller input via $4016
R:CBB4:timer_update:Update timer counter ($0526 += 8)
R:D542:map_handler:Map/scroll position handler
R:E06E:movement_update:Update player position based on direction

# High ROM Utilities
R:FF00:utility_area:Utility code area
R:FF74:nmi_rng_update:NMI handler - updates RNG seed $0012
R:FF79:nmi_inc_seed:Increment RNG seed low byte
R:FF82:nmi_call_rng:Call RNG-related subroutine
R:FF8E:jump_main_init:Jump to main_init
R:FF91:bank_switch:Bank switch routine

# Reset Handler
R:FFD8:RESET_entry:RESET vector entry point
R:FFDF:mmc1_reset_trigger:MMC1 reset trigger byte

# CPU Vectors
R:FFFA:vec_NMI:NMI Vector ($0502)
R:FFFC:vec_RESET:RESET Vector ($FFD8)
R:FFFE:vec_IRQ:IRQ Vector ($C408)

# ==============================================================================
# PRG ROM - Bank 19 Battle System Code ($8000-$BFFF when loaded)
# Note: These are CPU addresses when bank 19 is in $8000-$BFFF slot
# ROM address = CPU address + $4C010 - $8000 = CPU address + $44010
# ==============================================================================

# Bank 19 Entry Points and Main Functions
R:8038:b19_battle_entry:Bank 19 battle entry point
R:804A:b19_battle_setup:Battle setup (calls 8051, 845A)
R:8051:b19_init_vars:Initialize battle variables (BRK segment)
R:805B:b19_dispatch_action:Dispatch action via jump table at $8078
R:8074:b19_action_nop:Action 0 - No action (RTS)
R:8075:b19_mode_4_jump:Mode 4 jump to $A8C6
R:8078:b19_action_table:Jump table for 8 battle actions (16 bytes)
R:8088:b19_read_tactics:Read $615B (tactics) into $6E80
R:80A1:b19_check_char_state:Check character state via $72F4,X
R:80FA:b19_clear_battle_vars:Clear $75D4-$75E7 battle variables

# Bank 19 16-bit Math Functions
R:8176:b19_mul16:16-bit left shift x4 (multiply by 16)
R:8187:b19_div16:16-bit right shift x4 (divide by 16)
R:8198:b19_scale_stat:Scale stat value by A register
R:81A5:b19_shift_ext:4-bit shift with extended precision in $19
R:8330:b19_mult_by_a:Multiply X register pair by A (stat calc)
R:8366:b19_mult_pair:Multiply pair at X by A register
R:83AA:b19_add_pairs:Add two 16-bit pairs at X and Y

# Bank 19 Division Routines
R:83C5:b19_div_16_loop:16-bit division loop (shift-subtract method)
R:83F4:b19_div_24_setup:24-bit division setup (sets up divisor)
R:8414:b19_div_24_loop:24-bit division loop
R:8454:b19_div_3byte:3-byte division helper

# Bank 19 Battle Core
R:845A:b19_battle_calc:Battle calculation wrapper (contains BRK)
R:8488:b19_unknown_8488:Unknown battle helper
R:89B6:b19_get_action_data:Get action data pointer into $79
R:89F5:b19_get_action_2:Get secondary action data
R:8A05:b19_calc_target:Calculate target selection

# Bank 19 Character Data Access
R:8D77:b19_setup_char_ptr:Set up character data pointer at $88-$89

# Bank 19 Hit/Miss and Damage
R:9110:b19_finalize_action:Finalize action (JMP target from handlers)
R:9135:b19_check_hit:Hit/miss check - compare $75DB against thresholds
R:919A:b19_hit_6:Hit check for action type < $29 (returns CMP #6)
R:91A0:b19_clear_damage:Clear $75D4-$75D5 (damage output?)
R:91A9:b19_action_codes:Action code table for special handling
R:91CD:b19_action_jmptbl:Jump table for special action handlers

# Bank 19 Party Stat Summation
R:9201:b19_get_enemy_idx:Get enemy index from $75D3 into $8B
R:9212:b19_sum_party_stats:Sum all 8 party members' stats (main calc)
R:921C:b19_party_loop:Party stat sum loop (8 iterations)
R:925F:b19_add_stat_pair:Add stat pair from ($88)+Y to tmp1-tmp2
R:9276:b19_stat_table_lookup:Look up stat in table at $B80B
R:9584:b19_setup_action:Set up action execution

# Bank 19 Action Dispatchers
R:A54D:b19_exec_action_step:Execute one action step (uses table at $A626)
R:A58D:b19_validate_action:Validate action step
R:A5AA:b19_find_target:Find valid target for action
R:A5FC:b19_check_execute:Check if action can execute
R:A61A:b19_calc_offset:Calculate offset = C * 12 (for action tables)
R:A624:b19_action_ptr_table:Pointer table for action types (8 entries)

# Bank 19 Battle State Management
R:A6C6:b19_state_setup_1:Battle state setup function 1
R:A6CA:b19_state_setup_2:Battle state setup function 2
R:A6CE:b19_state_setup_3:Battle state setup function 3
R:A6D2:b19_state_cleanup:Battle state cleanup

# Bank 19 Damage Calculation
R:AA54:b19_store_action:Store action type to $75DA
R:AA67:b19_damage_calc:Main damage calculation routine
R:AA9F:b19_apply_defense:Apply defense modifier
R:AB59:b19_check_resist:Check resistance/elemental effectiveness

# Bank 19 Action Handlers (Jump table targets from $8078)
R:AF10:b19_action_1_handler:Action 1 handler - Attack sequence
R:AF48:b19_action_4_handler:Action 4 handler - Skill/Spell
R:AF97:b19_action_2_handler:Action 2 handler - Item use
R:AFF0:b19_action_ff0:Action handler at AFF0
R:B049:b19_action_5_handler:Action 5-7 handler - Defense/Other

# Bank 19 Special Checks
R:B066:b19_chapter_check:Check if chapter == 4 ($615A)
R:B08C:b19_party_status_check:Check party member status
R:B0B4:b19_bit_rotate:Bit rotation helper
R:B0E0:b19_special_enemy:Special enemy check ($75DB == $43)
R:B132:b19_find_valid_char:Find valid character in party

# Bank 19 Data Tables
R:B74D:b19_stat_table_1:Stat modifier table 1
R:B803:b19_unknown_table:Unknown table at B803
R:B80B:b19_spell_effect_table:Spell/action effect type table (256 bytes)
R:B915:b19_spell_param_1:Spell parameter table 1
R:B949:b19_spell_param_2:Spell parameter table 2
R:B967:b19_enemy_data:Enemy resistance/type data table (256 bytes)
R:BA4E:b19_ai_table_1:AI decision table 1
R:BA6C:b19_ai_table_2:AI table 2 (4 bytes)
R:BA70:b19_ai_table_3:AI table 3 (4 bytes)
R:BA74:b19_tactics_spell_1:Tactics spell data table 1 (7*7=49 bytes)
R:BAA5:b19_tactics_spell_2:Tactics spell data table 2 (48 bytes)
R:BAD5:b19_tactics_spell_3:Tactics spell data table 3 (18 bytes)
R:BB06:b19_tactics_modifier:Tactics-based spell modifiers
R:BB22:b19_spell_bonus:Spell bonus values by tactics
R:BB3F:b19_spell_power:Spell power table (9 entries)
R:BB49:b19_spell_attribute:Spell attribute table (9 entries)
R:BB84:b19_mode_mult_table:Attack multiplier by tactics (7 entries)
R:BB8B:b19_mode_divisor:Stat multiplier by tactics (7 entries)
R:BB92:b19_hit_threshold:Hit threshold table by mode (7 entries)
R:BB99:b19_base_value:Base damage value (64)

# ==============================================================================
# Bank 19 Battle RAM Variables (Additional)
# ==============================================================================
G:75D1:battle_action_ptr:Current action pointer low
G:75D2:battle_action_type:Current action type
G:75D3:battle_target_idx:Target index (enemy or char)
G:75D9:battle_actor_idx:Acting character/enemy index
G:75DA:battle_action_cat:Action category (upper nibble)
G:75DB:battle_action_id:Action ID for hit calculation
G:75E1:battle_power_lo:Action power low byte
G:75E2:battle_power_hi:Action power high byte
G:75E5:battle_temp_e5:Temp storage E5
G:75EC:battle_rng_value:RNG value for hit check
G:75ED:battle_stat_sum_lo:Sum of party stats low byte
G:75EE:battle_stat_sum_hi:Sum of party stats high byte
G:75EF:battle_defense_mod:Defense modifier value
G:75F0:battle_flag_f0:Battle flag F0 (bit 7 cleared by dispatcher)
G:75F2:battle_special:Special battle value ($7355)

# ==============================================================================
# Bank 19 Zero Page (during battle)
# ==============================================================================
P:0079:action_data_ptr_lo:Pointer to action data (low byte)
P:007A:action_data_ptr_hi:Pointer to action data (high byte)
P:007B:calculated_hit:Calculated hit value
P:0081:party_loop_counter:Party member loop counter (7 down to 0)
P:0082:inner_loop_counter:Inner loop counter
P:0086:stat_ptr_lo:Stat table pointer low
P:0087:stat_ptr_hi:Stat table pointer high
P:0088:char_data_ptr_lo:Character data pointer low
P:0089:char_data_ptr_hi:Character data pointer high
P:008A:char_count:Character count
P:008B:actor_index:Current actor index
P:008C:action_param:Action parameter
P:0093:battle_flags:Battle calculation flags (LSR'd for tests)
P:0096:active_char_idx:Active character index for $72F4

# ==============================================================================
# Bank 19 Spell Subroutines
# ==============================================================================
R:9365:b19_get_tactics_spell_1:Get tactics spell data from $BAA5 (via sub_938B)
R:937A:b19_get_tactics_spell_2:Get tactics spell data from $BAD5 (via sub_938B)
R:938B:b19_calc_tactics_index:Calculate tactics spell index (tactics*7 + $75E8)
R:939A:b19_get_tactics_spell_3:Get tactics spell data from $BA74 (via sub_938B)
R:AEA6:b19_get_spell_power:Get spell power from $BB3F[X] (cap at 8)
R:AEAF:b19_shift_right_8c8b:Shift $8C:$8B right one bit
R:AEB4:b19_get_spell_attr:Get spell attribute from $BB49[X] (cap at 8)
R:AEC0:b19_cap_spell_index:Cap $75E8 at 8 for table lookup

# ==============================================================================
# Bank 19 Spell/Battle RAM (Additional)
# ==============================================================================
G:75E8:spell_level_index:Spell level/slot index (0-7, capped at 8)
G:6E11:spell_lookup_result:Spell table lookup result storage

# ==============================================================================
# BATTLE STATE RAM ($615A-$61FF) - Identified via Code Analysis
# ==============================================================================
# Most heavily accessed battle variables discovered through ROM analysis
G:615A:battle_actor_index:Current battle actor index (98 accesses in ROM)
G:618E:battle_state_flags:Battle state flags (65 accesses - reads/writes)
G:616A:battle_action_data:Battle action data array (indexed access - 59 uses)
G:6018:battle_status_counter:Battle status or counter (30 accesses - reads only)
G:6038:battle_flag_counter:Battle flag/counter with RMW (31 accesses)
G:6196:battle_counter_2:Battle counter variable 2 (19 accesses)
G:6195:battle_counter_1:Battle counter variable 1 (17 accesses)
G:6192:battle_output_1:Battle output/store variable 1 (15 accesses)
G:6191:battle_output_2:Battle output/store variable 2 (14 accesses)
G:6197:battle_limit_x:Battle X limit coordinate (12 accesses)
G:6198:battle_limit_y:Battle Y limit coordinate (12 accesses)
G:619B:battle_flags_2:Battle flags 2 (AND/STA operations)
G:61B1:battle_turn_counter:Battle turn counter (INC operations)
G:61DB:battle_indexed_data:Battle indexed data table
G:6165:battle_indexed_2:Battle indexed data table 2
G:6168:battle_indexed_3:Battle indexed data table 3

# ==============================================================================
# SAVE FILE REGIONS (from cowness.net)
# ==============================================================================
G:62EF:save_file_1_start:Save File 1 Start (751 bytes)
G:65DE:save_file_1_end:Save File 1 End
G:65DF:save_file_2_start:Save File 2 Start (752 bytes)
G:68CE:save_file_2_end:Save File 2 End
G:68CF:save_file_3_start:Save File 3 Start (752 bytes)
G:6BBE:save_file_3_end:Save File 3 End

# ==============================================================================
# FIXED BANK SUBROUTINES - Battle State Access
# ==============================================================================
R:CC28:fixed_read_actor_1:Read $615A (battle actor)
R:CF41:fixed_read_actor_2:Read $615A (battle actor)
R:F148:fixed_read_actor_3:Read $615A (battle actor)
R:F15D:fixed_read_actor_4:Read $615A (battle actor)
R:F164:fixed_inc_actor:Increment $615A (advance actor)
R:CCB0:fixed_set_counter_1:Store to $6195 (battle counter 1)
R:CFD7:fixed_cmp_counter_1:Compare $6195 (battle counter 1)
R:CCB8:fixed_set_counter_2:Store to $6196 (battle counter 2)
R:CFDE:fixed_cmp_counter_2:Compare $6196 (battle counter 2)
R:CC16:fixed_cmp_limit_x:Compare $6197 (battle limit X)
R:CC33:fixed_ldx_limit_x:Load X from $6197
R:CC1D:fixed_cmp_limit_y:Compare $6198 (battle limit Y)
R:CC36:fixed_ldy_limit_y:Load Y from $6198

# ==============================================================================
# FIXED BANK - MOST CALLED SUBROUTINES (from cross-reference analysis)
# ==============================================================================
# Top 50 most called subroutines in the fixed bank

R:C90C:wait_for_input:Wait for button input (118 calls)
R:C827:sub_C827:Frequently called utility (56 calls)
R:C5C5:sub_C5C5:Utility routine (48 calls)
R:C62D:sub_C62D:Utility routine (43 calls)
R:C5BF:sub_C5BF:Utility routine (42 calls)
R:C3EA:sub_C3EA:PPU/video related (37 calls)
R:C81D:sub_C81D:Utility routine (36 calls)
R:D3E6:sub_D3E6:Processing routine (35 calls)
R:C78C:sub_C78C:Utility routine (35 calls)
R:C5B9:sub_C5B9:Utility routine (34 calls)
R:D1F3:sub_D1F3:Processing routine (32 calls)
R:C813:sub_C813:Utility routine (31 calls)
R:C851:sub_C851:Text/menu related (31 calls)
R:C8EC:sub_C8EC:RNG related (30 calls)
R:C73E:sub_C73E:Utility routine (30 calls)
R:D218:sub_D218:Processing routine (29 calls)
R:C5AF:sub_C5AF:Utility routine (29 calls)
R:DDE3:text_output:Text rendering (28 calls)
R:C65A:sub_C65A:Utility routine (26 calls)
R:D20A:sub_D20A:Processing routine (24 calls)
R:C54E:sub_C54E:Clear/init routine (23 calls)
R:E771:sub_E771:Processing routine (22 calls)
R:C58F:sub_C58F:Utility routine (18 calls)
R:D214:sub_D214:Processing routine (18 calls)
R:C662:sub_C662:Utility routine (17 calls)
R:C770:sub_C770:Utility routine (16 calls)
R:D804:sub_D804:Processing routine (16 calls)
R:C8CC:sub_C8CC:RNG/random routine (15 calls)

# ==============================================================================
# Bank 18 - Level Up / EXP System Code ($8000-$BFFF when loaded)
# Addresses are CPU addresses when bank 18 is in $8000-$BFFF slot
# The EXP system uses a FORMULA-BASED calculation, not lookup tables
# ==============================================================================

# Level Check and EXP Comparison Routine ($9C22-$9C4F)
R:9C22:b18_level_check_entry:Level check routine entry
R:9C26:b18_cmp_max_level:CMP #$63 - Max level check (99 decimal)
R:9C2A:b18_load_exp_lo:LDA $6E19,X - Load calculated EXP req (low)
R:9C2D:b18_cmp_exp_lo:CMP $601A,X - Compare with party EXP (low)
R:9C30:b18_load_exp_mid:LDA $6E1A,X - Load calculated EXP req (mid)
R:9C33:b18_sbc_exp_mid:SBC $601B,X - Subtract party EXP (mid)
R:9C36:b18_load_exp_hi:LDA $6E1B,X - Load calculated EXP req (high)
R:9C39:b18_sbc_exp_hi:SBC $601C,X - Subtract party EXP (high)

# EXP Requirement Calculation Entry ($9D41-$9D6C)
R:9D41:b18_exp_calc_entry:EXP calculation routine entry
R:9D48:b18_cmp_max_level_2:CMP #$63 - Max level check (99 decimal)
R:9D54:b18_jsr_exp_calc:JSR $9F7C - Call main EXP calculation
R:9D5F:b18_sta_exp_lo:STA $6E19,X - Store EXP requirement (low byte)
R:9D62:b18_sta_exp_mid:STY $6E1A,X - Store EXP requirement (mid byte)
R:9D65:b18_sta_exp_hi:Store EXP requirement (high byte)

# Main EXP Calculation Routine ($9F7C-$9FB8)
R:9F7C:b18_exp_calc_main:Main EXP calculation subroutine
R:9F9C:b18_coeff_table_lookup:Look up character coefficient pointer

# Character EXP Coefficient Pointer Table ($A0FB-$A122)
# 8 entries × 2 bytes = 16-bit pointers to coefficient data
R:A0FB:b18_exp_coeff_ptr_table:Character EXP coefficient pointer table (8 entries)
R:A0FB:b18_exp_ptr_entry_0:Hero coefficient data pointer -> $A123
R:A0FD:b18_exp_ptr_entry_1:Cristo coefficient data pointer -> $A14B
R:A0FF:b18_exp_ptr_entry_2:Nara coefficient data pointer -> $A17B
R:A101:b18_exp_ptr_entry_3:Mara coefficient data pointer -> $A1AB
R:A103:b18_exp_ptr_entry_4:Brey coefficient data pointer -> $A1DB
R:A105:b18_exp_ptr_entry_5:Taloon coefficient data pointer -> $A20B
R:A107:b18_exp_ptr_entry_6:Entry 6 pointer -> $A1AB (shares with Mara)
R:A109:b18_exp_ptr_entry_7:Ragnar coefficient data pointer -> $A23B

# Character EXP Coefficient Data Blocks
R:A123:b18_exp_data_hero:Hero EXP coefficient data (40 bytes)
R:A14B:b18_exp_data_cristo:Cristo EXP coefficient data (48 bytes)
R:A17B:b18_exp_data_nara:Nara EXP coefficient data (48 bytes)
R:A1AB:b18_exp_data_mara:Mara/Entry6 EXP coefficient data (48 bytes)
R:A1DB:b18_exp_data_brey:Brey EXP coefficient data (48 bytes)
R:A20B:b18_exp_data_taloon:Taloon EXP coefficient data (48 bytes)
R:A23B:b18_exp_data_ragnar:Ragnar EXP coefficient data

# ==============================================================================
# EXP System RAM Variables ($6E19-$6E1B range)
# Calculated EXP requirements stored per-character (3 bytes each)
# ==============================================================================
G:6E19:exp_req_calc_lo:Calculated EXP requirement (low byte, indexed by X)
G:6E1A:exp_req_calc_mid:Calculated EXP requirement (mid byte, indexed by X)
G:6E1B:exp_req_calc_hi:Calculated EXP requirement (high byte, indexed by X)

# ==============================================================================
# Bank 19 - Battle System Deep Analysis Labels
# Addresses are CPU addresses when bank 19 is in $8000-$BFFF slot
# ==============================================================================

# Action Dispatch System
R:805B:b19_dispatch_main:Main action dispatcher - reads $6E80 mode
R:8062:b19_load_action_idx:Load action index from $75E8
R:8067:b19_lookup_jmptbl:Look up handler in jump table at $8078
R:8071:b19_indirect_jump:Execute handler via indirect jump

# Math Routines - 16-bit and 24-bit operations
R:8176:b19_mul16_shift4:16-bit left shift x4 (multiply by 16)
R:8187:b19_div16_shift4:16-bit right shift x4 (divide by 16)
R:8198:b19_scale_stat:Scale stat by A register
R:81A5:b19_shift_extended:4-bit shift with extended precision
R:8330:b19_mul16_by_a:16-bit multiply by A (shift-add method)
R:8366:b19_mul24_by_a:24-bit multiply by A (shift-add method)
R:83AA:b19_div16_setup:16-bit division setup
R:83C5:b19_div16_loop:16-bit division loop (16 iterations)
R:83F4:b19_div24_setup:24-bit division setup
R:8414:b19_div24_loop:24-bit division loop (24 iterations)

# Damage Calculation ($AA67-$AB58)
R:AA67:b19_damage_calc_main:Main damage calculation entry
R:AA6F:b19_damage_init:Initialize damage accumulators
R:AA7B:b19_damage_scale_actor:Scale by actor index x16
R:AA9F:b19_damage_divide:Divide by tactics divisor ($BB8B)
R:AAAF:b19_damage_shift_x16:Left shift result x16
R:AACF:b19_damage_add_base:Add base power component
R:AAFB:b19_damage_defense:Apply defense reduction
R:AB38:b19_damage_final:Final damage calculation
R:AB4C:b19_damage_no_defense:Skip defense (result direct copy)

# Resistance Check ($AB59-$AB91)
R:AB59:b19_resist_check_main:Resistance check entry
R:AB6A:b19_resist_load_power:Load attack power values
R:AB78:b19_resist_divide:Divide by resistance
R:AB89:b19_resist_compare:Compare against tactics threshold

# Hit/Miss Determination ($9135-$91A0)
R:9135:b19_hit_check_main:Hit/miss check main entry
R:9144:b19_hit_action_type:Check action type for hit formula
R:919A:b19_hit_standard:Standard hit check (action < $29)
R:91A0:b19_hit_clear_dmg:Clear damage output for miss

# AI Decision Making ($A8C6+)
R:A8C6:b19_ai_main_entry:AI decision making main entry (mode 4)
R:A8D5:b19_ai_init_flags:Initialize AI decision flags
R:A8E1:b19_ai_scan_targets:Scan for valid targets
R:A906:b19_ai_check_spells:Check available spells
R:A92E:b19_ai_select_action:Select best action based on tactics
R:A797:b19_ai_resist_filter:Filter actions by resistance

# Tactics System Data Tables
R:BB84:b19_tbl_attack_mult:Attack multiplier by tactics (7 entries: 10,00,10,10,10,10,10)
R:BB8B:b19_tbl_stat_divisor:Stat divisor by tactics (7 entries: 10,10,00,10,00,00,00)
R:BB92:b19_tbl_hit_threshold:Hit threshold by tactics (7 entries: 66,33,8C,01,FF,01,A0)

# Spell Data Tables
R:BB3F:b19_tbl_spell_power:Spell power table (9 entries)
R:BB49:b19_tbl_spell_attr:Spell attribute table (9 entries)
R:B80B:b19_tbl_action_effect:Action effect type table (256 bytes)
R:B915:b19_tbl_spell_param1:Spell parameter table 1
R:B949:b19_tbl_spell_param2:Spell parameter table 2

# Enemy Data Tables
R:B967:b19_tbl_enemy_resist:Enemy resistance data (256 bytes, packed bits)

# AI Tactics Spell Selection Tables
R:BA74:b19_tbl_tactics_spell1:Tactics spell priority matrix (7x7=49 bytes)
R:BAA5:b19_tbl_tactics_spell2:Tactics spell priority 2 (48 bytes)
R:BAD5:b19_tbl_tactics_spell3:Tactics spell priority 3 (18 bytes)

# Battle System RAM (Additional)
G:75E1:battle_atk_power_lo:Attack power low byte
G:75E2:battle_atk_power_hi:Attack power high byte
G:75ED:battle_party_stat_lo:Party stat sum low byte
G:75EE:battle_party_stat_hi:Party stat sum high byte
G:75EF:battle_defense_val:Defense value for damage reduction
G:75F0:battle_ai_flags:AI decision flags (bit 7 = special mode)
G:75F2:battle_spell_id:Selected spell ID
G:75F3:battle_target_mask_lo:Valid target mask low byte
G:75F4:battle_target_mask_hi:Valid target mask high byte
G:75F5:battle_spell_mask:Available spell mask

# ==============================================================================
# Bank 16 - Game Logic / Scripted Events (PRG ROM $8000-$BFFF when loaded)
# Bank 16 has 75.9% code density with 454 subroutines (most of any switchable bank)
# Contains pointer tables, scripted battle events, and game flow control
# ==============================================================================

# Bank 16 Header / Pointer Tables ($8000-$807F)
R:8000:b16_ptr_table_start:Bank 16 pointer table start (data section)
R:8030:b16_ptr_table_2:Second pointer table section
R:804A:b16_ptr_table_3:Third pointer table section

# Bank 16 Code Entry Points ($8080+)
R:8080:b16_script_entry_1:Script entry point 1 - save state, jump to $815F
R:808A:b16_script_entry_2:Script entry point 2 - similar to $8080
R:8091:b16_script_main:Main scripted event processor
R:809D:b16_get_return_addr:Get return address from stack into $79-$7A
R:80B3:b16_update_return:Update return address on stack
R:80C5:b16_script_entry_3:Script entry point 3 - saves to $6E0B
R:80D1:b16_script_entry_4:Script entry point 4
R:80EA:b16_script_continue:Continue script execution

# Bank 16 Utility Subroutines
R:8157:b16_load_ptr_helper:Load pointer from $0517 into $79
R:815F:b16_save_zp_state:Save zero page $00-$0F to stack
R:8161:b16_save_zp_loop:Zero page save loop
R:8188:b16_restore_zp:Restore zero page from stack
R:8196:b16_process_event:Process scripted event
R:8198:b16_event_loop:Event processing loop
R:81B8:b16_event_done:Event processing complete (RTS)
R:81B9:b16_battle_event:Battle event handler - checks $C000

# Bank 16 Data/State Management
R:8214:b16_copy_zp_76_78:Copy $6F-$71 to $76-$78
R:8221:b16_dispatch_handler:Dispatch to handler via jump table at $9E30
R:823E:b16_jmp_battle_event:Jump to battle event ($81B9)
R:8241:b16_check_618E:Check battle state flag $618E
R:825F:b16_check_618E_2:Second check of $618E
R:8278:b16_compare_y:Compare Y for event type selection

# Bank 16 Event Jump Table at $9E30
R:9E30:b16_event_handler_table:Event handler pointer table (indexed by $6E0B*2)

# Bank 16 Game Flow Control
R:A077:b16_game_flow:Game flow control subroutine (called from $815F dispatcher)
R:A680:b16_indirect_jump_1:Indirect jump via $0000
R:B496:b16_indirect_jump_2:Indirect jump via $0004

# Bank 16 Random Number Usage
R:AC89:b16_rng_call_1:Call RNG ($C891) for event randomization
R:ADC6:b16_rng_call_2:Second RNG call location
R:AF78:b16_rng_call_3:Third RNG call location
R:B09A:b16_rng_call_4:Fourth RNG call location
R:B0A1:b16_rng_call_5:Fifth RNG call location

# Bank 16 Text/Menu Related
R:87C5:b16_text_call_1:Call text routine $C851
R:A27D:b16_text_call_2:Second text routine call
R:A9AD:b16_text_call_3:Third text routine call

# Bank 16 RAM Variables Used
G:6E0A:b16_event_param_a:Event parameter A (used in scripted events)
G:6E0B:b16_event_param_b:Event parameter B (jump table index * 2)
G:6E0C:b16_event_counter:Event counter/index
G:6E0E:b16_event_y_save:Event Y register save
G:6BDD:b16_flag_6bdd:Script flag (bit 7 checked/set)
G:6BDE:b16_flag_6bde:Script flag 2 (saved/restored)

# ==============================================================================
# Bank 17 - Battle Display / AI System (PRG ROM $8000-$BFFF when loaded)
# Bank 17 has 68.2% code density with 450 subroutines
# Contains battle UI, message display, animations, and AI support routines
# Heavy BRK usage indicates scripted event sequences
# ==============================================================================

# Bank 17 Header / Pointer Tables ($8000-$8031)
R:8000:b17_ptr_table_start:Bank 17 pointer table (data section)
R:8022:b17_jmp_to_c49e:Jump to fixed bank $C49E

# Bank 17 Battle Initialization ($8032+)
R:8032:b17_battle_init:Battle initialization - sets $72E9 flag
R:803C:b17_store_72e9:Store battle flag to $72E9
R:8050:b17_call_b9fb:Call battle helper $B9FB
R:8053:b17_battle_loop_1:Battle loop segment 1 (BRK script)
R:8080:b17_battle_segment:Battle segment with BRK scripts
R:808B:b17_battle_segment_2:Battle segment 2
R:809B:b17_rts_quick:Quick return (RTS)
R:809C:b17_check_chapter:Check chapter number ($615A == 3?)

# Bank 17 Battle State Checks
R:80C4:b17_check_72e7:Check battle state $72E7 (bits 5-6)
R:80CD:b17_return_carry_set:Return with carry set
R:80CF:b17_init_battle_arrays:Initialize battle arrays at $72F4+

# Bank 17 Battle Actor Setup
R:80D9:b17_init_actor_loop:Initialize actor data loop ($72F4-$733C)
R:80F7:b17_call_87fb:Call helper $87FB after init
R:8108:b17_check_72e6:Check $72E6 battle flags
R:810F:b17_call_ae0a:Call $AE0A (escape check?)
R:8117:b17_return:Simple return point
R:8118:b17_continue_battle:Continue battle after escape check

# Bank 17 Battle Actor Validation
R:880A:b17_validate_actor:Validate battle actor (uses A as actor type)
R:87BB:b17_setup_actor:Set up actor for battle
R:87FB:b17_actor_helper:Actor setup helper routine

# Bank 17 Battle Display System
R:885B:b17_display_battle:Battle display main routine
R:9223:b17_display_helper:Display helper routine
R:92CF:b17_display_update:Update battle display

# Bank 17 Battle Text/Messages
R:A8EC:b17_message_system:Battle message system
R:AA4C:b17_message_display:Display battle message
R:AB2A:b17_message_continue:Continue message display

# Bank 17 AI/Enemy Actions
R:AE0A:b17_enemy_escape:Enemy escape check routine
R:B9F6:b17_ai_helper_1:AI helper routine 1
R:B9FB:b17_ai_helper_2:AI helper routine 2
R:BEB2:b17_ai_action:AI action execution

# Bank 17 RAM Variables
G:6E44:b17_battle_mode:Battle mode flag (AND #$03 compared)
G:6E45:b17_battle_type:Battle type ($BB = special)
G:6E49:b17_battle_var_49:Battle variable 49
G:6E4A:b17_battle_var_4a:Battle variable 4A
G:6E4B:b17_battle_var_4b:Battle variable 4B
G:6E4C:b17_battle_var_4c:Battle variable 4C
G:6E81:b17_event_state:Event state flag (cleared to 0)
G:72E6:b17_battle_flags_e6:Battle flags E6 (bits 4-5 checked)
G:72E7:b17_battle_flags_e7:Battle flags E7 (bits 5-6 checked)
G:72E9:b17_battle_flag_e9:Battle flag E9 (set to $00/$40/$80)
G:72F4:b17_actor_data_start:Actor data array start (12 entries)
G:7300:b17_actor_array_0:Actor array 0
G:730C:b17_actor_array_1:Actor array 1
G:7318:b17_actor_array_2:Actor array 2
G:7324:b17_actor_array_3:Actor array 3 (init to $F7)
G:7330:b17_actor_array_4:Actor array 4 (init to $F7)
G:733C:b17_actor_array_5:Actor array 5 (init to $F7)

# -- Bank 17 Map System (DataCrystal ROM Map) --
# Source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)/ROM_map
# Bank 17 also contains the map pointer and info tables used by the map loader.
# Map Pointer Table: 73 entries × 2 bytes = 146 bytes ($B08D-$B11E)
# Map Info Table: 3 bytes per entry (tileset number, map data address lo/hi)
P:5F08D:b17_map_pointer_table:Map pointer table (73 maps × 2 bytes)
# Map indices: 00=Keeleon, 01=Santeem, 02=Burland, 03=Dire Palace, 04=Endor
# 05=Gardenbur, 06=Branca, 07=Haville, 08=Gardenbur Castle, 09=Stancia
# 0A=Monbaraba, 0B=Riverton, 0C=Bazaar, 0D=Mintos, 0E=Tempe, 0F=Frenor
# 10=Aneaux, 11=Haville Cave, 12=Izmit, 13=Bonmalmo, 14=Hometown
# 15=Monbaraba Theater, 16=Lakanaba, 17=Kievs, 18=Soretta, 19=Seaside Village
# 1A=Gottside, 1B=Last Refuge, 1C=Secret Playground Entrance, 1D=Konenber Area
# ...continues to map 48
P:5F11F:b17_map_pointer_table_end:End of map pointer table
P:5F121:b17_map_info_table:Map info data (tileset#, addr_lo, addr_hi per submap)
# Map info format: [tileset_number][map_data_addr_lo][map_data_addr_hi]
# Used to determine which tileset to load and where map data is stored
P:5F4AE:b17_map_info_table_end:End of map info table

# ==============================================================================
# Bank 29 - Formation / Party Data System (PRG ROM $8000-$BFFF when loaded)
# Bank 29 has 68.7% code density with 372 subroutines
# Contains party formation, positioning, battle setup data
# First $200 bytes are data tables (graphics patterns, formation data)
# ==============================================================================

# Bank 29 Data Tables ($8000-$8095)
R:8000:b29_data_start:Bank 29 data section start
R:802B:b29_party_init:Party initialization entry (writes $0573)
R:8033:b29_slot_lookup_loop:Party slot lookup loop
R:8041:b29_compare_slot:Compare slot with $28
R:8048:b29_slot_not_found:Return - slot not found
R:8049:b29_slot_found:Slot found - process formation

# Bank 29 Formation Processing
R:8064:b29_copy_slot_data:Copy slot data from $7600 to $0574
R:8082:b29_copy_position_data:Copy position data from $80DE to $057C/$0584
R:8095:b29_formation_rts:Formation processing return
R:8096:b29_slot_table:Party slot lookup table
R:809E:b29_slot_flags:Party slot flags table
R:80A2:b29_slot_config:Party slot configuration
R:80A6:b29_slot_indices:Party slot index mapping (8 entries)
R:80DE:b29_position_table:Party position data table

# Bank 29 Graphics/Tile Data ($811E-$819D seems to be tile patterns)
R:811E:b29_tile_pattern_1:Tile pattern data 1
R:815E:b29_tile_pattern_2:Tile pattern data 2

# Bank 29 Core Subroutines
R:8660:b29_call_c0a0_1:Call fixed bank $C0A0
R:86E8:b29_call_c0a0_2:Second call to $C0A0
R:8AA6:b29_call_9f0f_1:Call $9F0F subroutine
R:8AE6:b29_call_9f0f_2:Second call to $9F0F
R:8B43:b29_call_8ce6:Call formation helper $8CE6
R:8BC5:b29_call_8d2c:Call formation helper $8D2C

# Bank 29 Formation Calculation
R:8C9A:b29_calc_formation_entry:Formation calculation entry (4 calls to $8CAC)
R:8CAC:b29_formation_helper:Formation calculation helper (called 4x)
R:8CE6:b29_formation_setup:Formation setup routine
R:8CF3:b29_rng_formation_1:RNG call for formation randomization
R:8CFA:b29_rng_formation_2:Second RNG call for formation
R:8D06:b29_formation_final:Final formation calculation
R:8D2C:b29_formation_adjust:Formation adjustment routine
R:8D56:b29_formation_adjust_2:Formation adjustment 2 (4 calls to $8CAC)

# Bank 29 Party Management
R:8D9E:b29_call_8009:Call party init at $8009
R:8DF4:b29_party_setup_main:Main party setup (calls $C5C5, $C54E, etc)
R:8EA9:b29_party_helper_1:Party setup helper 1
R:8EC4:b29_party_helper_2:Party setup helper 2
R:8E68:b29_party_helper_3:Party setup helper 3
R:8E91:b29_party_helper_4:Party setup helper 4
R:8EE0:b29_party_helper_5:Party setup helper 5

# Bank 29 Data Access Routine
R:9F0F:b29_data_access:Data table access routine (called from $8AA6, $8AE6)

# Bank 29 RAM Variables
G:0573:b29_party_slot_active:Active party slot ($0573)
G:0574:b29_party_data_buffer:Party data buffer (8 bytes, $0574-$057B)
G:057C:b29_position_y_buffer:Party Y position buffer (8 bytes, $057C-$0583)
G:0584:b29_position_x_buffer:Party X position buffer (8 bytes, $0584-$058B)
G:058D:b29_formation_flags:Formation flags
G:7600:b29_char_data_source:Character data source array (indexed by X*4)

# ==============================================================================
# Bank 22 - Menu/UI System (PRG ROM $8000-$BFFF when loaded)
# Bank 22 has 876 subroutines with 519 JSR calls and 224 JMP instructions
# Contains text input, number input, menu display, and UI state management
# Heavy use of BRK-based dispatch for text engine calls
# ==============================================================================

# Bank 22 Entry Points ($8028-$8035)
R:8028:b22_main_entry:Bank 22 main entry point (JSR $872B)
R:802B:b22_init_1:Initialize routine 1 (JSR $85C8)
R:802E:b22_init_2:Initialize routine 2 (JSR $85F9)
R:8031:b22_init_3:Initialize routine 3 (JSR $8036)
R:8035:b22_entry_return:Entry point return (SEC, RTS)

# Bank 22 Main Loop ($8036-$803E)
R:8036:b22_main_loop:Main processing loop
R:803F:b22_check_state:Check state flag $5C

# Bank 22 Character/Tile Validation ($8051-$808B)
R:8051:b22_validate_char:Validate character at $6E8A,X
R:8084:b22_set_char_6c:Set character code $6C
R:8089:b22_clear_state:Clear state variables $5D, $57

# Bank 22 Command Handler Dispatch ($8094-$80C3)
R:8094:b22_cmd_dispatch:Command dispatch based on accumulator
R:80A4:b22_cmd_table_lookup:Lookup handler in table at $80C4
R:80B2:b22_jmp_indirect:Jump indirect through $0000-$0001
R:80B5:b22_cmd_default:Default command handler
R:80C4:b22_cmd_table:Command handler jump table (25 entries)

# Bank 22 Input Processing ($810C-$8160)
R:810C:b22_input_handler_1:Input handler routine 1
R:8124:b22_input_cleanup:Input cleanup (PLA, PLA, RTS)
R:812A:b22_check_buffer:Check buffer at $0553
R:8137:b22_check_done:Check completion and return
R:8140:b22_call_83cd:Call $83CD and $81CC
R:8146:b22_compare_0551:Compare $0551 with $55
R:816D:b22_init_input:Initialize input state

# Bank 22 Text/Display Update ($8190-$81C6)
R:8190:b22_display_loop:Display update loop
R:8199:b22_update_cursor:Update cursor position
R:81B0:b22_wait_input:Wait for input (JSR $C8EC)
R:81CC:b22_process_result:Process input result

# Bank 22 Character Code Lookup ($81EA-$8212)
R:81EA:b22_char_lookup:Character code lookup ($5D AND #$0F)
R:8210:b22_char_table:Character code table
R:8212:b22_char_rts:Character lookup return

# Bank 22 Number Display ($8225-$8254)
R:8225:b22_number_init:Number display initialization
R:823C:b22_number_loop:Number digit processing loop
R:8244:b22_copy_digit:Copy digit to $0554 buffer
R:8257:b22_number_handler_2:Number handler variant 2

# Bank 22 String Buffer Management ($8336-$8355)
R:8336:b22_buffer_start:Initialize buffer index X=0
R:8338:b22_read_buffer:Read from $0554,X buffer
R:8346:b22_clear_buffer_state:Clear buffer state ($5C, $60)
R:8356:b22_get_param:Get parameter from $F9,X (increment $5B)

# Bank 22 String Copy ($835D-$836A)
R:835D:b22_copy_string:Copy string from $03E3 to $0554
R:836B:b22_store_char:Store character at $06AA,X

# Bank 22 Screen Update ($8373-$83A3)
R:8373:b22_screen_update:Screen update routine
R:8386:b22_display_char:Display character (JMP $C65A)
R:838B:b22_check_sign:Check sign at $0553
R:8393:b22_calc_position:Calculate screen position ($0551+$53, $0552+$56)

# Bank 22 Text Validation ($83A4-$83BF)
R:83A4:b22_validate_text:Validate text characters ($69, $6A, $6C, $72)
R:83C0:b22_advance_column:Advance column position

# Bank 22 Scroll/Display ($83CD-$83FA)
R:83CD:b22_scroll_start:Start scroll display
R:83D2:b22_scroll_row:Process scroll row
R:83FB:b22_draw_box:Draw UI box/border

# Bank 22 Box Drawing ($844F-$84ED)
R:844F:b22_draw_top:Draw box top border
R:848A:b22_draw_middle:Draw box middle rows
R:84B1:b22_draw_content:Draw box content row
R:84C4:b22_draw_bottom:Draw box bottom border
R:84EE:b22_draw_box_alt:Alternative box drawing (shifted +3)

# Bank 22 Number Input System ($9FB6-$A0CF)
R:9FB6:b22_num_input_init:Number input initialization ($03DD=#$60)
R:9FBB:b22_num_input_short:Short number input ($03DD=#$20)
R:9FBD:b22_num_store_limit:Store input limit to $03DD, $03CF
R:9FD8:b22_num_input_loop:Number input main loop
R:A004:b22_num_check_confirm:Check confirm button (code #$01)
R:A020:b22_num_check_cancel:Check cancel button (code #$02)
R:A032:b22_num_check_select:Check select (bit check $03CC)
R:A04D:b22_num_check_up:Check up button (code #$05)
R:A067:b22_num_check_down:Check down button (code #$06)
R:A07C:b22_num_check_left:Check left button (code #$07)
R:A0AC:b22_num_check_right:Check right button (code #$08)
R:A0D0:b22_num_update_digit:Update current digit

# Bank 22 Text Input System ($A0E8-$A150)
R:A0E8:b22_text_input_init:Text input initialization
R:A0F7:b22_text_setup:Text input setup
R:A102:b22_text_load_table:Load character table from $A151,X
R:A130:b22_text_input_loop:Text input main loop
R:A151:b22_text_table:Text input lookup table

# Bank 22 Text Input Handlers ($A15A-$A212)
R:A15A:b22_text_check_confirm:Text confirm handler
R:A163:b22_text_call_a362:Call text helper $A362
R:A175:b22_text_backspace:Handle backspace
R:A1A1:b22_text_toggle:Handle toggle selection
R:A1C1:b22_text_input_char:Input new character
R:A1E6:b22_text_shift_buffer:Shift buffer contents

# Bank 22 Helper Routines ($A362+)
R:A362:b22_text_helper_1:Text input helper 1
R:A391:b22_text_helper_2:Text input helper 2
R:A397:b22_text_helper_3:Text input helper 3

# Bank 22 Numeric Display ($B24F-$B341)
R:B24F:b22_display_number:Display number routine
R:B275:b22_digit_offset_table:Digit offset lookup table
R:B278:b22_display_stat:Display stat value
R:B29D:b22_display_error:Display error indicator
R:B2A3:b22_count_table:Count lookup table
R:B2DA:b22_count_check:Count validation check
R:B303:b22_count_fail:Count validation failure
R:B307:b22_display_value:Display numeric value
R:B337:b22_load_pointer:Load pointer from $07B5-$07B6
R:B342:b22_display_formatted:Display formatted value

# Bank 22 RAM Variables Used
G:03CA:b22_cursor_char:Cursor character code
G:03CC:b22_input_code:Input button code
G:03CF:b22_cursor_y:Cursor Y position
G:03DC:b22_digit_index:Current digit index
G:03DD:b22_input_limit:Input digit limit
G:03DB:b22_current_digit:Current digit value (0-9)
G:03E3:b22_input_buffer:Input buffer (8 bytes, $03E3-$03EA)
G:03FF:b22_buffer_index:Buffer write index
G:0551:b22_column_pos:Column position in text
G:0552:b22_row_pos:Row position in text
G:0553:b22_display_mode:Display mode flags
G:0554:b22_text_buffer:Text output buffer (variable length)
G:06AA:b22_char_output:Character output buffer

# ==============================================================================
# Bank 15 - System Core / NMI / PPU / MMC1 (PRG ROM $8000-$BFFF when loaded)
# Bank 15 has 564 subroutines with 555 JSR calls and 221 JMP instructions
# This is the core system bank containing:
# - NMI handler and VBlank processing
# - PPU buffer upload system
# - OAM DMA and sprite handling
# - MMC1 mapper register control
# - Bank switching infrastructure
# - BRK instruction handler
# - System initialization and reset
# ==============================================================================

# Bank 15 Jump Table ($8000-$803C)
R:8000:b15_jmp_table:Bank 15 jump table start ($FF then JMP vectors)
R:8001:b15_jmp_e9ce:JMP to $E9CE vector
R:8004:b15_jmp_e54b:JMP to $E54B vector
R:8007:b15_jmp_f1ab:JMP to $F1AB vector
R:800A:b15_jmp_efdb:JMP to $EFDB vector
R:800D:b15_jmp_efd7:JMP to $EFD7 vector
R:8010:b15_jmp_f1fa:JMP to $F1FA vector
R:8013:b15_jmp_f223:JMP to $F223 vector
R:8016:b15_jmp_e944:JMP to $E944 vector
R:802E:b15_jmp_f4ab:JMP to $F4AB vector
R:8031:b15_jmp_f58a:JMP to $F58A vector
R:8034:b15_jmp_f58b:JMP to $F58B vector
R:8037:b15_jmp_fabe:JMP to $FABE vector

# Bank 15 Reset/Init Sequence ($803D-$80CF)
R:803D:b15_reset_entry:Reset entry point (CLD)
R:803E:b15_wait_vbl_1:Wait for VBlank 1
R:8043:b15_wait_vbl_2:Wait for VBlank 2
R:804E:b15_ppu_init:PPU initialization (PPUCTRL=#$10)
R:8058:b15_mapper_init:MMC1 mapper reset (5x STA $FFFF)
R:8067:b15_nmi_setup:Setup NMI JMP vector at $0502
R:8078:b15_stack_init:Initialize stack pointer (LDX #$FF, TXS)
R:807E:b15_ram_clear:Clear RAM ($00-$FF, $0300-$07FF)
R:8092:b15_config_init:Initialize config ($0500=#$0E, $0501=#$10)
R:809E:b15_ppu_setup:PPU final setup
R:80BE:b15_post_init:Post-initialization (JSR $C569, $C543, $FF74)
R:80CF:b15_start_game:Jump to main game loop ($C968)

# Bank 15 VBlank Wait Utilities ($80D6-$80E8)
R:80D6:b15_vbl_wait_util:VBlank wait utility (JSR $FB10)
R:80D9:b15_wait_not_vbl:Wait for NOT VBlank
R:80DE:b15_wait_is_vbl:Wait for VBlank
R:80E3:b15_wait_not_vbl_2:Wait for NOT VBlank (exit condition)

# Bank 15 Soft Reset ($80E9-$8103)
R:80E9:b15_soft_reset:Soft reset (NMI=#$40, mapper reset)
R:8101:b15_soft_reset_jmp:Jump to $C101 after soft reset

# Bank 15 Mapper/Bank Control ($8104-$8159)
R:8104:b15_inc_mapper:Increment mapper $FFDF
R:8118:b15_write_9fff:Write MMC1 control register ($9FFF)
R:812F:b15_write_bfff:Write MMC1 CHR bank 0 ($BFFF)
R:8146:b15_write_dfff:Write MMC1 CHR bank 1 ($DFFF)

# Bank 15 NMI Handler ($815A-$8218)
R:815A:b15_nmi_entry:NMI handler entry (PHA, TXA, PHA, TYA, PHA)
R:815F:b15_nmi_check_busy:Check if system busy ($1F bit 7)
R:8163:b15_nmi_stack_check:Check stack for valid return
R:8175:b15_nmi_ppu_update:PPU update during NMI
R:8181:b15_nmi_range_check:Check return address range
R:819B:b15_nmi_skip_check:Check NMI skip flag ($0519)
R:81B0:b15_nmi_bank_switch:Bank switch during NMI ($FF91)
R:81BD:b15_nmi_stack_fixup:Stack fixup for return address
R:81EF:b15_nmi_inc_counter:Increment $050C counter
R:8213:b15_nmi_exit_normal:Normal NMI exit (PLA, TAY, PLA, TAX, PLA, RTI)
R:8219:b15_nmi_exit_brk:NMI exit to BRK handler

# Bank 15 PPU Buffer Upload ($8222-$8296)
R:8222:b15_ppu_check_flags:Check state flags for PPU update
R:823A:b15_ppu_buffer_start:Start PPU buffer upload
R:8241:b15_ppu_buffer_loop:PPU buffer upload loop
R:825C:b15_ppu_write_addr:Write PPU address
R:8267:b15_ppu_write_data:Write PPU data bytes
R:8276:b15_ppu_palette:Handle palette update ($3F00)
R:8296:b15_ppu_buffer_done:PPU buffer upload complete

# Bank 15 PPU 9-byte Block Upload ($8297-$82E9)
R:8297:b15_ppu_block_start:9-byte block upload start
R:8299:b15_ppu_block_loop:9-byte block upload loop
R:82E7:b15_ppu_block_done:Block upload done, JMP $C276

# Bank 15 PPU Register Update ($82EA-$8302)
R:82EA:b15_ppu_regs_update:Update PPU control registers
R:82F6:b15_ppu_scroll_set:Set scroll registers ($2005)

# Bank 15 OAM DMA ($8303-$8314)
R:8303:b15_oam_check:Check OAM update needed
R:830F:b15_oam_dma:Perform OAM DMA ($4014=#$02)

# Bank 15 Nametable Clear ($8315-$837A)
R:8315:b15_nt_clear_start:Nametable clear start
R:8318:b15_nt_clear_loop:Nametable clear loop
R:837B:b15_nt_addr_table:Nametable address table data

# Bank 15 Inter-Bank Call System ($838B-$83E9)
R:838B:b15_bank_call_entry:Bank call entry (STA $20, STX $21)
R:839A:b15_bank_call_setup:Setup bank call (JSR $C3BA)
R:83A6:b15_bank_call_exec:Execute bank call (JSR $0023)
R:83B0:b15_bank_call_restore:Restore bank after call
R:83BA:b15_bank_lookup:Bank lookup from table
R:83CE:b15_bank_ptr_get:Get pointer for bank call
R:83EA:b15_bank_indirect:Indirect bank call

# Bank 15 BRK Handler ($8408-$84F7)
R:8408:b15_brk_entry:BRK handler entry (SEI, PHP)
R:8413:b15_brk_get_pc:Get BRK program counter from stack
R:8423:b15_brk_decode:Decode BRK operand byte
R:8432:b15_brk_dispatch:Dispatch based on operand type
R:8451:b15_brk_indirect:Handle indirect BRK call
R:8460:b15_brk_special_03:Handle opcode $x3 variant
R:8463:b15_brk_check_cb:Check for $CB-$FA range
R:8484:b15_brk_bank_16:Dispatch to Bank 16 ($CB-$CA)
R:84A1:b15_brk_advance_pc:Advance PC past BRK operand
R:84B6:b15_brk_flag_test:Test event flag ($627B,X)
R:84CA:b15_brk_flag_set:Set event flag (OR)
R:84E1:b15_brk_flag_clear:Clear event flag (AND)
R:84F8:b15_brk_special:Special BRK handling

# Bank 15 System State ($852F-$8542)
R:852F:b15_clear_state:Clear system state ($1F, $050A-$0513)

# Bank 15 OAM Clear ($8543-$854D)
R:8543:b15_oam_clear:Clear OAM buffer ($0200, #$F7)

# Bank 15 Screen Control ($854E-$85B8)
R:854E:b15_screen_on_full:Full screen on sequence
R:8569:b15_clear_ppu_buffer:Clear PPU buffer ($0400)
R:8575:b15_clear_nametable:Clear nametable ($2000)
R:858F:b15_screen_on:Turn screen on
R:8596:b15_screen_wait_vbl:Wait for VBlank then enable
R:85A8:b15_busy_clear:Clear busy flag ($1F AND #$7F)
R:85AF:b15_screen_off:Turn screen off (set busy)

# Bank 15 PPU/Hardware Registers Used
P:2000:PPUCTRL:PPU Control Register
P:2001:PPUMASK:PPU Mask Register
P:2002:PPUSTATUS:PPU Status Register
P:2005:PPUSCROLL:PPU Scroll Position
P:2006:PPUADDR:PPU Address Register
P:2007:PPUDATA:PPU Data Port
P:4014:OAMDMA:OAM DMA Register

# Bank 15 MMC1 Mapper Registers
P:9FFF:MMC1_CONTROL:MMC1 Control Register
P:BFFF:MMC1_CHR_BANK0:MMC1 CHR Bank 0
P:DFFF:MMC1_CHR_BANK1:MMC1 CHR Bank 1
P:FFFF:MMC1_PRG_BANK:MMC1 PRG Bank Select

# ==============================================================================
# Bank 30 - NPC/Sprite/Map Event System (PRG ROM $8000-$BFFF when loaded)
# Bank 30 has 863 subroutines with 633 JSR calls (highest of switchable banks)
# Contains NPC movement, sprite handling, map events, player interaction
# Uses $6F40-$6FE0 for NPC/sprite tables, $7000-$71FF for object state
# Heavy BRK-based dispatch for event scripting
# ==============================================================================

# Bank 30 Data Tables ($8000-$8093)
R:8000:b30_data_start:Bank 30 data section start (event pointers)
R:8094:b30_code_start:Bank 30 code section start

# Bank 30 Event Dispatch ($8094-$80A6)
R:8094:b30_event_entry:Event handler entry point
R:8096:b30_event_dispatch:Event dispatch (BRK $07, $6F)
R:809C:b30_event_table_lookup:Lookup in event table at $80AA
R:80A7:b30_event_fallback:Fallback to $D1F3
R:80AA:b30_event_table:Event handler jump table

# Bank 30 Player/NPC Interaction ($80BA-$80F8)
R:80BA:b30_check_player:Check player interaction flag ($41 bit 4)
R:80BE:b30_npc_init:NPC interaction initialization
R:80CA:b30_rng_check:RNG check for NPC (JSR $D3E6)
R:80E2:b30_npc_direction:Set NPC direction
R:80EA:b30_event_trigger:Trigger map event (JSR $BAEA)
R:80F2:b30_return_fail:Return with failure code ($F0)

# Bank 30 NPC Search ($80F9-$8145)
R:80F9:b30_store_npc_index:Store NPC index to $059C
R:8101:b30_update_npc_state:Update NPC state at $7000,X
R:8117:b30_save_state:Save state (JSR $D7FC, $FF74)
R:8126:b30_find_npc:Find NPC in $7020 table
R:8128:b30_find_npc_loop:NPC search loop ($7020-$7040)
R:8142:b30_not_found:NPC not found (CLC, RTS)
R:8144:b30_found:NPC found (SEC, RTS)

# Bank 30 Map/Location Check ($8146-$819D)
R:8146:b30_location_check:Location check routine
R:814C:b30_loc_table_search:Search location table at $819E
R:8165:b30_loc_check_flags:Check location flags at $62ED
R:8178:b30_loc_copy_state:Copy location state from $6FE0
R:818F:b30_loc_next_entry:Advance to next table entry (+5)
R:819E:b30_loc_table:Location lookup table data

# Bank 30 Position Helpers ($81AE-$81CC)
R:81AE:b30_get_player_pos:Get player position from $6F60/$6F80
R:81B8:b30_adjust_position:Adjust position by direction

# Bank 30 Event Scripts ($81CD-$823D)
R:81CD:b30_event_script_1:Event script handler 1
R:81D8:b30_check_event_ff:Check for event code $FF
R:81E9:b30_store_event:Store event to $07B9
R:81FF:b30_call_c8cc:Call text routine $C8CC
R:821F:b30_event_branch:Event branch based on value

# Bank 30 Wagon/Party Movement ($84BD-$8576)
R:84BD:b30_wagon_check:Wagon state check
R:84C4:b30_wagon_flags:Set wagon flags ($0531-$0533)
R:84CC:b30_wagon_init:Initialize wagon state
R:84F3:b30_party_walk_calc:Calculate party walking speed
R:8500:b30_walk_loop_start:Walking animation loop
R:8524:b30_walk_shift:Shift walk counter
R:852A:b30_walk_frame_loop:Walk frame loop
R:8547:b30_walk_speed_calc:Calculate walk speed by $058E

# Bank 30 NPC Animation ($854E-$8576)
R:854E:b30_npc_animate_full:Full NPC animation sequence
R:855A:b30_npc_animate_calc:Calculate NPC animation
R:856E:b30_npc_set_visible:Set NPC visible ($7020,X |= $80)

# Bank 30 Map Transition ($8577-$85A3)
R:8577:b30_map_transition:Map transition handler
R:8587:b30_transition_animate:Animate during transition
R:8597:b30_transition_complete:Complete transition

# Bank 30 Sprite Update ($85A4-$8675)
R:85A4:b30_sprite_update:Update sprite data at $7007-$7009
R:85DF:b30_sprite_setup:Sprite setup (LDX #$09, JSR $D804)
R:85EC:b30_sprite_loop:Sprite animation loop
R:8606:b30_sprite_clear_flags:Clear sprite flags ($7007,X AND #$7F)
R:861E:b30_sprite_full_update:Full sprite update sequence

# Bank 30 Map Position ($8700-$8726)
R:8700:b30_map_pos_init:Initialize map position (JSR $894A)
R:8706:b30_check_map_45:Check for map $45
R:871E:b30_toggle_map_flag:Toggle map flag at $62AA

# Bank 30 Party Setup ($8726-$876A)
R:8726:b30_party_setup:Party setup routine
R:8729:b30_party_init_call:Initialize party (JSR $8A0D)
R:8733:b30_party_state:Update party state at $7000

# Bank 30 Animation Helpers ($86DD-$86FF)
R:86DD:b30_animate_helper:Animation helper (E06E, D7D5, CBB4)
R:86E6:b30_animate_speed:Calculate animation speed

# Bank 30 NPC Data Structures
G:6F40:b30_npc_type:NPC type array (32 entries)
G:6F60:b30_npc_x_pos:NPC X position array (32 entries)
G:6F80:b30_npc_y_pos:NPC Y position array (32 entries)
G:6FE0:b30_npc_state:NPC state array (32 entries)
G:6FE9:b30_sprite_counter:Sprite update counter
G:7000:b30_object_flags:Object flags array
G:7007:b30_follower_state_0:Follower 0 state
G:7008:b30_follower_state_1:Follower 1 state
G:7009:b30_follower_state_2:Follower 2 state
G:7020:b30_active_npcs:Active NPC indices (32 entries)
G:7029:b30_npc_visibility:NPC visibility flags
G:70E0:b30_npc_flags:NPC processing flags (32 entries)
G:7169:b30_party_visibility:Party visibility flag

# Bank 30 Map Variables
G:0515:b30_transition_mode:Map transition mode
G:0531:b30_wagon_flag_1:Wagon state flag 1
G:0532:b30_wagon_flag_2:Wagon state flag 2
G:0533:b30_wagon_flag_3:Wagon state flag 3
G:058E:b30_party_speed:Party movement speed
G:058F:b30_walk_toggle:Walking animation toggle
G:0597:b30_transition_state:Transition state flag
G:059C:b30_current_npc:Current NPC index
G:060A:b30_sprite_index:Current sprite index
G:62A5:b30_chapter_flags:Chapter state flags
G:62AA:b30_map_toggle:Map toggle state
G:62ED:b30_event_state:Event state flag ($78 = chapter boundary)
G:6F87:b30_party_x_pos:Party X position
G:6F88:b30_party_y_pos:Party Y position
G:6FC7:b30_saved_x:Saved X position
G:6FC8:b30_saved_y:Saved Y position

# ==============================================================================
# Bank 20 - Shop/Merchant System (PRG ROM $8000-$BFFF when loaded)
# Bank 20 has 793 subroutines with 628 JSR calls
# Contains shop menus, item buying/selling, price calculations
# Uses $6E45-$6E49 for shop inventory, $0440 for item slots
# ==============================================================================

# Bank 20 Data/Initialization ($8000-$8037)
R:8000:b20_entry:Bank 20 shop entry point
R:8038:b20_init_loop:Shop initialization loop (JSR $8211)
R:803F:b20_clear_buffers:Clear shop buffers (JSR $C5AF)
R:8046:b20_clear_06a0:Clear $06A0-$06A7 buffer
R:804E:b20_clear_05fc:Clear $05FC-$0615 buffer

# Bank 20 Shop Setup ($805A-$808B)
R:805A:b20_clear_state:Clear shop state ($CA, $C9)
R:8062:b20_clear_6e49:Clear item count buffer ($6E49-$6E4C)
R:806A:b20_clear_0444:Clear $0444-$044B buffer
R:8072:b20_load_inventory:Load shop inventory loop
R:808B:b20_process_items:Process shop items loop

# Bank 20 Special Item Check ($8092-$80AD)
R:8092:b20_check_special:Check for special item $99
R:809E:b20_set_special:Set special shop values ($0600-$0602)
R:80AD:b20_store_item:Store item code to $C4

# Bank 20 Item Validation ($80B2-$80E4)
R:80B2:b20_validate_item:Validate shop item
R:80B9:b20_call_9f0c:Call item lookup $9F0C
R:80BC:b20_call_92ef:Call price calc $92EF
R:80BF:b20_call_9c54:Call item check $9C54
R:80C2:b20_call_9496:Call item display $9496
R:80E1:b20_call_946e:Call item helper $946E

# Bank 20 Inventory Management ($80EE-$812C)
R:80EE:b20_inventory_loop:Inventory processing loop
R:8103:b20_call_9ed1:Call display $9ED1
R:8106:b20_call_93d2:Call stats $93D2
R:8109:b20_call_9e7f:Call refresh $9E7F
R:8111:b20_check_7392:Check item at $7392,X
R:8126:b20_finalize:Finalize shop display (JSR $9C71)

# Bank 20 Shop Interaction ($812F-$81CC)
R:812F:b20_shop_main:Main shop interaction entry
R:8135:b20_call_9292:Call $9292
R:8138:b20_call_926b:Call $926B
R:8141:b20_item_loop:Item selection loop
R:8162:b20_check_buy:Check if can buy (JSR $9ADD)
R:8167:b20_check_sell:Check if can sell (JSR $9C4A)
R:816C:b20_check_price:Check price (JSR $9439)
R:8171:b20_check_equip:Check equipment (JSR $93F2)
R:817A:b20_check_type:Check item type (JSR $9682)
R:817F:b20_check_valid:Final validation (JSR $9686)
R:8184:b20_complete_buy:Complete purchase
R:8198:b20_store_purchase:Store purchased item
R:81A4:b20_update_count:Update item count

# Bank 20 Item Removal ($81F4-$8210)
R:81F4:b20_remove_item:Remove item from inventory
R:8205:b20_clear_slot:Clear last slot

# Bank 20 Display Update ($8211-$822F)
R:8211:b20_update_display:Update shop display
R:8220:b20_alt_display:Alternative display update
R:822F:b20_display_main:Main display routine

# Bank 20 Special Displays ($8237-$82CB)
R:8237:b20_check_ae:Check for special item $AE
R:823E:b20_ae_display:Display special item $AE sequence
R:8263:b20_normal_display:Normal item display
R:8277:b20_check_bc:Check for special item $BC
R:827E:b20_ppu_setup:Setup PPU for display
R:82CC:b20_call_9a40:Call display helper $9A40

# Bank 20 OAM Clear ($81CF-$81F3)
R:81CF:b20_oam_clear:Clear OAM buffer ($F7 pattern)
R:81DE:b20_oam_dma:Trigger OAM DMA ($4014)
R:81E8:b20_sprite_loop:Sprite update loop

# Bank 20 Shop Variables
G:00C4:b20_current_item:Current item code
G:00C5:b20_item_count:Current item count
G:00C6:b20_slot_index:Current slot index (0-3)
G:00C7:b20_display_index:Display index (0-7)
G:00C9:b20_price_lo:Price accumulator low
G:00CA:b20_price_hi:Price accumulator high
G:0440:b20_item_slots:Shop item slots (4 bytes)
G:0444:b20_item_counts:Shop item counts (8 bytes)
G:0600:b20_special_data_0:Special shop data 0
G:0601:b20_special_data_1:Special shop data 1
G:0602:b20_special_data_2:Special shop data 2
G:0690:b20_display_buffer:Display buffer (indexed by $C7)
G:06A0:b20_price_buffer:Price display buffer (8 bytes)

# ==============================================================================
# BANK 21 ($8000-$BFFF) - Event Script System / Bytecode Interpreter
# ==============================================================================

# Data Tables at Start (first ~8KB is text/event data)
# Event scripts start with BRK opcodes as bytecode commands

# -- Script Flow Control Routines ($A4xx) --
P:A47C:b21_event_process_gold:Process gold for event
P:A489:b21_setup_npc_return:Setup NPC and return
P:A48C:b21_npc_dialog_end:NPC dialog end routine
P:A495:b21_npc_dialog_start:NPC dialog start routine
P:A49E:b21_set_npc_sprite_11:Set NPC sprite to $11
P:A4B6:b21_execute_bytecode_07DF:Execute bytecode $07DF
P:A4BA:b21_run_event_with_cc:Run event with C8CC routine
P:A4C9:b21_call_fixed_bank:Call fixed bank routine via B7B5
P:A4F0:b21_check_item_77:Check if player has item $77

# -- Script Branching Routines ($A5xx) --
P:A501:b21_loop_until_clear:Loop until condition clear
P:A504:b21_wait_loop:Wait loop (check 9AC9)
P:A50F:b21_dialog_with_cb04:Dialog routine with $CB04
P:A521:b21_conditional_dialog:Conditional dialog routine
P:A52C:b21_slot_5_handler:Handler for slot 5 item
P:A573:b21_validate_item_count:Validate item count
P:A582:b21_item_price_calc:Calculate item price
P:A59F:b21_get_item_price:Get item price routine
P:A5A2:b21_store_price_result:Store price calculation result
P:A5BE:b21_price_display_4B33:Price display via $4B33
P:A5CF:b21_continue_or_exit:Continue or exit selection
P:A5E1:b21_exit_to_64C:Exit to $A64C
P:A5E4:b21_calc_high_level_price:Calculate high level price
P:A5FA:b21_calc_standard_price:Calculate standard item price

# -- Script Result Handlers ($A6xx) --
P:A60D:b21_shift_price_6bits:Shift price right 6 bits
P:A614:b21_price_shift_loop:Price shift loop
P:A62B:b21_return_from_shift:Return from shift routine
P:A62C:b21_set_fixed_price:Set fixed price ($EA60)
P:A650:b21_set_result_06:Set result to $06
P:A654:b21_set_result_05:Set result to $05
P:A658:b21_set_result_04:Set result to $04
P:A65C:b21_set_result_03:Set result to $03
P:A660:b21_set_result_02:Set result to $02
P:A664:b21_set_result_00:Set result to $00
P:A668:b21_set_result_01:Set result to $01
P:A66A:b21_set_custom_result:Set custom result from A
P:A673:b21_branch_to_result:Branch to result handler
P:A676:b21_jump_to_9919:Jump to $9919

# -- NPC/Map Setup Routines ($A6xx-$A7xx) --
P:A679:b21_npc_position_setup:NPC position setup (44=$0E, 45=$05)
P:A689:b21_store_direction:Store direction in $DD
P:A694:b21_check_map_location:Check map 19:01 for special event
P:A6A3:b21_call_bc_a6b7:Call $A6BC then $A6B7
P:A6A6:b21_call_a6b7_only:Call $A6B7 only
P:A6A9:b21_load_npc_and_enter:Load NPC and enter map
P:A6B7:b21_call_bank_07:Call bank via $07 + B7B5
P:A6BC:b21_push_dd_call_aea6:Push $DD and call $AEA6
P:A6C5:b21_save_da_range:Save $DA-$E9 to stack

# -- Script Name/Text Handlers ($A7xx) --
P:A732:b21_unknown_a732:Unknown routine at $A732
P:A738:b21_unknown_a738:Unknown routine at $A738
P:A769:b21_check_flag:Check game flag routine
P:A774:b21_set_flag:Set game flag routine

# -- Script Parsing Routines ($99xx-$9Axx) --
P:9914:b21_add_5_to_x:Add 5 to X register
P:9919:b21_event_dispatch:Main event bytecode dispatch
P:9925:b21_init_event_vars:Initialize event variables
P:9956:b21_clear_f9_fb:Clear $F9-$FB via $46EF
P:9962:b21_check_event_range:Check event range and handle
P:9972:b21_call_b7fb_continue:Call B7FB and continue
P:999E:b21_calc_event_offset:Calculate event offset from $00/$01
P:99A9:b21_lookup_event_table:Lookup in event table at $98F6
P:99CE:b21_read_script_byte:Read script byte at ($DA),Y
P:99D6:b21_set_dc_ff:Set $DC to $FF
P:99D8:b21_store_dc:Store to $DC
P:99E7:b21_cmd_02_handler:Command $02 handler (call $9A93)
P:99F1:b21_cmd_1e_handler:Command $1E handler (call $9AC3)
P:99FB:b21_cmd_05_handler:Command $05 handler (call $9AC9)
P:9A05:b21_cmd_13_handler:Command $13 handler (call $9AD1)
P:9A0F:b21_cmd_03_handler:Command $03 handler (call $9AF5)
P:9A19:b21_cmd_14_handler:Command $14 handler (call $9B09)
P:9A23:b21_cmd_16_handler:Command $16 handler (call $9B10)
P:9A2D:b21_cmd_1b_handler:Command $1B handler (call $9A96)
P:9A37:b21_cmd_1c_handler:Command $1C handler (call $9AA3)
P:9A41:b21_cmd_1a_handler:Command $1A handler (call $9AB0)
P:9A4C:b21_check_dc_result:Check $DC result and branch
P:9A5A:b21_true_branch:True branch (DC=0, result!=0)
P:9A6A:b21_false_branch:False branch
P:9A7B:b21_check_cmd_06:Check for command $06
P:9A8C:b21_cmd_11_impl:Command $11 implementation (check flag)
P:9A93:b21_cmd_02_impl:Command $02 - return $E9
P:9A96:b21_cmd_1b_impl:Command $1B - AND flag check
P:9AA3:b21_cmd_1c_impl:Command $1C - ORA flag check
P:9AB0:b21_cmd_1a_impl:Command $1A - CMP flag check
P:9ABF:b21_return_00:Return $00 (false)
P:9ABB:b21_return_ff:Return $FF (true)
P:9AC3:b21_cmd_1e_impl:Command $1E - get value via $2973
P:9AC9:b21_check_party_status:Check party status via B7B5 $48
P:9AD1:b21_cmd_13_impl:Command $13 - character slot lookup
P:9AD4:b21_slot_range_check:Slot range check
P:9AEF:b21_branch_point:Script branch point

# -- Party Member Routines ($9Bxx-$9Cxx) --
P:9B09:b21_cmd_14_impl:Command $14 implementation
P:9B10:b21_cmd_16_impl:Command $16 implementation
P:9B1D:b21_unknown_9b1d:Unknown routine at $9B1D
P:9BA8:b21_script_advance:Advance script pointer

# -- Map Event Routines ($9Cxx-$9Exx) --
P:9C92:b21_unknown_9c92:Unknown routine at $9C92
P:9CBF:b21_unknown_9cbf:Unknown routine at $9CBF
P:9CE5:b21_check_special_cond:Check special condition
P:9E72:b21_set_npc_dir_03:Set NPC direction to $03
P:9E82:b21_item_74_check:Check for item $74
P:9E98:b21_item_74_return:Return from item 74 check
P:9E99:b21_gold_accumulator:Gold accumulator routine
P:9EC8:b21_next_char_loop:Next character loop
P:9ED5:b21_recruitment_handler:Recruitment handler
P:9EF3:b21_find_party_slot:Find party slot routine
P:9F34:b21_branch_9f34:Script branch at $9F34
P:9F45:b21_branch_9f45:Script branch at $9F45
P:9F48:b21_jmp_9f34:Jump to $9F34
P:9F4B:b21_branch_9f4b:Script branch at $9F4B
P:9F4E:b21_check_and_process:Check and process routine
P:9F6B:b21_branch_9f6b:Script branch at $9F6B
P:9F6E:b21_clear_e7_return:Clear $E7 and return
P:9F73:b21_branch_9f73:Script branch at $9F73
P:9F79:b21_inc_counters:Increment $628C/$628D counters
P:9F90:b21_party_member_loop:Party member loop
P:9FD5:b21_return_9fd5:Return from party loop

# -- Text/Dialog Routines ($A0xx-$A1xx) --
P:A00D:b21_set_result_01_jmp:Set result 01 and jump
P:A016:b21_call_664_then_9ac9:Call $A664 then $9AC9
P:A02B:b21_fixed_gold_display:Fixed gold amount display
P:A04C:b21_clear_e7_return2:Clear $E7 and return
P:A051:b21_item_6d_handler:Item $6D handler
P:A068:b21_call_b0ae_a495:Call $B0AE then $A495
P:A06E:b21_char_level_calc:Character level calculation
P:A0A2:b21_dialog_with_push:Dialog routine with E0/E1 push
P:A0C3:b21_loop_9ac9_check:Loop checking $9AC9
P:A0CE:b21_post_loop_handler:Post loop handler
P:A0FF:b21_setup_menu_82:Setup menu with $82

# -- NPC Movement/Positioning ($AExx-$AFxx) --
P:AE58:b21_pop_e0_e1_call:Pop E0/E1 and call $A668
P:AE61:b21_push_regs_continue:Push regs and continue
P:AE98:b21_set_00_branch:Set $00 and branch
P:AEA6:b21_setup_npc_data:Setup NPC data from $62xx
P:AEAE:b21_loop_inc_data:Loop and increment data
P:AEBB:b21_return_aebc:Return from data loop
P:AEBC:b21_clear_f9_fb_2:Clear F9/FA/FB to $00
P:AEC7:b21_jmp_a664:Jump to $A664
P:AECA:b21_call_b067:Call $B067 and loop
P:AED0:b21_check_eb04:Check $EB04 result
P:AEE4:b21_jmp_a660:Jump to $A660
P:AEE7:b21_store_x_to_f9:Store X to $F9
P:AEE9:b21_jmp_a668:Jump to $A668
P:AEEC:b21_call_a65c:Call $A65C
P:AEFD:b21_jmp_a658:Jump to $A658
P:AF00:b21_item_5b_handler:Item $5B handler
P:AF20:b21_branch_af20:Script branch at $AF20
P:AF24:b21_check_62a4:Check $62A4 high nibble
P:AF36:b21_call_a660:Call $A660
P:AF39:b21_call_a65c_2:Call $A65C (2)
P:AF6B:b21_jmp_b0d7:Jump to $B0D7
P:AF72:b21_party_swap:Party swap routine
P:AF80:b21_swap_loop:Swap loop
P:AFA5:b21_swap_complete:Swap complete, call $A664
P:AFAC:b21_msg_2e_handler:Message $2E handler
P:AFB4:b21_call_d214:Call $D214
P:AFBD:b21_setup_party_slot1:Setup party slot 1
P:AFF0:b21_special_map_1901:Special map 19:01 handler

# -- Utility Routines ($B0xx) --
P:B03F:b21_unknown_b03f:Unknown routine at $B03F (load NPC?)
P:B067:b21_unknown_b067:Unknown routine at $B067
P:B083:b21_set_0555_40:Set $0555,X to $40
P:B089:b21_item_check_get:Check and get item
P:B098:b21_return_carry_set:Return with carry set
P:B09A:b21_item_display:Display item routine
P:B0AE:b21_set_e7_01:Set $E7 to $01 (event active)
P:B0B2:b21_set_e7_c0:Set $E7 to $C0
P:B0B6:b21_set_e7_80:Set $E7 to $80
P:B0B8:b21_store_e7:Store A to $E7
P:B0BB:b21_push_check_41:Push and check condition $41
P:B0CE:b21_msg_with_d214:Message with D214 call
P:B0D7:b21_msg_with_d218:Message with D218 call
P:B0E6:b21_chapter_check:Chapter/map check routine
P:B0EF:b21_check_map_03:Check if map is $03
P:B0FF:b21_jmp_b189:Jump to $B189

# -- Name/Text Display ($B1xx-$B2xx) --
P:B1EF:b21_save_regs_push:Save registers and push
P:B1F6:b21_push_da_db:Push $DA/$DB
P:B21C:b21_read_name_loop:Read name from table loop
P:B22B:b21_end_of_name:End of name marker ($80+)
P:B237:b21_restore_da_db:Restore $DA/$DB from stack
P:B243:b21_check_party_flags:Check party flags for suffix
P:B25C:b21_check_special_map:Check for special map text
P:B28C:b21_check_map_1600:Check for map $16:$00
P:B2A3:b21_scan_name_table:Scan name table for map/submap
P:B2C8:b21_inc_da_db:Increment $DA/$DB pointer
P:B2CF:b21_lookup_item_name:Lookup item name by ID
P:B2E2:b21_use_fixed_name:Use fixed item name
P:B2F4:b21_check_map_22:Check for map $22
P:B316:b21_check_map_0401:Check for map $04:$01
P:B340:b21_default_name:Default item name lookup
P:B35F:b21_simple_name_lookup:Simple name lookup
P:B374:b21_clear_party_list:Clear party list ($61DB-$625A)
P:B38A:b21_count_party_members:Count party members
P:B3A1:b21_add_to_party:Add character to party
P:B3CA:b21_remove_from_party:Remove character from party

# -- Bank Call Interface ($B7xx) --
P:B7B5:b21_inter_bank_call:Inter-bank call dispatcher
P:B7BF:b21_push_da_loop:Push $DA-$E9 to stack
P:B7D5:b21_execute_call:Execute inter-bank call
P:B7EC:b21_pop_da_loop:Pop $DA-$E9 from stack
P:B7FB:b21_call_fixed_05_6f:Call fixed bank routine ($05 6F)

# -- Dialog/Conversation System ($B8xx-$BAxx) --
P:B810:b21_read_dialog_index:Read dialog index
P:B822:b21_dialog_type_01:Dialog type 01 handler
P:B825:b21_set_type_01:Set dialog type to 01
P:B829:b21_dialog_type_03:Dialog type 03 handler
P:B830:b21_dialog_type_02:Dialog type 02 handler
P:B833:b21_set_type_02:Set dialog type to 02
P:B835:b21_store_type:Store dialog type to $07C5
P:B83D:b21_main_dialog_loop:Main dialog processing loop
P:B84E:b21_dialog_flow_00:Dialog flow handler 00
P:B862:b21_dialog_flow_01:Dialog flow handler 01
P:B86F:b21_dialog_flow_02:Dialog flow handler 02
P:B87D:b21_dialog_flow_03:Dialog flow handler 03
P:B890:b21_use_slot_00:Use slot 00
P:B8A8:b21_check_slot_09:Check slot >= 09
P:B8B6:b21_check_party_valid:Check party slot valid
P:B8C0:b21_party_invalid:Party slot invalid handler
P:B8C6:b21_retry_or_exit:Retry or exit dialog

# -- Script Helper Routines ($BAxx-$BFxx) --
P:BA3E:b21_unknown_ba3e:Unknown routine at $BA3E
P:BA55:b21_unknown_ba55:Unknown routine at $BA55
P:BA5D:b21_unknown_ba5d:Unknown routine at $BA5D
P:BACD:b21_unknown_bacd:Unknown routine at $BACD
P:BAEF:b21_unknown_baef:Unknown routine at $BAEF
P:BEBC:b21_call_a6b7:Call $A6B7
P:BECC:b21_call_b4ee_a47c:Call $B4EE then $A47C
P:BED2:b21_clear_0553_high:Clear high bit of $0553
P:BEF6:b21_call_b833:Call $B833
P:BEF9:b21_call_d218:Call $D218
P:BF06:b21_find_slot_50:Find slot via $50 + B7B5
P:BF0E:b21_check_9ce5:Check $9CE5 condition
P:BF1B:b21_call_bf4f:Call $BF4F
P:BF2D:b21_call_a84e:Call $A84E
P:BF36:b21_branch_bf36:Script branch at $BF36
P:BF48:b21_call_a6ff:Call $A6FF
P:BF4E:b21_return_bf4e:Return
P:BF4F:b21_setup_fe_ff:Setup $FE/$FF to $00
P:BF64:b21_scan_npc_loop:Scan NPC data loop
P:BF8A:b21_use_0a_value:Use value $0A
P:BF8E:b21_read_npc_data:Read NPC data at ($DA),Y
P:BF93:b21_store_fd:Store result to $FD
P:BFA4:b21_read_banked_byte:Read byte via banked access

# -- RAM Variables Used by Bank 21 --
G:61DB:b21_party_list:Party member list (128 bytes, $FF = end)
G:625B:b21_party_count_1:Party count variable 1
G:625C:b21_party_count_2:Party count variable 2
G:627B:b21_game_flags:Game event flags array
G:628C:b21_counter_1:Event counter 1
G:628D:b21_counter_2:Event counter 2
G:628F:b21_map_flags:Map event flags
G:62A4:b21_npc_state:NPC state variable
G:62E7:b21_party_flags:Party member flags (3 bytes)
G:62ED:b21_dialog_timer:Dialog timer (set to $28)
G:6BDE:b21_special_flag:Special event flag (bit 7)
G:07BD:b21_name_buffer:Name buffer (8 bytes)
G:07C4:b21_name_length:Name length
G:07C5:b21_dialog_type:Current dialog type (1-3)

# ==============================================================================
# BANK 27 ($8000-$BFFF) - Portal/Warp System and Screen Effects
# ==============================================================================

# -- Jump Table at Entry --
# $8000-$801E: Jump table to portal handlers

# -- Portal/Warp Lookup ($80xx) --
P:801F:b27_portal_entry:Portal/warp entry point
P:802E:b27_portal_not_found:Portal not found return (CLC)
P:8030:b27_portal_found:Portal found - load destination
P:8037:b27_search_special:Search for special warp (map $43)
P:8055:b27_next_special:Next special warp entry
P:805C:b27_load_dest_data:Load destination map/coords
P:8079:b27_check_map_38:Check if map $38 (special case)
P:8082:b27_call_c5c5:Call C5C5 for map transition
P:8097:b27_search_portal_list:Search portal list at $05A0
P:8099:b27_portal_loop:Portal search loop
P:80AF:b27_next_portal:Next portal entry (add 7)
P:80B8:b27_portal_search_fail:Portal search failed (CLC)
P:80BA:b27_check_map_43_range:Check map $43 range $07-$09
P:80CA:b27_return_sec:Return with SEC (success)
P:80CC:b27_check_map_11:Check for map $11:$00
P:80DE:b27_return_clc:Return with CLC (fail)
P:80E0:b27_setup_portal_table:Setup portal table
P:8101:b27_check_map_2c:Check for map $2C
P:810C:b27_portal_setup_return:Portal setup return
P:810D:b27_init_portal_data:Initialize portal data from $822D

# -- Portal Data Copy ($81xx) --
P:8119:b27_copy_loop_start:Portal data copy loop start
P:8120:b27_copy_second_half:Copy second half of portal data
P:8127:b27_inc_pointer:Increment pointer by $0A
P:8135:b27_copy_y02:Copy from offset Y+2
P:8142:b27_copy_y07:Copy from offset Y+7
P:814F:b27_copy_2bytes:Copy 2 bytes to $05A0,X
P:815D:b27_copy_dest_data:Copy destination data
P:8170:b27_check_map_38_2:Check map $38 destination
P:817A:b27_check_map_43_2:Check map $43 destination
P:8186:b27_default_copy:Default destination copy
P:8188:b27_store_5bytes:Store 5 bytes destination
P:81BC:b27_finish_entry:Finish portal entry
P:81C8:b27_infinite_loop:Infinite loop (error?)
P:81CB:b27_map_45_adjust:Map $45 destination adjustment
P:81D9:b27_return_05:Return value $05
P:81DC:b27_map_45_check2:Map $45 check variant 2
P:81EA:b27_return_04:Return value $04
P:81EC:b27_simple_return:Simple return
P:81ED:b27_map_38_adjust:Map $38 destination adjustment
P:81F3:b27_return_03_or_04:Return $03 or $04
P:81F9:b27_ret_calc:Return from calculation
P:81FA:b27_map_43_adjust:Map $43 destination adjustment
P:8206:b27_adjust_return:Adjustment return
P:8207:b27_check_match:Check portal match
P:821E:b27_read_byte:Read byte and compare
P:8220:b27_compare_64:Compare with $64
P:8225:b27_no_match:No match (CLC)
P:8227:b27_end_of_list:End of portal list ($FF)

# -- Screen Transition Effect Entry ($A0FF-$A1xx) --
P:A0FF:b27_screen_effect_entry:Screen transition effect entry
P:A11D:b27_setup_scroll_effect:Setup scroll effect
P:A127:b27_run_outro_effect:Run outro/exit effect
P:A137:b27_scroll_intro_loop:Scroll intro effect loop
P:A154:b27_adjust_scroll_amt:Adjust scroll amount
P:A15F:b27_store_scroll_53:Store scroll to $53
P:A168:b27_scroll_outro_loop:Scroll outro effect loop
P:A18F:b27_use_53_value:Use $53 value for scroll
P:A194:b27_ppu_scroll_render:PPU scroll rendering routine
P:A19E:b27_scroll_line_loop:Scroll line rendering loop
P:A1C4:b27_xor_effect:XOR visual effect
P:A1C8:b27_xor_effect_2:XOR effect part 2
P:A1D3:b27_delay_loop:Short delay loop
P:A1E5:b27_reset_xy:Reset X/Y for next frame
P:A203:b27_init_outro_data:Initialize outro data
P:A219:b27_copy_a479:Copy from $A479 table
P:A236:b27_copy_reverse:Copy in reverse order
P:A248:b27_copy_a494:Copy from $A494 table
P:A265:b27_copy_reverse_2:Copy reverse from $A494
P:A283:b27_fill_91:Fill buffer with $91
P:A28B:b27_fill_91_2:Fill second section
P:A295:b27_fill_91_3:Fill third section
P:A29E:b27_setup_intro_data:Setup intro scroll data
P:A2B4:b27_fill_scroll_buf:Fill scroll buffer
P:A2CA:b27_fill_ppu_ctrl:Fill PPU control buffer
P:A2D3:b27_wait_vblank:Wait for VBlank
P:A2D9:b27_set_flag_08:Set flag $08 in $1F

# -- PPU Operations ($A9xx-$AAxx) --
P:A9B1:b27_ppu_write_setup:PPU write address setup
P:A9C0:b27_write_7800:Write $7800 buffer to PPU
P:A9C9:b27_write_7900:Write $7900 buffer to PPU
P:A9E9:b27_write_attr_loop:Write attribute table loop
P:A9F0:b27_inc_0e_20:Increment $0E by $20
P:A9FB:b27_check_page:Check page boundary
P:AA1D:b27_return_aa1d:Return point
P:AA1E:b27_special_33:Special handler (X=$33)
P:AA26:b27_special_20:Special handler (X=$20)
P:AA28:b27_copy_aa39:Copy from $AA39
P:AA5A:b27_calc_mask:Calculate bit mask
P:AA6C:b27_tile_loop:Tile processing loop
P:AA7B:b27_load_tile_addr:Load tile address
P:AAAD:b27_incx_skip:Increment X if needed
P:AAB4:b27_inner_loop:Inner tile loop
P:AAC0:b27_combine_tiles:Combine tile data

# -- Chapter Handlers ($ABxx) --
P:AB0D:b27_chapter_check_entry:Chapter-specific check entry
P:AB23:b27_chapter_process:Process chapter event
P:AB38:b27_chapter_return:Return from chapter check
P:AB41:b27_chapter_alt:Alternative chapter check
P:AB51:b27_chapter_return_2:Return point 2
P:AB52:b27_check_map_3a:Check for map $3A
P:AB6A:b27_call_c5c5_2:Call C5C5 transition
P:AB74:b27_ab74_return:Return from map check
P:AB8C:b27_check_map_11_2:Check for map $11

# -- Chapter Jump Table ($ACxx) --
P:AAFA:b27_chapter_table_entry:Chapter table entry
P:AB0A:b27_chapter_dispatch:Chapter dispatch via ($0000)

# -- RAM Variables Used by Bank 27 --
G:05A0:b27_portal_list:Portal data list (13 entries x 7 bytes)
G:05FB:b27_portal_end:End of portal list
G:6F60:b27_player_pos_x:Player position X array
G:6F80:b27_player_pos_y:Player position Y array
G:7700:b27_scroll_buffer:Scroll position buffer
G:7782:b27_ppu_ctrl_buf:PPU control buffer
G:7800:b27_nametable_buf1:Nametable buffer 1
G:7900:b27_nametable_buf2:Nametable buffer 2
G:62AA:b27_event_flags:Event/chapter flags

# ==============================================================================
# BANK 28 ($8000-$BFFF) - NPC/Map Object Management System
# ==============================================================================
# This bank handles NPC positioning, map object placement, and compressed
# position data decompression. Heavy use of bit-stream reading at $994E.
# Uses arrays at $6E5E-$7180 for NPC object data.

# -- Bit-Stream Reader Core ($994E-$995B) --
P:994E:b28_read_bits:Read Y bits from compressed data at $DA/$DB
P:9950:b28_bits_setup_x:Setup X register for bit read
P:9954:b28_bits_call_c3ea:Call fixed-bank bit decompression
P:995B:b28_bits_return:Return from bit read

# -- NPC Position Processing ($995C-$99xx) --
P:995C:b28_process_npc_entry:Process NPC entry from compressed data
P:995D:b28_init_dc:Initialize $DC to 0
P:9974:b28_read_bits_5:Read 5 bits for position
P:997B:b28_store_70e0:Store to NPC type array $70E0
P:998F:b28_alt_npc_path:Alternative NPC processing path
P:99B3:b28_read_direction:Read NPC direction from bits
P:99CF:b28_y_equals_01:Y = 1 path
P:99D1:b28_read_position:Read NPC position data

# -- Position Compression/Decompression ($96D2-$97xx) --
P:96D2:b28_check_chapter_4:Check if chapter == 4
P:96DC:b28_call_96fc:Load $00 and call $96FC
P:96E7:b28_save_3a_3b:Save $3A/$3B to $DA/$DB (bitstream pointer)
P:96EF:b28_ret_96ef:Simple return
P:96F0:b28_read_flag_80:Read bits and extract $80 flag
P:96FC:b28_decompress_pos:Main position decompression routine
P:9702:b28_decompress_loop:Decompression loop - read one entry
P:971A:b28_skip_loop:Skip zero entries
P:972B:b28_read_mode_byte:Read mode/type byte
P:974B:b28_read_subtype:Read sub-type value
P:975A:b28_alt_decode:Alternative decode path
P:976F:b28_read_flags:Read flag byte
P:9792:b28_read_final:Read final position byte
P:9798:b28_check_skip:Check if entry should be skipped

# -- NPC Array Management ($98B3-$9C0F) --
P:98B3:b28_init_npc_arrays:Initialize NPC position arrays
P:98B9:b28_init_loop:Init loop - clear $6F60-$7140
P:98D8:b28_read_npc_mode:Read NPC mode byte
P:98EF:b28_setup_indices:Setup array indices 3,4,5
P:98FC:b28_store_npc_entry:Store NPC entry to arrays
P:9901:b28_check_bit_08:Check bit $08 in mode
P:9945:b28_advance_stream:Advance bit stream pointer

# -- NPC Slot Search ($9A37-$9A73) --
P:9A37:b28_find_npc_slot:Find empty NPC slot in $6E5E table
P:9A3B:b28_slot_search_loop:Loop through $6E5E[0-15]
P:9A4F:b28_empty_slot:Found empty slot ($FF)
P:9A54:b28_calculate_index:Calculate final slot index
P:9A61:b28_found_existing:Found existing entry
P:9A6C:b28_check_player:Check if player slot (X=0)
P:9A73:b28_slot_return:Return from slot search

# -- NPC Type Processing ($9A74-$9AFF) --
P:9A74:b28_process_type:Process NPC type value
P:9A89:b28_type_high:Type >= 8 path
P:9AB0:b28_clear_low_nibble:Clear low nibble of $00DF,Y
P:9AB9:b28_type_even:Even type number path
P:9ADE:b28_clear_high_nibble:Clear high nibble
P:9AE7:b28_store_type:Store type to $7040,X
P:9AFB:b28_shift_left_4:Shift left 4 bits

# -- Map Data Loading ($9B00-$9B70) --
P:9B00:b28_load_map_npcs:Load NPCs for current map
P:9B08:b28_setup_e0_e1:Setup pointers $E0/$E1
P:9B26:b28_read_map_ptr:Read map NPC data pointer
P:9B3F:b28_read_count:Read NPC count for map
P:9B47:b28_npc_read_loop:Loop reading NPC entries
P:9B5E:b28_inc_da:Increment $DA pointer
P:9B68:b28_save_ptrs:Save $DA/$DB back to $3A/$3B

# -- Bit Stream Pointer Management ($9B71-$9BD8) --
P:9B71:b28_advance_ptr:Advance bit stream pointer
P:9B90:b28_check_flags:Check flag bits
P:9BA2:b28_add_to_da:Add offset to $DA/$DB
P:9BB0:b28_check_bit_10:Check bit $10 in $03
P:9BB9:b28_bb9_return:Return
P:9BBA:b28_check_bit_08_2:Check bit $08 in $03
P:9BC4:b28_read_and_add:Read byte and add to pointer
P:9BD8:b28_bd8_return:Return

# -- Map Version Check ($9BD9-$9BDE) --
P:9BD9:b28_check_map_version:Check if $62ED >= $78 (post-chapter marker)
P:9BDF:b28_clear_npc_slot:Clear NPC slot data at index X

# -- Clear/Initialize NPC Slot ($9BE1-$9C27) --
P:9BE1:b28_clear_slot_arrays:Clear all arrays for slot X
P:9C0F:b28_clear_slots_6_1f:Clear NPC slots 6-31

# -- Map Event Triggers ($9C28-$9CC0) --
P:9C28:b28_check_event_flags:Check event flags for current map
P:9C2F:b28_event_search_loop:Search event table at $9E61
P:9C65:b28_event_clear:Event found - clear carry
P:9C67:b28_next_event:Next event entry (+4)
P:9C6D:b28_no_event:No event - set carry
P:9C6F:b28_special_event_check:Special event condition check
P:9CBF:b28_clear_carry:Clear carry and return
P:9CC0:b28_cc0_return:Simple return

# -- Map Override Table ($9CC1-$9D0D) --
P:9CC1:b28_check_override_table:Check map override table at $9D0E
P:9CCB:b28_override_loop:Loop through override entries
P:9CF0:b28_set_override_ptr:Set override pointer $DA/$DB
P:9D00:b28_next_override:Next override entry

# -- Map Event/NPC Setup ($9EA6-$A057) --
P:9EA6:b28_setup_map_entry:Main map setup entry point
P:9EB5:b28_check_chapter_version:Check chapter/version for special NPCs
P:9EBE:b28_special_npc_loop:Loop for chapter-specific NPCs
P:9ECC:b28_npc_table_loop:Loop through NPC table at $9F8A
P:9EE5:b28_setup_done:Setup complete
P:9EE6:b28_setup_npc_slot:Setup individual NPC slot
P:9F1C:b28_store_npc_type:Store NPC type data
P:9F44:b28_lookup_tile:Lookup tile at NPC position
P:9F55:b28_next_npc:Move to next NPC entry
P:9F5A:b28_store_type_only:Store type without position
P:9F66:b28_use_player_pos:Use player position for NPC
P:9F76:b28_save_npc_pos:Save NPC position to $054E/$054F

# -- Map Handler Dispatch ($A010-$A057) --
P:A010:b28_handler_lookup:Lookup map-specific handler
P:A012:b28_handler_loop:Loop through handler table at $ABF5
P:A022:b28_next_handler:Next handler entry (+2)
P:A027:b28_handler_done:No handler found
P:A028:b28_handler_found:Handler found - dispatch
P:A035:b28_clear_npc:Clear NPC at slot X
P:A044:b28_check_wagon:Check wagon/party flags
P:A04A:b28_set_npc_pos:Set NPC position (A=X, Y=Y coord)
P:A057:b28_pos_return:Return from position set

# -- Map-Specific Handler Code ($A058-$ABF4) --
# Note: This section contains many map-specific NPC setup routines
# Each map has custom logic for placing NPCs based on story flags
P:A058:b28_map_check_07:Check if player X == 7
P:A068:b28_setup_wagon_npc:Setup wagon/chapter 4 NPC
P:A07E:b28_check_party_flags:Check party member flags
P:A0A0:b28_setup_default_npcs:Setup default NPC slots
P:A0C6:b28_setup_chapter_npcs:Setup chapter-specific NPCs

# -- Various Map Handlers --
P:A177:b28_map_handler_bulk:Bulk NPC setup (slots 0C-14)
P:A17B:b28_bulk_loop:Bulk setup loop

# -- Jump Table for Map Handlers ($AC8A-$AD1C) --
P:AC8A:b28_map_handler_table:Jump table for 60+ map handlers

# -- Map Handler Dispatcher ($AD5F-$AD6D) --
P:AD5F:b28_dispatch_handler:Dispatch to map handler via table
P:AD61:b28_load_handler_addr:Load handler address from $BF4B table
P:AD6B:b28_jump_indirect:JMP ($0000) to handler

# -- Map Condition Table ($AD32-$AD5A) --
P:AD32:b28_check_conditions:Check map conditions table at $AD5A
P:AD34:b28_condition_loop:Loop through conditions
P:AD4C:b28_condition_match:Condition matched - clear NPC
P:AD52:b28_next_condition:Next condition (+4)
P:AD59:b28_condition_done:Done checking conditions

# -- NPC Tile Lookup ($AD1E-$AD31) --
P:AD1E:b28_get_npc_tile:Get tile ID at NPC position
P:AD27:b28_call_d3e6:Call tile lookup via bank switch
P:AD2E:b28_store_tile:Store tile to $7146,X

# -- Wagon/Vehicle Escort Code ($B05E-$B0B8) --
P:B05E:b28_wagon_escort:Wagon escort sequence
P:B083:b28_escort_loop_outer:Outer loop - step counter
P:B087:b28_escort_loop_inner:Inner loop - animation frames
P:B0B2:b28_escort_done:Escort sequence complete

# -- Scene/Cutscene Handlers ($B0FC-$BD95) --
P:B0FC:b28_cutscene_setup:Cutscene initialization
P:B11D:b28_load_scene_data:Load scene-specific data
P:BCEF:b28_find_character:Find character in party
P:BCFF:b28_setup_display:Setup display for scene
P:BD54:b28_save_sprites:Save sprite data to $7F00
P:BD67:b28_restore_sprites:Restore sprite data from $7F00
P:BD75:b28_restore_partial:Restore partial sprite data
P:BD83:b28_save_partial:Save partial sprite data

# -- Helper Functions ($BED3-$BF46) --
P:BED3:b28_helper_0d:Helper - BRK $0D
P:BEF2:b28_shift_delay:Shift and delay helper
P:BEFE:b28_frame_delay:Frame delay with $0509
P:BF12:b28_set_npc_mode:Set NPC mode to $8F
P:BF14:b28_set_npc_mode_x:Set NPC mode with X index
P:BF16:b28_store_mode:Store mode to $0530-$0533
P:BF24:b28_bf24_return:Return
P:BF25:b28_set_position:Set NPC position (A=X, Y=Y) at slot X
P:BF33:b28_hide_npc_80:Hide NPC (set position to $80)
P:BF37:b28_hide_npc_81:Hide NPC (set position to $81)
P:BF39:b28_store_hidden:Store hidden position value
P:BF46:b28_brk_07_6f:BRK $07, $6F, $43 - common helper

# -- Map Handler Jump Table Data ($BF4B-$BFAF) --
P:BF4B:b28_handler_ptr_table:Pointer table for map handlers (low/high bytes)

# -- RAM Variables Used by Bank 28 --
G:6E5E:b28_npc_type_table:NPC type table (16 entries)
G:6F60:b28_npc_x_pos:NPC X position array (32 entries)
G:6F80:b28_npc_y_pos:NPC Y position array (32 entries)
G:6FA0:b28_npc_x_target:NPC X target position array
G:6FC0:b28_npc_y_target:NPC Y target position array
G:6FE0:b28_npc_slot_data:NPC slot data array
G:7000:b28_npc_direction:NPC direction array (32 entries)
G:7020:b28_npc_state:NPC state array
G:7040:b28_npc_type_ext:NPC extended type data
G:7060:b28_npc_ptr_hi:NPC data pointer high
G:7080:b28_npc_ptr_lo:NPC data pointer low
G:70A0:b28_npc_anim_frame:NPC animation frame
G:70C0:b28_npc_timer:NPC timer/counter
G:70E0:b28_npc_flags:NPC flags array
G:7100:b28_npc_sprite:NPC sprite index
G:7120:b28_npc_palette:NPC palette index
G:7140:b28_npc_extra:NPC extra data
G:7146:b28_npc_tile_id:NPC tile ID at position
G:7160:b28_npc_reserved:NPC reserved data
G:7180:b28_npc_user:NPC user-defined data

# -- Zero Page Variables Used by Bank 28 --
G:00DA:b28_bitstream_lo:Bit stream pointer low byte
G:00DB:b28_bitstream_hi:Bit stream pointer high byte
G:00DC:b28_temp_dc:Temporary variable
G:00DD:b28_temp_dd:Temporary variable
G:00DF:b28_type_packed:Packed type data (nibbles)
G:00E0:b28_ptr_e0:Pointer low
G:00E1:b28_ptr_e1:Pointer high
G:003A:b28_saved_ptr_lo:Saved pointer low
G:003B:b28_saved_ptr_hi:Saved pointer high
G:0063:b28_map_num:Current map number
G:0064:b28_submap_num:Current submap number
G:0067:b28_bit_offset:Bit offset in stream

# -- Work RAM Variables --
G:0515:b28_special_flag:Special NPC flag
G:0530:b28_event_mode:Event mode register
G:0531:b28_event_slot:Event slot index
G:0534:b28_event_param:Event parameter
G:054E:b28_last_x:Last NPC X position
G:054F:b28_last_y:Last NPC Y position
G:0598:b28_last_submap:Last submap number
G:62ED:b28_chapter_marker:Chapter progress marker

# ==============================================================================
# PRG ROM - Bank 08: Map Tile Data and Encounter System ($8000-$BFFF when loaded)
# ==============================================================================
# Bank 08 handles map tile data, encounter tables, and location processing.
# Uses arrays at $6F20, $6F40, $7600 for tile data.
# Heavily data-driven with code sections at $80xx-$8Axx and $AFxx-$B7xx.

# -- Bank 08 Array Initialization ($803C-$8054) --
P:803C:b08_init_arrays:Initialize tile/encounter arrays
P:8040:b08_init_loop1:Clear $6F20, $6F40, $7600 arrays (32 entries)
P:804E:b08_init_loop2:Clear $761F+ array (160 entries)

# -- Bank 08 Pointer Calculation ($8055-$80B2) --
P:8055:b08_calc_pointer:Calculate data pointer from $09 and $28
P:806A:b08_store_ptr:Store calculated pointer to $00/$01
P:8072:b08_shift_loop:16-bit shift left 5 times
P:8082:b08_read_params:Read encounter parameters from ($0E)
P:8099:b08_check_encounter_type:Check encounter type ($0A/$0B)
P:80AB:b08_check_flag:Check $6286 flag bit 4
P:80B3:b08_table_80b3:Data table - pointer bases

# -- Bank 08 Secondary Pointer ($80B7-$80C1) --
P:80B7:b08_load_ptr_80c2:Load pointer from $80C2/$80C3
P:80C2:b08_table_80c2:Data table - secondary pointer

# -- Bank 08 Read Encounter Data ($80C4-$80D4) --
P:80C4:b08_read_encounter_data:Read 3-byte encounter data to $0A/$0B/$0C

# -- Bank 08 Process Encounter ($80D5-$8187) --
P:80D5:b08_process_encounter:Main encounter/tile data processor
P:80E7:b08_mode_0_setup:Mode 0 path - setup for tile processing
P:80F4:b08_load_data_ptr:Load data pointer from $8235/$8236
P:8108:b08_extract_bits:Extract bits from tile data
P:8114:b08_store_mode_flag:Store mode flag to $76
P:812F:b08_handle_type_0f:Handle special type $0F
P:8132:b08_mode_1_setup:Mode 1 path - alternate tile processing
P:814A:b08_shift_and_lookup:Shift pointer and lookup data
P:815A:b08_indexed_lookup:Indexed data lookup
P:8171:b08_calc_offset:Calculate 3-byte offset (A * 3)

# -- Bank 08 Monster Group Processing ($8187-$81C3) --
P:8187:b08_process_monster_groups:Process 3 monster types loop
P:8193:b08_sign_extend:Sign extend and shift left 4
P:81B4:b08_store_monster_ptr:Store monster pointer to $0102-$0107
P:81C3:b08_jump_to_rotation:Jump to monster rotation routine

# -- Bank 08 Special Type Handlers ($81C6-$8224) --
P:81C6:b08_handle_type_0f_full:Type $0F - load 8 bytes to $0100
P:81DF:b08_copy_8_bytes:Copy 8 bytes from ($00) to $0100
P:81E8:b08_handle_type_0e:Type $0E - sequential monster setup
P:8213:b08_increment_ptr_loop:Increment monster pointers by $10
P:8225:b08_table_8225:Data table - type handler pointers
P:8229:b08_table_8229:Data table - mode lookup (4 entries)
P:8235:b08_table_8235:Data table - base pointer for tile data
P:8237:b08_table_8237:Data table - secondary lookup

# -- Bank 08 Tile Index Processing ($823D-$833E) --
P:823D:b08_process_tile_index:Process tile index with lookup
P:8254:b08_tile_loop_entry:Entry point for tile loop
P:8256:b08_tile_loop:Main tile processing loop
P:8264:b08_search_77xx:Search $7700 array for match
P:828D:b08_no_match:No match found - increment $18
P:8291:b08_found_or_new:Handle found/new tile entry
P:82AD:b08_skip_tile:Skip to next tile
P:82B0:b08_mode_1_store:Mode 1 specific storage
P:82C2:b08_rotate_bits:Bit rotation for tile attributes
P:82EC:b08_store_rotated:Store rotated result
P:831F:b08_add_to_77xx:Add entry to $7700 array
P:832F:b08_next_tile:Advance to next tile entry
P:833E:b08_table_833e:Data table - tile lookup offset

# -- Bank 08 Map Index Processing ($8340-$839E) --
P:8340:b08_process_map_index:Process map index from $16
P:8362:b08_setup_ppu_addr:Setup PPU address for rendering
P:8378:b08_calc_ppu_offset:Calculate PPU offset (*16)
P:8389:b08_ppu_base_table:PPU base address table (lo/hi)
P:838D:b08_write_ppu_addr:Write PPU address to $2006
P:839F:b08_buffer_ppu_addr:Buffer PPU address to $0300

# -- Bank 08 Tile Rendering ($83BD-$8405) --
P:83BD:b08_render_tiles:Render tiles from $0100 array
P:83D9:b08_bank_select:Bank select for tile rendering
P:83DC:b08_render_call:Call render subroutines
P:83F4:b08_write_ppu_data:Write 16 bytes to PPU $2007
P:83FA:b08_write_loop:Write loop - 16 bytes
P:8406:b08_buffer_tiles:Buffer tiles to $0300 for deferred PPU

# -- Bank 08 Tile Lookup ($8433-$8467) --
P:8433:b08_lookup_tile_data:Lookup tile data from table
P:8450:b08_tile_lookup_ptr:Pointer for tile lookup ($76C0)
P:8452:b08_store_tile_result:Store tile result to $6F20/$6F40

# -- Bank 08 Stack Restore ($8468-$8472) --
P:8468:b08_restore_stack:Restore 16 bytes from stack to $00-$0F

# -- Bank 08 Main Tile Process ($8473-$84BC) --
P:8473:b08_main_tile_process:Main tile processing entry
P:8476:b08_check_tile_type:Check tile type (AND #$07)
P:847E:b08_call_tile_handlers:Call tile handler chain
P:84A6:b08_dec_counter:Decrement $6E5E counter
P:84AB:b08_render_chain:Call render chain
P:84B1:b08_advance_ptr:Advance pointer by 2

# -- Bank 08 Tile Process Wrapper ($84BD-$84E2) --
P:84BD:b08_tile_process_wrapper:Store $16 and call main processor
P:84C2:b08_setup_mode_1:Setup mode 1 processing
P:84CA:b08_save_zp:Save zero page to stack
P:84DC:b08_init_6e5e:Initialize $6E5E to $FF (32 entries)

# -- Bank 08 BRK Interpreter ($84E3-$8538) --
P:84E3:b08_brk_interpreter:BRK-based bytecode interpreter
P:84EF:b08_init_encounter:Initialize encounter arrays
P:8503:b08_setup_ppu:Setup PPU for encounter
P:850E:b08_tile_loop_20:Process 32 tiles (0-$1F)
P:8523:b08_tile_loop_30:Process tiles $20-$2F
P:852F:b08_finalize:Finalize and cleanup

# -- Bank 08 Extended Tile ($853E-$859A) --
P:853E:b08_extended_tile:Extended tile processing
P:8562:b08_shift_for_quad:Shift for quadrant calculation
P:856C:b08_get_quadrant:Get quadrant from shifted value
P:8573:b08_load_quadrant_data:Load quadrant data from $8AAF
P:8588:b08_load_second_quad:Load second quadrant entry

# -- Bank 08 Zone Processing ($859B-$85D2) --
P:859B:b08_process_zone:Process zone/region value
P:85A6:b08_check_zone_range:Check zone range ($48-$4F)
P:85BA:b08_store_zone:Store zone to $0E
P:85CD:b08_set_mode_flag:Set $7A mode flag

# -- Bank 08 Dungeon Setup ($85D3-$8667) --
P:85D3:b08_dungeon_setup:Setup for dungeon encounter
P:85E2:b08_dungeon_loop:Dungeon tile processing loop
P:8617:b08_encounter_table_lookup:Lookup encounter table

# -- Bank 08 Encounter Rate ($8668-$8702) --
P:8668:b08_calc_encounter_rate:Calculate encounter rate
P:8680:b08_apply_modifiers:Apply encounter rate modifiers
P:8703:b08_encounter_table:Encounter rate table data

# -- Bank 08 Position Calculation ($8773-$87FF) --
P:8773:b08_calc_position:Calculate position from coordinates
P:8796:b08_position_table:Position lookup table
P:8800:b08_coord_lookup:Coordinate lookup table

# -- Bank 08 Movement Direction ($880E-$88FD) --
P:880E:b08_movement_dir:Determine movement direction
P:882A:b08_cardinal_check:Check cardinal direction
P:88D0:b08_diagonal_check:Check diagonal movement
P:88ED:b08_calc_distance:Calculate distance to target
P:88FE:b08_find_target:Find target position from tile type

# -- Bank 08 Tile Type Lookup ($893D-$8980) --
P:893D:b08_adjust_for_dir:Adjust position for direction
P:8957:b08_get_tile_at_pos:Get tile type at position
P:896F:b08_search_tile_type:Search for specific tile type
P:897E:b08_return_index:Return found index

# -- Bank 08 Monster Rotation ($8981-$89C8) --
P:8981:b08_monster_rotation:Rotate monster group order
P:8990:b08_rotation_loop:Rotation loop - shift $0100-$0107

# -- Bank 08 Tile Transpose ($89C9-$8A29) --
P:89C9:b08_tile_transpose:Transpose tile data
P:89D8:b08_transpose_loop:Transpose outer loop
P:89DC:b08_transpose_inner:Transpose inner loop
P:8A00:b08_extract_bits_horiz:Extract horizontal bits
P:8A15:b08_extract_bits_vert:Extract vertical bits

# -- Bank 08 Special Tile Handling ($8A2A-$8A91) --
P:8A2A:b08_special_tile:Handle special tile types
P:8A3F:b08_normal_tile:Normal tile path
P:8A58:b08_return_result:Return tile result
P:8A85:b08_post_process:Post-process tile data

# -- Bank 08 Data Tables ($8A92-$8ABF) --
P:8A92:b08_table_8a92:Tile type data table
P:8AA2:b08_table_8aa2:Quadrant lookup table
P:8AAF:b08_table_8aaf:Quadrant data table (4 bytes each)

# -- Bank 08 Location Data System ($AF00-$B036) --
P:AED5:b08_location_entry:Location data entry point
P:AEE8:b08_location_loop:Location search loop
P:AF13:b08_store_map_num:Store map number to $63
P:AF32:b08_location_setup:Location setup calls
P:AF40:b08_load_location_data:Load location coordinates
P:AF51:b08_check_special_loc:Check for special locations
P:AF67:b08_check_loc_0e:Check location type $0E
P:AF82:b08_store_loc_params:Store location parameters ($64, $44, $45)
P:AF89:b08_get_loc_terrain:Get location terrain type
P:AF99:b08_check_loc_special:Check special location cases
P:AFBA:b08_loc_3a_handler:Location $3A special handler
P:AFC9:b08_loc_39_handler:Location $39 special handler
P:AFE1:b08_loc_19_handler:Location $19 special handler
P:AFF3:b08_loc_45_handler:Location $45 special handler
P:B00B:b08_loc_0b_handler:Location $0B special handler
P:B01C:b08_loc_2c_handler:Location $2C special handler
P:B036:b08_location_return:Location return

# -- Bank 08 Location Lookup ($B037-$B05B) --
P:B037:b08_lookup_location:Lookup location in table
P:B043:b08_lookup_loop:Location lookup loop
P:B05B:b08_lookup_done:Lookup complete

# -- Bank 08 Location Read ($B05C-$B0AD) --
P:B05C:b08_read_location_byte:Read single byte from location data
P:B06A:b08_brk_loc_search:BRK-based location search
P:B071:b08_loc_search_loop:Location search loop
P:B08D:b08_found_location:Found matching location

# -- Bank 08 Location Processing ($B0AE-$B187) --
P:B0AE:b08_process_location:Process location data
P:B135:b08_calc_encounter:Calculate location encounter rate
P:B145:b08_loc_not_found:Location not found handler

# -- Bank 08 Exit Processing ($B188-$B22D) --
P:B188:b08_exit_handler:Exit/door handler
P:B194:b08_check_door:Check door type
P:B1D0:b08_exit_table:Exit point table

# -- Bank 08 Treasure Processing ($B22E-$B322) --
P:B22E:b08_treasure_handler:Treasure chest handler
P:B27F:b08_item_check:Check item availability
P:B2C2:b08_empty_chest:Empty chest handler

# -- Bank 08 NPC Interaction ($B323-$B439) --
P:B323:b08_npc_interact:NPC interaction handler
P:B397:b08_npc_dialog:NPC dialog trigger
P:B3D9:b08_npc_special:Special NPC handler
P:B425:b08_npc_3a:NPC type $3A handler
P:B43A:b08_npc_19:NPC type $19 handler

# -- Bank 08 Flag Checking ($B48E-$B553) --
P:B48E:b08_compare_flags:Compare flags against saved state
P:B4B9:b08_flag_changed:Handle flag change
P:B4C1:b08_terrain_encounter:Terrain-based encounter modifier
P:B4ED:b08_get_tile_table:Get tile table pointer
P:B51F:b08_count_tiles:Count matching tiles
P:B554:b08_search_tiles:Search for specific tile type

# -- Bank 08 Warp/Teleport ($B5B3-$B5F0) --
P:B5B3:b08_warp_check:Check warp availability
P:B5BF:b08_warp_execute:Execute warp
P:B5E2:b08_check_warp_flag:Check warp flag in $62AA
P:B5F1:b08_return_result:Return warp result

# -- Bank 08 Data Tables ($B5F2-$B7FF) --
P:B5F2:b08_data_tables:Various data tables
P:B671:b08_table_b671:Tile data table pointer
P:B673:b08_table_b673:Secondary table pointer
P:B67D:b08_table_b67d:Tertiary table pointer
P:B7F7:b08_table_b7f7:Location data table pointer

# -- Bank 08 Tileset Data (DataCrystal ROM Map) --
# Source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)/ROM_map
# Tileset data defines tile graphics for each map type (town, dungeon, overworld).
# 51 tilesets × 64 bytes each = $0CC0 bytes total.
P:208229:b08_tileset_base_addr_table:Tile graphics base address table (3 entries)
P:208ADB:b08_tileset_data_start:Tileset data start (51 tilesets × 64 bytes)
# Tileset format: each tileset = 64 bytes of tile definitions
# Tileset 00-32: Various town/dungeon tilesets
# Tileset 33-50: Additional map type tilesets
P:20979B:b08_tileset_data_end:End of tileset data (after 51st tileset)

# -- Bank 08 Tile Definition Tables (DataCrystal ROM Map) --
# Tile table entries: 3 bytes per tile (tile number, pattern, behavior)
P:20A1BB:b08_tile_increment_patterns:Tile increment patterns table
P:20A28D:b08_tile_pattern_f_table:Pattern F tile table
P:20A80D:b08_tile_definition_table:Main tile definition table (3 bytes/entry)
# Each tile entry: [tile_number][pattern][behavior]
# Pattern determines visual appearance, behavior determines gameplay effect

# -- Bank 08 Animated Tiles (DataCrystal ROM Map) --
P:20AEB7:b08_animated_tile_data:Animated tile data (waterfalls, etc.)

# -- Bank 08 RAM Variables --
G:6F20:b08_tile_data_1:Tile data array 1 (32 entries)
G:6F40:b08_tile_data_2:Tile data array 2 (32 entries)
G:7600:b08_encounter_data:Encounter data array (160 entries)
G:7684:b08_quadrant_flags:Quadrant flags (4 bytes)
G:7700:b08_tile_cache:Tile cache array (256 bytes)

# -- Bank 08 Zero Page Variables --
P:0000:b08_temp_00:Temporary pointer low
P:0001:b08_temp_01:Temporary pointer high
P:0002:b08_temp_02:Secondary temp low
P:0003:b08_temp_03:Secondary temp high
P:0004:b08_counter_04:Counter variable
P:0005:b08_counter_05:Counter high byte
P:0007:b08_mode_flag:Mode flag (0 or non-zero)
P:0008:b08_shift_count:Shift counter
P:0009:b08_mode_select:Mode selector (0 or 1)
P:000A:b08_param_a:Parameter A - tile/encounter data
P:000B:b08_param_b:Parameter B
P:000C:b08_param_c:Parameter C
P:000D:b08_buffer_mode:Buffer mode (0=direct, 1=deferred)
P:000E:b08_ptr_0e:Data pointer low
P:000F:b08_ptr_0f:Data pointer high
P:0016:b08_tile_index:Current tile index
P:0018:b08_tile_id_base:Tile ID base value
P:0019:b08_ppu_addr_lo:PPU address low
P:001A:b08_ppu_addr_hi:PPU address high
P:0072:b08_calc_lo:Calculation temp low
P:0073:b08_calc_hi:Calculation temp high
P:0074:b08_rotation_cnt:Rotation count
P:0075:b08_rotation_tmp:Rotation temp
P:0076:b08_mode_76:Mode flag ($76)
P:0079:b08_cache_index:Tile cache index
P:007A:b08_transpose_flag:Transpose flag
P:00DA:b08_loc_ptr_lo:Location pointer low
P:00DB:b08_loc_ptr_hi:Location pointer high
P:00DC:b08_loc_temp_dc:Location temp DC
P:00DD:b08_loc_temp_dd:Location temp DD
P:00DE:b08_encounter_mod_lo:Encounter modifier low
P:00DF:b08_encounter_mod_hi:Encounter modifier high
P:00E4:b08_last_map:Last map number
P:00E5:b08_last_submap:Last submap number
P:00E6:b08_last_x:Last X coordinate
P:00E7:b08_last_y:Last Y coordinate
P:00E9:b08_save_reg:Saved register temp

# ==============================================================================
# PRG ROM - Bank 0E: Palette and Graphics Code ($8000-$BFFF when loaded)
# ==============================================================================
# Bank 0E (file offset $38000) contains palette decision code and color tables.
# Source: https://datacrystal.tcrf.net/wiki/Dragon_Warrior_IV_(NES)/ROM_map

# -- Bank 0E Palette Decision Code ($BAF7-$BB52) --
# Determines which palette to use based on map type and conditions
P:38AF7:b0e_palette_decision:Palette decision code entry
P:38B52:b0e_palette_decision_end:End of palette decision code

# -- Bank 0E Palette Tables ($BB53-$BC09) --
P:38B53:b0e_palette_table_1:Palette table 1
P:38C09:b0e_palette_table_1_end:End of palette table 1

# -- Bank 0E Additional Palette Data ($BC0A-$BCE1) --
P:38C0A:b0e_palette_data_2:Palette data section 2
P:38CE1:b0e_palette_data_2_end:End of palette data section 2

# -- Bank 0E Secondary Palette Tables ($BCE2-$BD9F) --
P:38CE2:b0e_palette_table_2:Secondary palette table
P:38D9F:b0e_palette_table_2_end:End of secondary palette table

# ==============================================================================
# PRG ROM - Bank 20: Party/Wagon Management System ($8000-$BFFF when loaded)
# ==============================================================================
# Bank 20 handles party management, wagon system, monster displays, and menu UI.
# Heavy use of $6E45-$6E49 (party slots), $0440-$0476 (item buffers).
# ~628 JSR calls - one of the most code-heavy banks.

# -- Bank 20 Initialization ($8038-$8087) --
P:8038:b20_init_loop:Main initialization loop
P:803F:b20_init_after_loop:Post-loop initialization
P:8046:b20_clear_06a0:Clear $06A0 array (8 bytes)
P:804E:b20_clear_05fc:Clear $05FC array (26 bytes)
P:8062:b20_clear_6e49:Clear party HP/status array
P:806A:b20_clear_0444:Clear $0444 array (8 bytes)

# -- Bank 20 BRK-based Operations ($8072-$80E4) --
P:8072:b20_brk_party_init:BRK $29,$C3 - party initialization sequence
P:808B:b20_check_party_slot:Check party slot ($6E45+X)
P:80AD:b20_store_char_c4:Store character ID to $C4
P:80B9:b20_init_char_data:Initialize character data subroutines
P:80E1:b20_call_946e:Call $946E (character display)
P:80E4:b20_next_slot:Increment $C6 for next party slot

# -- Bank 20 Monster Entry System ($80EE-$812C) --
P:80EE:b20_monster_loop:Monster entry loop (8 monsters)
P:8103:b20_monster_setup:Setup monster display
P:8111:b20_store_monster_offset:Store monster offset to $06A0
P:8126:b20_after_monsters:After monster processing

# -- Bank 20 Party Update System ($812F-$81CC) --
P:812F:b20_party_update_entry:Party update entry point
P:8141:b20_party_update_loop:Main party update loop
P:8162:b20_check_conditions:Check various party conditions
P:8184:b20_valid_char:Valid character - setup display
P:81A4:b20_store_char_item:Store character item to $0440
P:81AE:b20_remove_from_party:Remove character from party
P:81B5:b20_next_char_slot:Next character slot

# -- Bank 20 OAM/Display ($81CF-$8210) --
P:81CF:b20_clear_oam:Clear OAM buffer ($0200-$02FF)
P:81E8:b20_sprite_loop:Sprite setup loop
P:81F3:b20_clear_oam_rts:Return from OAM clear
P:81F4:b20_shift_party:Shift party array down ($6E45-$6E4C)
P:8210:b20_shift_rts:Return from shift

# -- Bank 20 Character Display ($8211-$822F) --
P:8211:b20_char_display:Character display wrapper
P:8220:b20_char_display_alt:Alternate character display
P:822F:b20_display_setup:Display setup with check

# -- Bank 20 Special Displays ($8237-$82CC) --
P:8237:b20_check_ae:Check for character $AE
P:8263:b20_standard_display:Standard character display
P:8297:b20_clear_0303:Clear PPU buffer $0303
P:82CC:b20_call_9a40:Call $9A40 (display subroutine)
P:82CF:b20_call_9e7f:Call $9E7F (after display)

# -- Bank 20 Animation System ($82E9-$8363) --
P:82E9:b20_animation_entry:Animation entry point
P:82F0:b20_animation_loop:Animation loop (4 frames)
P:830F:b20_animation_frame:Single animation frame
P:8328:b20_animation_alt:Alternate animation path
P:8330:b20_animation_inner:Inner animation loop

# -- Bank 20 Utility Functions ($8364-$83C1) --
P:8364:b20_indirect_jump:Indirect jump via ($0000)
P:8367:b20_check_party_full:Check if party is full
P:8373:b20_set_carry_return:Set carry and return
P:837F:b20_animation_helper:Animation helper with delay
P:83A5:b20_clear_slots:Clear animation slots
P:83B7:b20_fill_05fc:Fill $05FC array with A

# -- Bank 20 Scroll Animation ($83C2-$8413) --
P:83C2:b20_scroll_init:Scroll animation initialization
P:83CB:b20_scroll_loop:Main scroll animation loop
P:83E3:b20_scroll_inner:Inner scroll processing

# -- Bank 20 Menu Functions ($8414-$8495) --
P:8414:b20_menu_entry_a:Menu entry point A
P:841C:b20_menu_entry_b:Menu entry point B
P:8422:b20_menu_setup:Menu setup

# -- Bank 20 Item/Inventory ($8496-$852D) --
P:8496:b20_inventory_entry:Inventory entry point
P:852D:b20_inventory_return:Inventory return

# -- Bank 20 Character Stats ($852E-$85CE) --
P:852E:b20_stats_display:Character stats display
P:8582:b20_stats_return:Stats return
P:85AB:b20_stats_helper:Stats helper function

# -- Bank 20 Party Swap ($85CF-$8665) --
P:85CF:b20_swap_entry:Party swap entry
P:8605:b20_swap_return:Swap return
P:8624:b20_swap_complete:Swap complete handler

# -- Bank 20 Gold/Money ($8666-$86F6) --
P:8666:b20_gold_display:Gold display routine
P:86C4:b20_gold_update:Gold update
P:86EC:b20_gold_return:Gold return

# -- Bank 20 Item Transfer ($86F7-$8779) --
P:86F7:b20_item_transfer:Item transfer routine
P:8736:b20_transfer_loop:Transfer loop
P:8762:b20_transfer_done:Transfer done

# -- Bank 20 Equipment ($877A-$88CB) --
P:877A:b20_equipment_entry:Equipment entry
P:87B0:b20_equipment_return:Equipment return
P:88CB:b20_equipment_final:Equipment final

# -- Bank 20 Wagon System ($88CC-$89EF) --
P:88CC:b20_wagon_entry:Wagon menu entry
P:8920:b20_wagon_process:Wagon processing
P:89DA:b20_wagon_transfer:Wagon transfer
P:89EF:b20_wagon_return:Wagon return

# -- Bank 20 Shop/Buy ($89F0-$8ACA) --
P:89F0:b20_shop_entry:Shop/buy entry
P:8A01:b20_shop_item:Shop item display
P:8A03:b20_shop_return:Shop return
P:8ACA:b20_buy_complete:Buy complete

# -- Bank 20 Sell System ($8ACB-$8BC8) --
P:8ACB:b20_sell_entry:Sell entry
P:8B35:b20_sell_process:Sell processing
P:8B52:b20_sell_item:Sell item handler
P:8BC8:b20_sell_return:Sell return

# -- Bank 20 Appraise/Identify ($8BC9-$8C85) --
P:8BC9:b20_appraise_entry:Appraise item entry
P:8BE7:b20_appraise_process:Appraise processing
P:8C06:b20_appraise_item:Appraise item handler
P:8C1A:b20_appraise_return:Appraise return
P:8C85:b20_appraise_final:Appraise final

# -- Bank 20 Monster Graphics ($8C86-$8DF0) --
P:8C86:b20_monster_gfx_entry:Monster graphics entry
P:8CD4:b20_monster_gfx_load:Load monster graphics
P:8D28:b20_monster_gfx_process:Process monster graphics
P:8D54:b20_monster_gfx_return:Monster graphics return
P:8DF0:b20_monster_gfx_final:Monster graphics final

# -- Bank 20 Name Entry ($8DF1-$8F77) --
P:8DF1:b20_name_entry:Name entry screen
P:8F39:b20_name_process:Name processing
P:8F53:b20_name_char:Process name character
P:8F5B:b20_name_cursor:Name cursor handling
P:8F77:b20_name_return:Name entry return

# -- Bank 20 Character Selection ($8F78-$9292) --
P:8F78:b20_select_entry:Character selection entry
P:8F8F:b20_select_return:Selection return
P:926B:b20_select_process:Selection processing
P:9292:b20_select_final:Selection final

# -- Bank 20 Status Effects ($9293-$9439) --
P:9293:b20_status_entry:Status effect entry
P:92EF:b20_status_process:Status processing
P:9439:b20_status_return:Status return

# -- Bank 20 Party Order ($943A-$9496) --
P:943A:b20_party_order_entry:Party order entry
P:946E:b20_party_order_display:Display party order
P:9496:b20_party_order_return:Party order return

# -- Bank 20 Monster Sprite ($9497-$9682) --
P:9497:b20_monster_sprite_entry:Monster sprite entry
P:9C1D:b20_monster_sprite_load:Load monster sprite
P:9C54:b20_monster_sprite_display:Display monster sprite
P:9653:b20_monster_sprite_helper:Monster sprite helper

# -- Bank 20 Item Checks ($9682-$969C) --
P:9682:b20_item_check_a:Item check routine A
P:9686:b20_item_check_b:Item check routine B
P:969C:b20_item_check_process:Item check processing

# -- Bank 20 Price Calculation ($969D-$9782) --
P:969D:b20_price_calc_entry:Price calculation entry
P:96C5:b20_price_setup:Price setup
P:9712:b20_price_display:Price display
P:9783:b20_price_return:Price calculation return

# -- Bank 20 Decompression ($978A-$9E1C) --
P:978A:b20_decompress_entry:Decompression entry
P:9E0C:b20_decompress_check:Decompression check
P:9E1C:b20_decompress_return:Decompression return

# -- Bank 20 Display Wrappers ($9E7F-$9F66) --
P:9E7F:b20_display_wrapper_a:Display wrapper A
P:9ED1:b20_display_wrapper_b:Display wrapper B
P:9EF4:b20_display_wrapper_c:Display wrapper C
P:9F0C:b20_display_wrapper_d:Display wrapper D
P:9F26:b20_display_wrapper_e:Display wrapper E
P:9F66:b20_display_wrapper_f:Display wrapper F

# -- Bank 20 Utility Helpers ($9F8D-$9FA9) --
P:9F8D:b20_read_byte:Read byte helper
P:9F9F:b20_advance_ptr:Advance pointer helper
P:9FA9:b20_setup_ptr:Setup pointer helper

# -- Bank 20 RAM Variables --
G:0440:b20_item_buffer:Item buffer (4 slots)
G:0444:b20_char_flags:Character flags array
G:044C:b20_item_id:Current item ID array
G:045A:b20_item_price_lo:Item price low bytes
G:0468:b20_item_price_hi:Item price high bytes
G:05FC:b20_display_buffer:Display buffer (26 bytes)
G:0600:b20_special_slots:Special slots (3 bytes for medals)
G:0650:b20_temp_buffer:Temporary buffer (32 bytes)
G:0690:b20_sprite_flags:Sprite flags array
G:0698:b20_sprite_state:Sprite state array
G:06A0:b20_monster_offsets:Monster offset array (8 entries)
G:6E45:b20_party_ids:Party character IDs (4 slots)
G:6E49:b20_party_hp:Party HP/status (4 slots)
G:6E7E:b20_medal_count:Medal count
G:7392:b20_monster_sizes:Monster size table

# -- Bank 20 Zero Page Variables --
P:00C0:b20_price_lo:Price low byte
P:00C1:b20_price_hi:Price high byte
P:00C4:b20_current_char:Current character ID
P:00C5:b20_current_hp:Current HP value
P:00C6:b20_slot_index:Current slot index
P:00C7:b20_monster_index:Current monster index
P:00C8:b20_item_slot:Current item slot
P:00C9:b20_total_lo:Total low byte
P:00CA:b20_total_hi:Total high byte
P:00CB:b20_calc_lo:Calculation temp low
P:00CC:b20_calc_hi:Calculation temp high
P:00CD:b20_base_lo:Base value low
P:00CE:b20_base_hi:Base value high
P:00D1:b20_quantity:Quantity/count
P:00D4:b20_modifier_lo:Modifier low
P:00D5:b20_modifier_hi:Modifier high
P:00D6:b20_scroll_dir:Scroll direction
P:00D7:b20_scroll_cnt:Scroll counter
P:00D8:b20_scroll_flag:Scroll flag
P:00D9:b20_display_mode:Display mode

# ============================================================
# BANK 22 - TEXT/DIALOGUE PROCESSING SYSTEM
# PRG Address: $8000-$BFFF (Bank 22)
# PRG Offset: 0x58000
# ============================================================

# -- Bank 22 Entry Points ($8028-$8035) --
P:8028:b22_entry_point:Main entry point
P:802B:b22_call_init:Call initialization
P:802E:b22_call_setup:Call setup routine
P:8031:b22_call_main_loop:Call main processing loop
P:8035:b22_entry_return:Return from entry

# -- Bank 22 Main Processing Loop ($8036-$8093) --
P:8036:b22_main_loop:Main text processing loop
P:803F:b22_check_state:Check dialog state ($5C)
P:8043:b22_call_input:Call input handler
P:8051:b22_check_char_id:Check character ID in $6E8A array
P:8084:b22_set_char_6c:Set character $6C handler
P:8089:b22_clear_state:Clear state variables ($5D, $57)
P:8091:b22_return_state:Return current state

# -- Bank 22 Command Dispatch ($8094-$80C3) --
P:8094:b22_dispatch_cmd:Dispatch text command
P:80A4:b22_calc_handler:Calculate handler from command
P:80B5:b22_default_handler:Default command handler
P:80C4:b22_handler_table:Command handler jump table (16 entries)

# -- Bank 22 Text State ($80EA-$8123) --
P:80EA:b22_check_text_state:Check text state ($5C, $60)
P:8107:b22_clear_flag_60:Clear flag $60
P:810B:b22_state_return:State check return
P:810C:b22_call_handlers:Call multiple handlers
P:8124:b22_pop_return:Pop and return handler

# -- Bank 22 Input Check ($812A-$8150) --
P:812A:b22_check_input:Check for input ($0553)
P:8137:b22_input_return:Input check return
P:8138:b22_handle_input:Handle input action
P:8140:b22_call_cd_cc:Call CD/CC handler
P:8146:b22_compare_55:Compare $0551 with $55
P:8150:b22_jump_cc:Jump to $81CC

# -- Bank 22 Dialog Box ($816D-$81CB) --
P:816D:b22_init_dialog:Initialize dialog box
P:817E:b22_set_dialog_pos:Set dialog position ($56 = $13)
P:8190:b22_dialog_scroll:Dialog scroll loop
P:8199:b22_set_scroll_x:Set scroll X position
P:81A1:b22_scroll_transfer:Transfer scroll position
P:81B0:b22_check_scroll:Check scroll input
P:81C6:b22_scroll_done:Scroll done return
P:81C7:b22_clear_55:Clear $55 flag
P:81CC:b22_validate_party:Validate party members

# -- Bank 22 Character Lookup ($81EA-$8218) --
P:81EA:b22_lookup_char:Lookup character from $5D
P:81FA:b22_push_lookup:Push and process lookup
P:8212:b22_lookup_return:Lookup return
P:8213:b22_lookup_table:Character lookup table

# -- Bank 22 Name Processing ($8219-$82D0) --
P:8219:b22_jump_8338:Jump to $8338
P:821C:b22_load_name:Load character name
P:8235:b22_copy_name:Copy name to buffer ($0554)
P:8244:b22_copy_name_loop:Name copy loop
P:8257:b22_name_setup:Name setup routine
P:826B:b22_name_check:Check name validity
P:827E:b22_copy_from_03e3:Copy name from $03E3
P:829A:b22_special_name:Special name handler

# -- Bank 22 Level/Stats ($82DB-$8308) --
P:82DB:b22_get_level:Get character level from $6E45
P:82E7:b22_copy_level:Copy level to buffer
P:8306:b22_level_done:Level done return
P:8309:b22_check_level:Check level constraints

# -- Bank 22 Buffer Operations ($8336-$8372) --
P:8336:b22_set_x_zero:Set X = 0
P:8338:b22_get_char_buffer:Get character from buffer ($0554)
P:8346:b22_end_of_text:End of text marker ($40)
P:8356:b22_read_script:Read from script ($F9 indexed by $5B)
P:835D:b22_copy_to_buffer:Copy to buffer from $03E3
P:836B:b22_store_output:Store output to $06AA

# -- Bank 22 Display Setup ($8373-$8392) --
P:8373:b22_display_setup:Setup display position
P:8386:b22_call_c65a:Call C65A for character
P:838B:b22_check_0553:Check $0553 state
P:8393:b22_calc_position:Calculate screen position

# -- Bank 22 Character Validation ($83A4-$83CD) --
P:83A4:b22_validate_char:Validate character for display
P:83BD:b22_check_special:Check special characters ($69, $6A)
P:83CD:b22_call_8411:Call $8411 subroutine

# -- Bank 22 Window Control ($83D2-$8450) --
P:83D2:b22_window_init:Window initialization
P:83FA:b22_window_draw:Draw window frame
P:8411:b22_window_clear:Clear window area
P:8423:b22_window_scroll:Window scroll handler
P:843A:b22_window_close:Close window

# -- Bank 22 Text Commands ($8451-$85C7) --
P:8451:b22_cmd_newline:Newline command handler
P:8479:b22_cmd_pause:Pause command handler
P:84A5:b22_cmd_clear:Clear screen command
P:84C9:b22_cmd_wait:Wait for input command
P:84F2:b22_cmd_choice:Choice/menu command
P:8528:b22_cmd_name:Insert name command
P:8563:b22_cmd_number:Insert number command
P:8595:b22_cmd_item:Insert item name command
P:85C8:b22_init_buffers:Initialize text buffers

# -- Bank 22 Input Handler ($85E7-$8677) --
P:85E7:b22_process_input:Process player input
P:8626:b22_check_button:Check button press
P:8652:b22_update_cursor:Update cursor position
P:8678:b22_input_loop:Input processing loop

# -- Bank 22 Text Rendering ($868F-$8891) --
P:868F:b22_render_char:Render single character
P:86BC:b22_render_special:Render special character codes
P:86E8:b22_render_line:Render line of text
P:871F:b22_render_box:Render text box frame
P:872B:b22_render_init:Initialize render state

# -- Bank 22 Script Interpreter ($8892-$9649) --
P:8892:b22_script_exec:Execute script command
P:88C2:b22_script_loop:Script execution loop
P:8912:b22_script_branch:Script branch handler
P:8956:b22_script_jump:Script jump command
P:898A:b22_script_call:Script call subroutine
P:89BE:b22_script_return:Script return from call
P:89F2:b22_script_end:Script end marker

# -- Bank 22 Condition Processing ($964A-$96C4) --
P:964A:b22_process_cond:Process condition flags ($F5)
P:967C:b22_check_cond:Check condition result
P:9694:b22_update_flags:Update flag registers
P:96C4:b22_cond_return:Condition return

# -- Bank 22 Text Lookup ($96C5-$9751) --
P:96C5:b22_lookup_text:Lookup text in table
P:96E3:b22_get_text_ptr:Get text pointer from $03C8
P:96F3:b22_process_text_id:Process text ID
P:9716:b22_shift_text_ptr:Shift text pointer
P:973B:b22_update_text_buffer:Update text buffer ($076A)
P:9751:b22_lookup_return:Lookup return

# -- Bank 22 Message Processing ($975A-$982C) --
P:975A:b22_msg_process:Process message data
P:9768:b22_msg_loop:Message processing loop
P:978C:b22_msg_lookup:Message lookup handler
P:97B0:b22_msg_check:Message check ($F5)
P:97BB:b22_msg_type:Message type handler
P:97CE:b22_msg_offset:Calculate message offset
P:97ED:b22_msg_special:Special message handler
P:982C:b22_msg_return:Message return

# -- Bank 22 Gold/Money ($982D-$9881) --
P:982D:b22_gold_handler:Gold display handler
P:9856:b22_format_gold:Format gold value
P:9882:b22_gold_lookup:Gold table lookup

# -- Bank 22 Cursor Control ($98B3-$98FA) --
P:98B3:b22_cursor_out:Output character at cursor
P:98D2:b22_cursor_special:Handle special cursor codes
P:98FB:b22_cursor_set:Set cursor position

# -- Bank 22 Number Formatting ($98FE-$9C18) --
P:98FE:b22_format_num:Format number for display
P:9930:b22_num_digits:Extract digits
P:996B:b22_num_leading:Handle leading zeros
P:998C:b22_num_output:Output formatted number
P:99EB:b22_num_return:Number format return

# -- Bank 22 Menu System ($9C19-$9FB5) --
P:9C19:b22_menu_init:Initialize menu system
P:9C54:b22_menu_draw:Draw menu frame
P:9C8A:b22_menu_cursor:Position menu cursor
P:9CC3:b22_menu_input:Handle menu input
P:9D02:b22_menu_select:Process menu selection
P:9D45:b22_menu_exit:Exit menu
P:9FB6:b22_menu_numeric:Numeric input menu

# -- Bank 22 Yes/No Prompt ($A004-$A0CF) --
P:A004:b22_yesno_check1:Yes/No check option 1
P:A020:b22_yesno_check2:Yes/No check option 2
P:A032:b22_yesno_process:Process Yes/No result
P:A04D:b22_yesno_up:Cursor up handler
P:A067:b22_yesno_down:Cursor down handler
P:A07C:b22_yesno_left:Cursor left handler
P:A0AC:b22_yesno_right:Cursor right handler
P:A0D0:b22_yesno_update:Update Yes/No display

# -- Bank 22 Item Menu ($A0E1-$A150) --
P:A0E1:b22_item_menu:Item selection menu
P:A0F7:b22_item_init:Initialize item list
P:A130:b22_item_loop:Item menu loop
P:A14F:b22_item_return:Item menu return

# -- Bank 22 String Operations ($A15A-$A214) --
P:A15A:b22_str_compare:String comparison
P:A163:b22_str_validate:Validate string
P:A1A1:b22_str_search:Search in string

# -- Bank 22 Party Menu ($A215-$A361) --
P:A215:b22_party_check:Check party member
P:A231:b22_party_select:Select party member
P:A248:b22_party_cursor_up:Party cursor up
P:A27B:b22_party_cursor_down:Party cursor down
P:A2B1:b22_party_confirm:Confirm party selection
P:A2DB:b22_party_cancel:Cancel party selection

# -- Bank 22 Text Bank Lookup ($A362-$A734) --
P:A362:b22_text_bank_ptr:Get text bank pointer
P:A3A2:b22_text_decompress:Decompress text data
P:A735:b22_text_ptr_table:Text pointer table

# -- Bank 22 Stat Display ($B24F-$B341) --
P:B24F:b22_stat_display:Display character stats
P:B278:b22_stat_hp:Display HP value
P:B29D:b22_stat_mp:Display MP value
P:B307:b22_stat_level:Display level
P:B337:b22_stat_ptr:Get stat pointer

# -- Bank 22 Equipment Display ($B342-$B3A2) --
P:B342:b22_equip_display:Display equipment
P:B367:b22_equip_name:Display equipment name
P:B37A:b22_equip_table:Equipment lookup table
P:B37F:b22_equip_stats:Display equipment stats

# -- Bank 22 Shop Interface ($B3A3-$B746) --
P:B3A3:b22_shop_init:Initialize shop interface
P:B3E0:b22_shop_list:Display shop item list
P:B428:b22_shop_select:Handle shop selection
P:B480:b22_shop_buy:Process buy transaction
P:B4D8:b22_shop_sell:Process sell transaction
P:B540:b22_shop_price:Calculate item price
P:B5A0:b22_shop_confirm:Confirm purchase/sale

# -- Bank 22 Character Data ($B747-$BA0D) --
P:B747:b22_get_char_data:Get character data by index
P:B780:b22_char_name_ptr:Get character name pointer
P:B7B5:b22_char_stats_ptr:Get character stats pointer
P:B810:b22_char_equip_ptr:Get equipment pointer
P:B860:b22_char_spells_ptr:Get spell list pointer

# -- Bank 22 Number Conversion ($BA0E-$BAD1) --
P:BA0E:b22_num_to_text:Convert number to text
P:BA44:b22_digit_extract:Extract digits from number
P:BA9F:b22_num_output2:Output converted number
P:BAA9:b22_num_format:Format number with leading zeros
P:BACA:b22_num_suffix:Add number suffix
P:BAD2:b22_num_skip:Skip leading zeros

# -- Bank 22 BCD Operations ($BB4C-$BB8C) --
P:BB4C:b22_bcd_convert:Convert to BCD
P:BB56:b22_bcd_digit:Extract BCD digit
P:BB75:b22_bcd_output:Output BCD value
P:BB81:b22_bcd_loop:BCD output loop

# -- Bank 22 Special Display ($BB8D-$BC42) --
P:BB8D:b22_display_special:Display special values
P:BBB9:b22_display_time:Display time value
P:BBC1:b22_display_date:Display date value
P:BBD0:b22_display_coords:Display coordinates
P:BBFD:b22_display_name:Display name from $03DB

# -- Bank 22 Character Counter ($BC43-$BC6C) --
P:BC43:b22_count_chars:Count available characters
P:BC55:b22_count_loop:Character count loop
P:BC63:b22_count_done:Count complete

# -- Bank 22 Multi-Column ($BC6D-$BCC0) --
P:BC6D:b22_multi_col_init:Multi-column display init
P:BC81:b22_multi_col_loop:Multi-column loop
P:BCA1:b22_multi_col_row:Process multi-column row
P:BCC1:b22_multi_col_item:Display multi-column item

# -- Bank 22 Validation ($BEEC-$BF63) --
P:BEEC:b22_validate_slot:Validate character slot
P:BEF0:b22_validate_upper:Validate upper nibble
P:BEFA:b22_validate_lower:Validate lower nibble ($0F check)
P:BF02:b22_calc_validation:Calculate validation value
P:BF2D:b22_prep_validation:Prepare validation data
P:BF4C:b22_get_slot_bits:Get slot bit pattern
P:BF64:b22_set_slot_bits:Set slot bit pattern

# -- Bank 22 Final Check ($BF8E-$BFB5) --
P:BF8E:b22_final_check:Final validation check
P:BF9C:b22_check_fail:Check failed handler
P:BFA6:b22_brk_check:BRK-based check
P:BFB4:b22_clear_return:Clear and return

# -- Bank 22 RAM Variables --
G:03C8:b22_text_id:Current text ID
G:03C9:b22_text_flags:Text processing flags
G:03CA:b22_cursor_pos:Cursor position
G:03CC:b22_input_state:Input state
G:03CF:b22_menu_pos:Menu position
G:03D0:b22_max_value:Maximum value limit
G:03D1:b22_current_value:Current value
G:03D2:b22_selected_value:Selected value
G:03D3:b22_temp_value:Temporary value
G:03D5:b22_display_flags:Display flags
G:03D6:b22_column_count:Column count
G:03D7:b22_row_count:Row count
G:03DA:b22_scroll_pos:Scroll position
G:03DB:b22_name_index:Name buffer index
G:03DC:b22_menu_width:Menu width
G:03DD:b22_menu_height:Menu height
G:03E3:b22_name_buffer:Name buffer (8 bytes)
G:03FF:b22_buffer_index:Buffer index
G:0551:b22_dialog_state:Dialog state
G:0552:b22_dialog_pos:Dialog position
G:0553:b22_input_flag:Input flag (negative = wait)
G:0554:b22_output_buffer:Output buffer (8+ bytes)

# -- Bank 22 Zero Page Variables --
P:0052:b22_char_index:Character index
P:0053:b22_screen_x:Screen X position
P:0055:b22_active_flag:Active dialog flag
P:0056:b22_screen_y:Screen Y position
P:0057:b22_current_char:Current character code
P:0059:b22_scroll_amount:Scroll amount
P:005B:b22_script_index:Script read index
P:005C:b22_string_index:String index (multi-char)
P:005D:b22_command:Current command
P:0060:b22_special_flag:Special character flag ($78)
P:006F:b22_temp_calc:Temporary calculation
P:0072:b22_value_lo:Value low byte
P:0073:b22_value_mid:Value middle byte
P:0074:b22_value_hi:Value high byte
P:0075:b22_result:Result value
P:00EE:b22_text_ptr_lo:Text pointer low
P:00EF:b22_text_ptr_hi:Text pointer high
P:00F0:b22_text_start:Text start index
P:00F1:b22_text_end:Text end index
P:00F2:b22_text_offset:Text offset
P:00F3:b22_char_slot:Character slot
P:00F5:b22_condition_flags:Condition flags
P:00F7:b22_param1:Parameter 1
P:00F8:b22_param2:Parameter 2
P:00F9:b22_script_data:Script data array (6 bytes)

# ============================================================
# BANK 23 - CASINO/MINI-GAME SYSTEM
# PRG Address: $8000-$BFFF (Bank 23)
# PRG Offset: 0x5C000
# ============================================================

# -- Bank 23 Entry and Jump Table ($8000-$804B) --
P:8000:b23_entry_jump:Entry jump to main
P:8003:b23_ptr_table:Pointer/handler table
P:804C:b23_init_game:Initialize game mode

# -- Bank 23 Slot Machine Main ($8052-$80B0) --
P:8052:b23_slot_init:Initialize slot machine
P:8068:b23_slot_setup:Setup slot graphics
P:8078:b23_slot_render:Render slot display
P:8084:b23_slot_main_loop:Slot machine main loop
P:80B1:b23_check_win:Check for win condition

# -- Bank 23 Win Processing ($80C1-$8118) --
P:80C1:b23_process_win:Process winning combination
P:80CF:b23_update_counter:Update win counter ($62B0)
P:80E1:b23_calc_payout:Calculate payout amount
P:80F4:b23_show_payout:Show payout on screen
P:8107:b23_wait_display:Wait and display loop

# -- Bank 23 Input Loop ($8118-$8178) --
P:8118:b23_clear_display:Clear slot display
P:812E:b23_input_loop:Main input processing loop
P:8141:b23_check_buttons:Check button input
P:8150:b23_cursor_pos1:Move cursor to position 1
P:8162:b23_cursor_pos2:Move cursor to position 2
P:8174:b23_jump_payout:Jump to payout handler
P:8179:b23_process_bet:Process bet amount

# -- Bank 23 Display Helpers ($818F-$81D6) --
P:818F:b23_save_regs:Save registers to $FD-$FF
P:819F:b23_shift_regs:Shift registers for display
P:81B2:b23_load_display:Load display value
P:81C5:b23_payout_table:Payout multiplier table

# -- Bank 23 Spin Check ($81D7-$8236) --
P:81D7:b23_check_spin:Check if spinning
P:81DD:b23_set_spin_speed:Set spin speed ($2E-$30)
P:81F2:b23_is_spinning:Check spin state, return in carry

# -- Bank 23 Reel Animation ($8237-$8285) --
P:8237:b23_animate_reels:Animate spinning reels
P:8244:b23_stop_reel:Stop individual reel
P:8260:b23_reel_update:Update reel position
P:8286:b23_init_spin:Initialize spin sequence

# -- Bank 23 Symbol Drawing ($8654-$889) --
P:8654:b23_draw_symbols:Draw slot symbols
P:896E:b23_symbol_table:Symbol graphics table
P:89EE:b23_animate_win:Animate winning combination

# -- Bank 23 Coin Operations ($8A3F-$8BE6) --
P:8A3F:b23_coin_init:Initialize coin counter
P:8A6B:b23_add_coins:Add coins to total
P:8AAC:b23_update_coins:Update coin display
P:8BE7:b23_load_coins:Load coin values

# -- Bank 23 Display Update ($8BF4-$8C68) --
P:8BF4:b23_check_display:Check display state
P:8C04:b23_render_digits:Render digit display
P:8C24:b23_scroll_display:Scroll display area
P:8C39:b23_copy_digits:Copy digit values
P:8C45:b23_output_digits:Output digits to screen

# -- Bank 23 Panel Update ($8C69-$8C9C) --
P:8C69:b23_update_panel:Update info panel
P:8C83:b23_init_panel:Initialize panel display
P:8C9D:b23_refresh_panel:Refresh panel data

# -- Bank 23 Animation ($8CB7-$8D19) --
P:8CB7:b23_anim_panel:Animate panel elements
P:8CD0:b23_draw_panel:Draw panel frame
P:8CDD:b23_load_gfx1:Load graphics set 1
P:8CED:b23_load_gfx2:Load graphics set 2
P:8CFD:b23_load_gfx3:Load graphics set 3
P:8D0A:b23_setup_palette:Setup color palette

# -- Bank 23 Reel Control ($8D1A-$8D7E) --
P:8D1A:b23_stop_delay:Stop reel with delay
P:8D1F:b23_reel_handler:Main reel handler
P:8D25:b23_reel_animate:Reel animation step
P:8D3E:b23_position_table:Reel position table
P:8D43:b23_reel_init:Initialize reel state
P:8D58:b23_reel_col2:Reel column 2 handler
P:8D5D:b23_reel_col13:Reel column 1 and 3 handler
P:8D67:b23_reel_col04:Reel column 0 and 4 handler
P:8D6E:b23_copy_reel:Copy reel graphics

# -- Bank 23 Main Game Loop ($8D7F-$8DBB) --
P:8D7F:b23_game_loop:Casino game loop
P:8D8B:b23_frame_update:Frame update handler
P:8DA0:b23_check_input_game:Check input during game
P:8DA7:b23_handle_button:Handle button press

# -- Bank 23 Result Display ($8DC4-$8EA8) --
P:8DC4:b23_show_result:Show spin result
P:8DE5:b23_flash_win:Flash winning symbols
P:8E30:b23_clear_flash:Clear flash state
P:8E52:b23_increment_roll:Increment roll counter
P:8EA9:b23_final_display:Final result display

# -- Bank 23 Spin Control ($8ED6-$8F63) --
P:8ED6:b23_start_spin:Start reel spinning
P:8F37:b23_spin_check:Check spin status
P:8F42:b23_spin_update:Update spin state
P:8F5A:b23_init_spin_vars:Initialize spin variables
P:8F64:b23_random_offset:Generate random offset

# -- Bank 23 Probability ($8F9E-$90C3) --
P:8F9E:b23_calc_random:Calculate random result
P:8FC2:b23_weight_table:Probability weight table
P:9042:b23_symbol_weights:Symbol probability weights

# -- Bank 23 Graphics Data ($90C4-$9117) --
P:90C4:b23_gfx_data1:Graphics data set 1
P:90EE:b23_gfx_data2:Graphics data set 2
P:9118:b23_gfx_data3:Graphics data set 3

# -- Bank 23 Sound/VBlank ($91AF-$9241) --
P:91AF:b23_vblank_wait:Wait for VBlank
P:91E7:b23_play_sound:Play slot sound
P:9242:b23_nmi_handler:NMI/VBlank handler

# -- Bank 23 Display Setup ($92B4-$9313) --
P:92B4:b23_setup_screen:Setup screen mode
P:92C5:b23_clear_screen:Clear screen buffer
P:92F6:b23_load_palette:Load color palette
P:9314:b23_init_sprites:Initialize sprites

# -- Bank 23 Win Check ($9446-$9598) --
P:9446:b23_eval_win:Evaluate winning line
P:9520:b23_check_line:Check single line

# -- Bank 23 Monster Arena ($9BF9-$9C93) --
P:9BF9:b23_arena_init:Initialize monster arena
P:9C0D:b23_arena_setup:Setup arena display
P:9C35:b23_arena_main:Arena main loop
P:9C44:b23_arena_update:Arena frame update
P:9C5F:b23_arena_vars:Initialize arena variables
P:9C7E:b23_arena_flags:Set arena flags

# -- Bank 23 Betting ($9C94-$9CD7) --
P:9C94:b23_bet_menu:Betting menu
P:9CAB:b23_bet_init:Initialize bet
P:9CB5:b23_bet_input:Bet input loop
P:9CD1:b23_confirm_bet:Confirm bet amount
P:9CD8:b23_draw_bet:Draw bet display

# -- Bank 23 Monster Fight ($9CFE-$9DE5) --
P:9CFE:b23_fight_round:Process fight round
P:9D08:b23_calc_damage:Calculate damage
P:9D23:b23_check_ko:Check for knockout
P:9D41:b23_update_hp:Update HP display

# -- Bank 23 Fight Animation ($9DD0-$9EE5) --
P:9DD0:b23_fight_anim:Fight animation
P:9DE6:b23_show_damage:Show damage numbers
P:9E76:b23_monster_anim:Monster animation

# -- Bank 23 Arena Results ($9EE6-$9FE3) --
P:9EE6:b23_fight_result:Process fight result
P:9F32:b23_payout_arena:Calculate arena payout
P:9FE4:b23_end_fight:End fight sequence

# -- Bank 23 Arena Display ($9FFC-$A04F) --
P:9FFC:b23_draw_arena:Draw arena screen
P:A026:b23_draw_monsters:Draw monster sprites
P:A050:b23_update_arena:Update arena display

# -- Bank 23 Monster Stats ($A33C-$A599) --
P:A33C:b23_load_monster:Load monster data
P:A3A5:b23_calc_stats:Calculate monster stats
P:A57A:b23_monster_table:Monster stat table
P:A599:b23_monster_gfx:Monster graphics

# -- Bank 23 Arena Helpers ($A7FE-$A874) --
P:A7FE:b23_arena_helper1:Arena helper routine 1
P:A875:b23_arena_helper2:Arena helper routine 2

# -- Bank 23 Graphics/Tile Data ($AC55-$BFB5) --
P:AC55:b23_tile_data:Tile graphics data
P:B4C1:b23_palette_data:Palette data
P:B6F8:b23_sprite_data:Sprite graphics
P:BA44:b23_symbol_gfx:Slot symbol graphics
P:BEFA:b23_bg_data:Background tile data

# -- Bank 23 RAM Variables --
G:0029:b23_reel_pos:Reel position array (6)
G:002F:b23_reel_speed:Reel speed array (6)
G:0034:b23_display_flags:Display update flags
G:0036:b23_spin_value_lo:Spin value low
G:0037:b23_spin_value_mid:Spin value middle
G:0038:b23_spin_value_hi:Spin value high
G:0044:b23_random_seed:Random number seed
G:005A:b23_menu_select:Menu selection
G:0060:b23_arena_mode:Arena mode flag
G:0081:b23_spin_state:Spin state (0-3)
G:0082:b23_bet_amount:Current bet amount
G:008A:b23_timer:Animation timer
G:04B0:b23_sprite_buffer:Sprite buffer
G:04E0:b23_palette_buffer:Palette buffer
G:04F2:b23_screen_offset:Screen offset
G:04FF:b23_rng_state:RNG state
G:0505:b23_game_flags:Game state flags
G:0508:b23_coin_lo:Coin count low
G:0509:b23_coin_hi:Coin count high
G:62B0:b23_win_counter:Win counter array (8)

# ============================================================
# BANK 24 - MAP RENDERING AND METATILE SYSTEM
# PRG Address: $8000-$BFFF (Bank 24)
# PRG Offset: 0x60000
# ============================================================

# -- Bank 24 Metatile Data ($8000-$A4BF) --
P:8000:b24_metatile_data:Metatile definition table
P:8047:b24_metatile_flags:Metatile flag bytes
P:80C0:b24_tile_patterns:Tile pattern data

# -- Bank 24 Map Position Calculation ($AFE6-$B025) --
P:AFE6:b24_calc_map_pos:Calculate map position
P:AFEA:b24_load_offsets:Load X/Y offsets from $E7-$E9
P:B004:b24_add_y_offset:Add Y offset to position
P:B010:b24_calc_nametable:Calculate nametable address
P:B023:b24_jump_store:Jump to store result

# -- Bank 24 Extended Map Calc ($B026-$B0B4) --
P:B026:b24_extended_calc:Extended map calculation
P:B04F:b24_store_x_pos:Store X position
P:B06F:b24_add_y_extended:Add Y with extended check
P:B080:b24_store_y_pos:Store Y position
P:B0A0:b24_final_calc:Final position calculation
P:B0B5:b24_call_store:Call store routine

# -- Bank 24 Map Split Handler ($B0BD-$B0E4) --
P:B0BD:b24_split_check:Check for nametable split
P:B0D2:b24_split_y:Handle Y split case
P:B0DE:b24_split_finish:Finish split handling

# -- Bank 24 Map Store ($B0E5-$B11F) --
P:B0E5:b24_store_single:Store single tile update
P:B0FA:b24_store_multi:Store multi-tile update
P:B10E:b24_store_loop:Store data loop
P:B116:b24_increment_index:Increment buffer index ($050A)

# -- Bank 24 Screen Init ($B120-$B148) --
P:B120:b24_init_screen:Initialize screen position
P:B126:b24_call_c662:Call C662 helper
P:B12B:b24_calc_scroll:Calculate scroll offsets
P:B140:b24_store_scroll:Store scroll values

# -- Bank 24 Tile Lookup ($B149-$B1A4) --
P:B149:b24_tile_lookup:Look up tile at position
P:B15C:b24_check_y_bounds:Check Y boundary (0B-12)
P:B166:b24_calc_tile_idx:Calculate tile table index
P:B184:b24_read_tile:Read tile from table ($B20A)
P:B192:b24_tile_not_found:Tile not found handler
P:B197:b24_check_overflow:Check for buffer overflow

# -- Bank 24 Screen Update Loop ($B1A5-$B209) --
P:B1A5:b24_update_screen:Update full screen
P:B1AD:b24_update_loop_y:Y update loop
P:B1AF:b24_update_loop_x:X update loop
P:B1B8:b24_call_lookup:Call tile lookup
P:B1C0:b24_next_y:Next Y position

# -- Bank 24 Tile Table ($B20A) --
P:B20A:b24_tile_table:Tile type lookup table

# -- Bank 24 RAM Variables --
G:00DA:b24_row_count:Row count for update
G:00DB:b24_col_count:Column count for update
G:00E7:b24_scroll_x:Scroll X position
G:00E8:b24_scroll_y:Scroll Y position
G:00E9:b24_nametable:Current nametable flags
G:0300:b24_update_buffer:PPU update buffer
G:050A:b24_buffer_index:Update buffer index
G:050B:b24_update_count:Update count

# ==============================================================================
# BANK 30 ($8000-$BFFF) - NPC/OVERWORLD MOVEMENT SYSTEM
# ==============================================================================
# This bank handles all overworld NPC movement, party position management,
# collision detection, and map transitions. Key RAM arrays:
# - $6F60-$6F7F: NPC/Party X positions (slots 0-31)
# - $6F80-$6F9F: NPC/Party Y positions (slots 0-31)
# - $6FA0-$6FBF: Previous X positions (for movement trail)
# - $6FC0-$6FDF: Previous Y positions (for movement trail)
# - $6FE0-$6FFF: Movement target/timer arrays
# - $7000-$701F: NPC direction/facing flags (bits 0-1=dir, bit 6=moving)
# - $7020-$703F: NPC visibility/ID flags (bit 7=hidden)
# - $7040-$705F: NPC type/behavior flags
# - $70E0-$70FF: NPC state flags (bit 7=special state)
# - $7140-$7143: Current tile data for collision

# -- Bank 30 Entry Points ($8000-$80BD) --
P:8000:b30_rst_handler:Bank 30 reset/entry point
P:8094:b30_brk_entry:BRK $FB handler - NPC dispatcher
P:809A:b30_jump_dispatch:Jump table dispatcher (ASL/TAX pattern)
P:80AA:b30_jump_table:Jump table for NPC operations
P:80BE:b30_npc_collision:NPC tile collision check entry

# -- Bank 30 NPC Collision Check ($80BE-$8100) --
P:80C5:b30_check_tile_type:Check tile type at NPC position
P:80D2:b30_tile_passable:Test if tile is passable
P:80E8:b30_collision_result:Return collision result
P:80F9:b30_passable_exit:Exit - tile is passable

# -- Bank 30 NPC Direction Update ($8101-$8125) --
P:8101:b30_update_direction:Update NPC direction flags
P:8108:b30_set_facing:Set NPC facing direction in $7000,X
P:8115:b30_clear_motion:Clear motion flags
P:8121:b30_direction_done:Direction update complete

# -- Bank 30 NPC Slot Search ($8126-$8145) --
P:8126:b30_find_npc_slot:Find empty NPC slot in $7020
P:812E:b30_slot_search_loop:Loop through slots $06-$20
P:813B:b30_slot_found:Empty slot found
P:8140:b30_no_slot:No empty slot available
P:8145:b30_slot_return:Return from slot search

# -- Bank 30 Map Special Handler ($8146-$81AD) --
P:8146:b30_map_special:Handle special map locations
P:814F:b30_check_location:Check against location table
P:8160:b30_special_match:Location matched - execute handler
P:8170:b30_no_match:No special location found
P:819E:b30_location_table:Map location lookup table

# -- Bank 30 Player Position ($81AE-$81CC) --
P:81AE:b30_get_player_pos:Get player position from $6F60/$6F80
P:81B5:b30_apply_direction:Apply direction offset
P:81C2:b30_store_pos:Store position to $51/$52
P:81CC:b30_pos_return:Return from position routine

# -- Bank 30 Sprite Y Adjust ($892A-$8949) --
P:892A:b30_sprite_y_loop:Adjust sprite Y in OAM buffer
P:8940:b30_store_sprite_y:Store adjusted Y
P:8943:b30_next_sprite:Process next sprite (X+4)

# -- Bank 30 Map Transition Table ($894A-$89C4) --
P:894A:b30_find_transition:Find map transition entry
P:894C:b30_trans_search:Search transition table
P:895D:b30_trans_infinite:Error - infinite loop trap
P:8960:b30_trans_found:Transition entry found
P:896A:b30_load_trans_data:Load transition data
P:8986:b30_check_transition:Check transition at coords
P:89BA:b30_apply_transition:Apply transition direction
P:89C4:b30_trans_return:Return from transition

# -- Bank 30 Scroll Update ($8A0D-$8A67) --
P:8A0D:b30_scroll_update:Update scroll position
P:8A23:b30_scroll_done:Scroll update complete
P:8A47:b30_scroll_special:Special scroll handling
P:8A68:b30_calc_scroll:Calculate scroll parameters

# -- Bank 30 Tile Write ($8A9A-$8ABB) --
P:8A9A:b30_tile_write_loop:Write tiles to map buffer
P:8AA4:b30_apply_tile:Apply tile to buffer
P:8ABB:b30_write_done:Tile write complete

# -- Bank 30 Sprite Fade ($8ABC-$8AFA) --
P:8ABC:b30_sprite_fade:Fade sprites out/in
P:8ACB:b30_fade_loop:Fade animation loop
P:8ACD:b30_process_sprite:Process sprite visibility
P:8AE6:b30_next_fade_spr:Next sprite for fade
P:8AFB:b30_adjust_sprite:Adjust sprite Y for fade

# -- Bank 30 Party Position Init ($9320-$9421) --
P:9320:b30_init_party_pos:Initialize party positions
P:9322:b30_set_hero_x:Set hero X at $6F60
P:9327:b30_set_hero_y:Set hero Y at $6F80
P:932A:b30_set_party_1:Set party member 1 position
P:9336:b30_set_party_y:Set party Y positions
P:9367:b30_clear_npc_flags:Clear NPC flags $7046-$7051
P:9396:b30_chapter_3_setup:Chapter 3 party setup
P:93CF:b30_count_party:Count active party members
P:93E9:b30_setup_wagon:Setup wagon positions
P:9421:b30_party_init_done:Party init complete

# -- Bank 30 Movement Calculation ($9EC0-$9F40) --
P:9EC0:b30_calc_movement:Calculate movement delta
P:9EE1:b30_move_check_fail:Movement check failed
P:9F0C:b30_calc_offset:Calculate position offset
P:9F21:b30_apply_offset:Apply offset to position
P:9F40:b30_read_tile_pos:Read tile at position

# -- Bank 30 NPC Slot Management ($9F47-$A0A6) --
P:9F47:b30_npc_slot_init:Initialize NPC slot data
P:9F54:b30_scan_npc_slots:Scan NPC slots for type
P:9F56:b30_slot_scan_loop:Loop through $6F20 array
P:9F6F:b30_slot_scan_done:Slot scan complete
P:9FA6:b30_check_slot_type:Check NPC type in slot
P:A02B:b30_slot_mgmt_end:End slot management
P:A046:b30_clear_npc_array:Clear $6E5E NPC array
P:A0A6:b30_array_clear_done:Array clear complete

# -- Bank 30 Movement Validation ($A0B1-$A155) --
P:A0B1:b30_validate_move:Validate movement for NPC
P:A0B3:b30_validate_loop:Validation loop
P:A0B8:b30_check_npc_tile:Check NPC tile at $6F40,X
P:A0D6:b30_validate_done:Movement validation complete

# -- Bank 30 Party Shuffle ($AB6B-$AC1A) --
P:AB6B:b30_copy_positions:Copy positions to previous arrays
P:AB6D:b30_copy_loop:Copy $6F60->$6FA0, $6F80->$6FC0
P:AB7E:b30_setup_party_vis:Setup party visibility flags
P:AB90:b30_check_wagon_add:Check if adding wagon member
P:ABB2:b30_shift_party:Shift party slots down
P:ABE9:b30_clear_front:Clear front party slots
P:ABFE:b30_shuffle_return:Return from shuffle
P:AC04:b30_hide_wagon:Hide wagon party members
P:AC12:b30_hide_last_two:Hide last two party slots

# -- Bank 30 Tile Position Lookup ($ACD9-$AD50) --
P:ACD9:b30_get_tile_at:Get tile at party position
P:ACE7:b30_tile_lookup_jmp:Jump to tile lookup
P:ACEA:b30_update_party_dir:Update all party direction flags
P:AD07:b30_follow_leader:Make party follow leader position
P:AD21:b30_next_follower:Process next follower

# -- Bank 30 Event Handler ($B447-$B4D2) --
P:B447:b30_event_handler:Handle map/NPC events
P:B44A:b30_event_check:Check for event trigger
P:B462:b30_event_dispatch:Dispatch to event handler
P:B476:b30_event_jmp_ind:Indirect jump to event routine
P:B47F:b30_event_default:Default event handler
P:B4B6:b30_event_no_match:No matching event
P:B4D3:b30_event_return:Return from event

# -- Bank 30 Dungeon Check ($B4DB-$B5A2) --
P:B4DB:b30_dungeon_check:Check if in dungeon mode
P:B4E1:b30_dungeon_table:Search dungeon table
P:B4F4:b30_compare_map:Compare map number
P:B519:b30_not_dungeon:Not in dungeon mode
P:B52F:b30_dungeon_event:Handle dungeon-specific event
P:B559:b30_dungeon_flags:Handle dungeon flags

# -- Bank 30 NPC Talk Handler ($B5A3-$B5C2) --
P:B5A3:b30_npc_talk:Handle talking to NPC
P:B5A5:b30_set_npc_id:Set current NPC ID at $627A
P:B5B2:b30_talk_dispatch:Dispatch to talk handler

# -- Bank 30 Lookup Tables --
P:BC34:b30_event_table_size:Event dispatch table size
P:BC35:b30_event_id_table:Event ID lookup table
P:BC3D:b30_event_ptr_table:Event handler pointer table
P:BC55:b30_dungeon_tbl_size:Dungeon table size
P:BC56:b30_dungeon_id_table:Dungeon ID lookup table
P:BC62:b30_dungeon_ptr_table:Dungeon handler pointer table
P:BDAB:b30_direction_masks:Direction bitmask table
P:BDB3:b30_direction_offsets:Direction offset table
P:BF59:b30_location_lookup:Location lookup data table

# -- Bank 30 RAM Variables --
G:0051:b30_pos_x:Current X position
G:0052:b30_pos_y:Current Y position
G:0053:b30_tile_type:Current tile type
G:0057:b30_sprite_base:Sprite base tile
G:003D:b30_direction:Current direction (0-3)
G:003F:b30_map_width:Map width
G:0040:b30_map_height:Map height
G:0041:b30_mode_flags:Mode flags (bit 7=special mode)
G:0042:b30_dest_x:Destination X
G:0043:b30_dest_y:Destination Y
G:0044:b30_sub_x:Sub-tile X
G:0045:b30_sub_y:Sub-tile Y
G:0046:b30_tile_bank:Tile data bank
G:0047:b30_tile_page:Tile page
G:0049:b30_ptr_lo:Pointer low byte
G:004A:b30_ptr_hi:Pointer high byte
G:07B9:b30_npc_index:Current NPC index temp
G:6E5E:b30_npc_vis_array:NPC visibility array (32 bytes)
G:6F20:b30_npc_type_array:NPC type array (32 bytes)
G:6F40:b30_npc_tile_array:NPC tile type array (32 bytes)
G:6F60:b30_party_x_array:Party/NPC X positions (32 bytes)
G:6F80:b30_party_y_array:Party/NPC Y positions (32 bytes)
G:6FA0:b30_prev_x_array:Previous X positions (32 bytes)
G:6FC0:b30_prev_y_array:Previous Y positions (32 bytes)
G:6FE0:b30_move_target:Movement target array (32 bytes)
G:7000:b30_direction_array:Direction/facing flags (32 bytes)
G:7020:b30_visibility_array:NPC visibility/ID array (32 bytes)
G:7040:b30_behavior_array:NPC behavior flags (32 bytes)
G:70E0:b30_state_array:NPC state flags (32 bytes)
G:7140:b30_tile_buffer:Current tile collision buffer (4 bytes)
G:6195:b30_saved_x:Saved X position
G:6196:b30_saved_y:Saved Y position
G:6197:b30_saved_subx:Saved sub-X position
G:6198:b30_saved_suby:Saved sub-Y position
G:618E:b30_map_flags:Map feature flags
G:627A:b30_npc_talk_id:Current NPC talk ID
G:6279:b30_talk_flags:NPC talk flags
G:6281:b30_event_flags_1:Event flags 1
G:6283:b30_event_flags_2:Event flags 2
G:628E:b30_chapter_flags:Chapter-specific flags
G:6272:b30_progress_flags:Progress/story flags

# ==============================================================================
# BANK 15 ($8000-$BFFF) - SYSTEM INIT / HARDWARE / NPC AI
# ==============================================================================
# This bank handles system initialization, PPU/mapper control,
# NMI/VBlank synchronization, and NPC AI/movement routines.

# -- Bank 15 Jump Table ($8000-$803C) --
P:8000:b15_jump_table:Bank 15 jump table entry
P:8001:b15_jmp_e9ce:Jump to $E9CE
P:8004:b15_jmp_e54b:Jump to $E54B
P:8007:b15_jmp_f1ab:Jump to $F1AB
P:800A:b15_jmp_efdb:Jump to $EFDB
P:800D:b15_jmp_efd7:Jump to $EFD7
P:8010:b15_jmp_f1fa:Jump to $F1FA
P:8013:b15_jmp_f223:Jump to $F223
P:8016:b15_jmp_e944:Jump to $E944
P:802E:b15_jmp_f4ab:Jump to $F4AB
P:8031:b15_jmp_f58a:Jump to $F58A
P:8034:b15_jmp_f58b:Jump to $F58B
P:8037:b15_jmp_fabe:Jump to $FABE

# -- Bank 15 System Init ($803D-$80D1) --
P:803D:b15_system_init:System initialization entry
P:803E:b15_wait_vbl_1:Wait for VBlank (first)
P:8043:b15_wait_vbl_2:Wait for VBlank (second)
P:804E:b15_init_ppu:Initialize PPU registers
P:8058:b15_init_mmc1:Initialize MMC1 mapper
P:8067:b15_init_nmi_jmp:Setup NMI JMP opcode ($4C)
P:806C:b15_init_nmi_vec:Setup NMI target from $C0D2
P:8078:b15_init_stack:Initialize stack pointer
P:807E:b15_clear_ram:Clear RAM loop
P:8092:b15_init_shadow:Initialize PPU shadows
P:809E:b15_call_c104:Call $C104 helper
P:80A4:b15_init_ppu_addr:Setup PPU address $1000
P:80B0:b15_clear_ppu:Clear PPU data loop
P:80B6:b15_enable_nmi:Enable NMI
P:80BE:b15_init_calls:Initialization subroutine calls
P:80CF:b15_jmp_c968:Jump to main loop at $C968

# -- Bank 15 VBlank Routines ($80D2-$80E8) --
P:80D2:b15_vblank_data:VBlank handler data
P:80D6:b15_vblank_sync:VBlank synchronization
P:80D9:b15_wait_vbl_neg:Wait for VBlank flag negative
P:80DE:b15_wait_vbl_pos:Wait for VBlank flag positive
P:80E3:b15_wait_vbl_neg2:Second wait negative
P:80E8:b15_vblank_return:Return from VBlank sync

# -- Bank 15 MMC1 Control ($8118-$8159) --
P:8118:b15_write_chr0:Write CHR Bank 0 ($9FFF)
P:812F:b15_write_chr1:Write CHR Bank 1 ($BFFF)
P:8146:b15_write_prg:Write PRG Bank ($DFFF)

# -- Bank 15 NMI Handler ($815A-$8218) --
P:815A:b15_nmi_entry:NMI handler entry (push regs)
P:815F:b15_check_busy:Check if system busy
P:8163:b15_check_caller:Check caller return address
P:8175:b15_do_vblank_update:Perform VBlank PPU update
P:8181:b15_nmi_check_addr:Check address range
P:819B:b15_nmi_process:Process NMI
P:81A0:b15_increment_timer:Increment system timer ($C221)
P:81B0:b15_switch_bank:Switch to current bank
P:81BD:b15_check_addr_2:Check address range 2
P:81EF:b15_increment_frame:Increment frame counter ($050C)
P:81F2:b15_read_opcode:Read opcode at return address
P:8213:b15_nmi_exit_normal:Normal NMI exit (pop+RTI)
P:8219:b15_nmi_exit_brk:BRK handler NMI exit

# -- Bank 15 PPU Update ($8222-$8300) --
P:8222:b15_ppu_update_entry:PPU update entry point
P:8231:b15_ppu_update_mode:Select PPU update mode

# -- Bank 15 Direction Handling ($8DC9-$8E08) --
P:8DC9:b15_get_direction:Get NPC direction from $7001
P:8DD1:b15_set_timer:Set movement timer
P:8DDC:b15_check_mode:Check mode flags at $41
P:8DE5:b15_random_check:Random encounter check
P:8DF3:b15_increment_enc:Increment encounter counter ($62ED)
P:8E08:b15_direction_done:Direction handling done

# -- Bank 15 Movement Mode ($8E09-$8E9A) --
P:8E09:b15_check_movement:Check movement mode
P:8E0D:b15_dungeon_mode:Dungeon mode handler
P:8E50:b15_overworld_check:Overworld movement check
P:8E69:b15_special_check:Special movement check
P:8E80:b15_normal_movement:Normal movement handler
P:8E9A:b15_movement_finish:Finish movement processing

# -- Bank 15 Tile Check ($8EA9-$8EF7) --
P:8EA9:b15_read_input:Read controller input ($C000)
P:8EBE:b15_check_tile_type:Check tile type at $059E
P:8EC5:b15_tile_type_loop:Loop through tile types
P:8ED1:b15_tile_found:Tile type found
P:8EF3:b15_tile_special:Handle special tile

# -- Bank 15 NPC Position Routines ($9B50-$9BF2) --
P:9B50:b15_npc_random:Generate NPC random movement
P:9B56:b15_call_random:Call random number routine
P:9B61:b15_clear_flag:Clear movement flag
P:9B66:b15_return_masked:Return masked value
P:9B6A:b15_load_movement:Load movement parameters
P:9B82:b15_movement_done:Movement loading done
P:9B83:b15_npc_update:Update NPC position
P:9BA7:b15_npc_call_dde0:Call $DDE0 helper
P:9BAD:b15_npc_dest_check:Check NPC destination
P:9BC1:b15_store_dest:Store destination coords
P:9BD0:b15_set_npc_pos:Set NPC X/Y position
P:9BE5:b15_lookup_tile:Look up tile at position
P:9BF5:b15_store_npc_id:Store NPC ID at $059C

# -- Bank 15 NPC AI ($9C16-$9CDF) --
P:9C16:b15_npc_ai_or:AI OR flags routine
P:9C23:b15_npc_ai_and:AI AND flags routine
P:9C30:b15_npc_ai_store:AI store flags routine
P:9C3B:b15_load_ai_ptr:Load AI pointer from ($4D)
P:9C4B:b15_calc_direction:Calculate direction to target
P:9C59:b15_calc_hero_dist:Calculate distance to hero
P:9C9F:b15_calc_dest_dist:Calculate distance to destination
P:9CBF:b15_get_direction_bits:Get direction bits
P:9CCD:b15_find_direction:Find best direction
P:9CD3:b15_check_directions:Check all four directions

# -- Bank 15 Map Routines ($A8DD-$A943) --
P:A8DD:b15_store_indirect:Store A indirect at ($08),Y
P:A8E1:b15_save_position:Save position to $6E8A array
P:A8F8:b15_add_map_offset:Add map width to offset
P:A904:b15_sub_map_offset:Subtract map width from offset
P:A910:b15_write_tile_masked:Write tile with mask
P:A91E:b15_calc_tile_addr:Calculate tile address

# -- Bank 15 Map Bank Selection ($A944-$A9CD) --
P:A944:b15_select_map_bank:Select map data bank
P:A952:b15_load_map_header:Load map header data
P:A9AD:b15_get_map_bank:Get bank for current map

# -- Bank 15 Movement Update ($A9CE-$AA24) --
P:A9CE:b15_update_movement:Update movement state
P:A9E0:b15_check_tile:Check current tile
P:A9FA:b15_apply_movement:Apply movement delta
P:AA03:b15_apply_direction:Apply direction to position
P:AA1C:b15_toggle_scroll:Toggle scroll direction

# -- Bank 15 Graphics Data ($B600-$BF73) --
P:B600:b15_gfx_data:Graphics/CHR data region

# -- Bank 15 Wait VBlank ($BF74-$BF85) --
P:BF74:b15_wait_frame:Wait for next frame
P:BF77:b15_wait_loop:Wait loop (check $050C)
P:BF82:b15_call_c913:Call $C913 after wait
P:BF85:b15_wait_return:Return from wait

# -- Bank 15 Late Jump ($BF8E-$BF91) --
P:BF8E:b15_jmp_c03d:Jump to $C03D
P:BF91:b15_store_bank:Store bank to $0507

# ==============================================================================
# BANK 14 ($8000-$BFFF) - MAP/TILE DATA WITH SMALL CODE ROUTINES
# ==============================================================================
# Bank 14 is primarily map/metatile graphics data with small code routines
# for map tile setup and palette loading.

# -- Bank 14 Tile Setup ($8000-$8090) --
P:8000:b14_data_header:Data header/entry point
P:8008:b14_load_tile_ptr:Load tile pointer to $06/$07
P:800A:b14_call_baf7:Call $BAF7 for tile lookup
P:8010:b14_setup_tile:Setup tile data routine
P:8017:b14_call_setup:Call tile setup with map check
P:8026:b14_branch_0:Branch if map = 0
P:8029:b14_restore_06:Restore $06 and return
P:802D:b14_tile_setup_main:Main tile setup routine
P:8040:b14_store_fc:Store to $05FC
P:805C:b14_tile_loop:Tile processing loop
P:807A:b14_copy_tile_data:Copy 3 bytes of tile data
P:8090:b14_return:Return from tile setup

# -- Bank 14 Data Tables ($8091-$8097) --
P:8091:b14_ptr_table_lo:Pointer table low bytes
P:8095:b14_ptr_table_hi:Pointer table high bytes

# -- Bank 14 Late Routines ($BF00-$BF41) --
P:BF02:b14_late_routine:Late code routine
P:BF41:b14_helper:Helper routine called from $BF02

# ==============================================================================
# BANK 25 ($8000-$BFFF) - MUSIC/BGM SELECTION SYSTEM
# ==============================================================================
# Bank 25 handles background music selection based on chapter and location.
# Small code section at $8000-$810A, rest is music/event script data.
# Uses $615A (chapter), $63 (map number), $64 (submap) to select BGM.

# -- Bank 25 Jump Table ($8000-$8025) --
P:8000:b25_entry_table:Entry point jump table
P:8014:b25_jmp_c01c:JMP to $C01C (fixed bank routine)
P:8017:b25_jmp_c01f:JMP to $C01F (music set)
P:801A:b25_jmp_c022:JMP to $C022
P:801D:b25_jmp_c025:JMP to $C025
P:8020:b25_jmp_c028:JMP to $C028
P:8023:b25_jmp_c02b:JMP to $C02B

# -- Bank 25 Main BGM Selection ($8026-$803A) --
P:8026:b25_bgm_select_main:Main BGM selection routine
P:802D:b25_call_get_bgm:Call get_bgm_for_location ($803B)
P:8030:b25_call_set_music:Call $8017 to set music
P:803A:b25_bgm_return:Return from BGM selection

# -- Bank 25 Get BGM for Location ($803B-$810A) --
P:803B:b25_get_bgm_for_loc:Determine BGM based on state
P:803F:b25_check_0515:Check $0515 flag (special state)
P:8044:b25_check_chapter:Load chapter from $65
P:8048:b25_chapter_lookup:Lookup chapter-based BGM
P:8058:b25_chapter_check:Check chapter >= 4 (full party)
P:805F:b25_check_6292:Check flag at $6292 (Psaro state?)
P:807D:b25_pop_return:Stack cleanup and return
P:807F:b25_table_lookup:Direct table lookup for BGM
P:8083:b25_special_0515:Handle special $0515 case
P:808B:b25_negative_state:Handle negative state ($41 < 0)
P:8095:b25_search_loop_init:Initialize location search loop
P:8097:b25_search_map_loop:Search map/location table
P:809C:b25_compare_map:Compare with current map ($63)
P:80A1:b25_check_wildcard:Check for $FF wildcard (any submap)
P:80A5:b25_compare_submap:Compare with submap ($64)
P:80BD:b25_found_match:Found matching location
P:80C1:b25_check_chapter_4:Check if chapter 4+
P:80CE:b25_ch4_return:Return #$03 for chapter 4
P:80D1:b25_check_flag_62aa:Check flag $62AA for special case
P:80DA:b25_special_case_0:Handle special case X=0 (start area)
P:80E8:b25_special_case_0f:Handle special case X=$0F
P:80F9:b25_search_return:Return from search
P:80FA:b25_search_next:Advance to next table entry (3 bytes)
P:8101:b25_default_bgm:Default BGM from $07BA

# -- Bank 25 BGM Data Tables ($810B-$814D) --
P:810B:b25_chapter_bgm_tbl:BGM table by chapter
P:8116:b25_map_bgm_tbl:BGM table by map index
P:8124:b25_location_tbl:Map/submap/BGM triplet table

# -- Bank 25 Event Script Data ($814E-$BFFF) --
# Rest of bank is event script bytecode data, not 6502 code

# ==============================================================================
# DATA BANKS - GRAPHICS/PATTERN/MAP DATA (NOT EXECUTABLE CODE)
# ==============================================================================
# The following banks contain raw graphics data (CHR tiles), map/level data,
# or compressed data. They are NOT executable 6502 machine code.
#
# Bank 00: Graphics/Pattern Data - CHR tiles for PPU
# Bank 01: Graphics/Pattern Data - CHR tiles for PPU
# Bank 02: Graphics/Pattern Data - CHR tiles for PPU
# Bank 03: Graphics/Pattern Data - CHR tiles for PPU
# Bank 04: Graphics/Pattern Data - CHR tiles for PPU
# Bank 05: Graphics/Pattern Data - Map/level data, some with pointer tables
# Bank 06: Graphics/Pattern Data - CHR tiles (confirmed via analysis)
# Bank 07: Graphics/Pattern Data - CHR tiles (confirmed via analysis)
# Bank 09: Map/Level Data - Compressed map data
# Bank 10: Graphics/Pattern Data - CHR tiles
# Bank 11: Graphics/Pattern Data - CHR tiles
# Bank 12: Graphics/Pattern Data - CHR tiles
# Bank 13: Graphics/Pattern Data - CHR tiles (confirmed via analysis)
# Bank 26: Map/Event Script Data - Event bytecode data
#
# These banks are loaded into PPU pattern tables via CHR banking
# or processed by decompression routines, not executed directly.




